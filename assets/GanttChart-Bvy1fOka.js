import{R as H,r as h,a as W,f as O,t as V,j as e,d as L,g as P,b as G,e as Z,h as q,i as Q,k as z}from"./index-BaKXb-we.js";const J=H.memo(({machine:t,hour:c,minute:n,isUnavailable:l,hasScheduledTask:u})=>{const{setNodeRef:g}=G({id:`slot-${t.id}-${c}-${n}`,data:{machine:t,hour:c,minute:n,type:"slot",isUnavailable:l,hasScheduledTask:u}}),d=`time-slot${l?" unavailable":""}${u?" has-scheduled-task":""}`;return e.jsx("div",{ref:g,className:d,"data-hour":c,"data-minute":n,"data-machine-id":t.id})}),K=H.memo(({event:t,machine:c,currentDate:n})=>{const[l,u]=h.useState(!0),g=L(),{getSplitTaskInfo:d}=O(),{attributes:v,listeners:s,setNodeRef:m,transform:o,isDragging:a}=Z({id:`event-${t.id}`,data:{event:t,type:"event",machine:c},disabled:l}),r=h.useMemo(()=>{const f=d(t.id),x=q(n),y=Q(n);if(f&&f.wasSplit){const S=[];for(const D of f.segments){const p=new Date(D.start),N=new Date(D.end),M=z(p,n),T=z(N,n),k=p<y&&N>x;if(M||T||k){let w,C;if(M&&T){const b=p.getUTCHours(),$=p.getUTCMinutes(),_=N.getUTCHours(),A=N.getUTCMinutes(),E=b*4+Math.floor($/15),R=_*4+Math.ceil(A/15);w=E*20,C=(R-E)*20}else if(M){const b=p.getUTCHours(),$=p.getUTCMinutes(),_=b*4+Math.floor($/15);w=_*20,C=(96-_)*20}else if(T){const b=N.getUTCHours(),$=N.getUTCMinutes(),_=b*4+Math.ceil($/15);w=0,C=_*20}else w=0,C=1920;S.push({left:w,width:C,start:p,end:N})}}return S.length>0?S:null}else{const S=new Date(t.scheduled_start_time),D=t.time_remaining||t.duration||1,p=new Date(S.getTime()+D*60*60*1e3),N=z(S,n),M=z(p,n),T=S<y&&p>x;if(!N&&!M&&!T)return null;let k,w;if(N){const C=S.getUTCHours(),b=S.getUTCMinutes();k=(C*4+Math.floor(b/15))*20;const _=24-C;w=Math.min(D,_)*4*20}else if(M){k=0;const C=p.getUTCHours(),b=p.getUTCMinutes();w=(C*4+Math.ceil(b/15))*20}else k=0,w=1920;return[{left:k,width:w,start:S,end:p}]}},[t.scheduled_start_time,t.time_remaining,t.duration,n,d,t.id]),j=r?r.reduce((f,x)=>f+x.width,0):0,i=j<60,U=j<120,I=i&&j<80,B=j<40,F=h.useCallback(f=>{f.stopPropagation(),u(!l)},[l]);return!r||r.length===0?null:e.jsx(e.Fragment,{children:r.map((f,x)=>e.jsxs("div",{ref:x===0?m:void 0,style:{position:"absolute",left:`${f.left}px`,width:`${f.width}px`,transform:a&&x===0?`translate3d(${o?.x||0}px, ${o?.y||0}px, 0)`:"none",zIndex:a?1001:10,opacity:a?.8:1,transition:a?"none":"opacity 0.1s ease",pointerEvents:a?"none":"auto"},className:`scheduled-event ${a?"dragging":""} ${i?"very-small":""} ${U?"small":""} ${B?"extremely-narrow":""} ${r.length>1?"split-segment":""}`,...x===0?{...v,...s}:{},children:[e.jsx("div",{className:"event-content",style:{opacity:a?.7:1,transform:a?"scale(0.95)":"none"},children:e.jsxs("span",{className:"event-label",children:[t.odp_number,x===0&&(()=>{const y=d(t.id);return y&&y.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${y.totalSegments} segments`,children:"✂️"}):null})()]})}),!a&&x===0&&e.jsxs("div",{className:`event-controls ${I?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
Data Consegna: ${t.delivery_date?new Date(t.delivery_date).toLocaleDateString():"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
${t.scheduled_start_time?`Inizio Programmato: ${new Date(t.scheduled_start_time).toISOString().replace("T"," ").replace(".000Z","")}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${new Date(t.scheduled_end_time).toISOString().replace("T"," ").replace(".000Z","")}`:"Non programmato"}`,children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}),e.jsx("button",{className:"event-btn edit-btn",onClick:y=>{y.stopPropagation(),g(`/backlog/${t.id}/edit`)},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${l?"locked":"unlocked"}`,onClick:F,title:l?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:l?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!l&&e.jsx("div",{className:"drag-handle",...s,...v,title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!l&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:y=>{y.stopPropagation(),O.getState().unscheduleTask(t.id)},title:"Annulla programmazione e riporta al pool",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M19 13H5v-2h14v2z"})})})]})]},`${t.id}-segment-${x}`))})}),X=H.memo(({machine:t,scheduledEvents:c,currentDate:n,unavailableByMachine:l})=>{const u=h.useMemo(()=>c.filter(d=>d.scheduled_machine_id===t.id),[c,t.id]),g=l[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:96},(d,v)=>{const s=Math.floor(v/4),m=v%4*15,o=g?g.has(s.toString()):!1;return e.jsx(J,{machine:t,hour:s,minute:m,isUnavailable:o,hasScheduledTask:!1},`${t.id}-${s}-${m}`)}),u.length>0&&u.map(d=>e.jsx(K,{event:d,machine:t,currentDate:n},`event-${d.id}`))]})]})}),Y=H.memo(({machines:t,currentDate:c,scheduledTasks:n})=>{const l=L(),u=h.useMemo(()=>{const s=P(c),m=[];for(let o=0;o<7;o++){const a=new Date(s);a.setDate(s.getDate()+o),m.push(a)}return m},[c]),g=h.useCallback((s,m)=>n.filter(o=>o.scheduled_machine_id===s&&o.scheduled_start_time&&V(new Date(o.scheduled_start_time))===m),[n]),d=h.useCallback(s=>{l(`/backlog/${s.id}/edit`)},[l]),v=h.useCallback((s,m)=>g(s,m).length,[g]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),u.map(s=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:s.toLocaleDateString("en-US",{weekday:"short"})}),e.jsx("div",{className:"day-date",children:s.toLocaleDateString("en-US",{month:"short",day:"numeric"})})]},s.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(s=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:s.machine_name}),e.jsx("div",{className:"machine-city",children:s.work_center})]}),u.map(m=>{const o=V(m),a=g(s.id,o),r=v(s.id,o),j=m.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${j?"today":""} ${r>0?"has-tasks":""}`,children:a.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[r," task",r!==1?"s":""]}),a.slice(0,3).map(i=>e.jsxs("div",{className:"day-task-item",onClick:()=>d(i),title:`${i.odp_number} - ${i.product_name||"Prodotto non specificato"} - ${i.time_remaining?Number(i.time_remaining).toFixed(1):(i.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:i.odp_number}),e.jsxs("span",{className:"task-duration",children:[i.time_remaining?Number(i.time_remaining).toFixed(1):(i.duration||1).toFixed(1),"h"]})]},i.id)),a.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",a.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${s.id}-${o}`)})]},s.id))})]})}),te=H.memo(({machines:t,currentDate:c})=>{const[n,l]=h.useState("Daily"),{odpOrders:u}=W(),g=h.useMemo(()=>u.filter(a=>a.status==="SCHEDULED"),[u]),{loadMachineAvailabilityForDate:d,machineAvailability:v}=O(),s=h.useMemo(()=>V(c),[c]);h.useEffect(()=>(n==="Daily"&&d(s),()=>{}),[s,d,n]);const m=h.useMemo(()=>{if(n!=="Daily")return{};const a=v[s];if(!Array.isArray(a)||a.length===0)return{};const r={};for(let j=0;j<a.length;j++){const i=a[j];i.machine_id&&i.unavailable_hours&&(r[i.machine_id]=new Set(i.unavailable_hours.map(U=>U.toString())))}return r},[v,s,n]),o=h.useMemo(()=>Array.from({length:24},(a,r)=>e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${r*4+1} / span 4`},children:r.toString().padStart(2,"0")},r)),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:n,onChange:a=>l(a.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:n==="Daily"?e.jsxs("div",{className:"calendar-grid",children:[e.jsxs("div",{className:"calendar-header-row",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"time-header",children:o})]}),e.jsx("div",{className:"calendar-body",children:t.map(a=>e.jsx(X,{machine:a,scheduledEvents:g,currentDate:c,unavailableByMachine:m},a.id))})]}):e.jsx(Y,{machines:t,currentDate:c,scheduledTasks:g})})]})});export{te as default};
