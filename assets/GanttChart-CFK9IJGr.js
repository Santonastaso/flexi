import{n as oe,s as J,t as re,i as ne,r as g,h as k,c as te,j as e,R as B,b as le,k as ce,l as de,B as se,S as ue,m as me,o as he,p as ge,q as ae,u as ie,v as ee,w as pe,A as fe,a as ye,g as xe}from"./index-DEpIqjbk.js";function W(t,s,n){const[b,f]=oe(n?.in,t,s);return+J(b)==+J(f)}function ve(t,s){const n=re(t,s?.in);return n.setHours(23,59,59,999),n}function je(t,s,n){return ne(t,-1,n)}const be=({currentDate:t,onNavigateToNextDay:s,isDragOver:n})=>{const[b,f]=g.useState(!1),[o,h]=g.useState(null),u=ne(t,1),M=k(u,"yyyy-MM-dd"),{setNodeRef:r}=te({id:"next-day-drop-zone",data:{type:"next-day",targetDate:u,currentDate:t}});g.useEffect(()=>{if(n&&!o){const x=setTimeout(()=>{s(),h(null)},1600);h(x)}else!n&&o&&(clearTimeout(o),h(null));return()=>{o&&clearTimeout(o)}},[n,s,o]);const p=g.useCallback(()=>{f(!0)},[]),l=g.useCallback(()=>{f(!1)},[]),d=g.useCallback(()=>{o&&(clearTimeout(o),h(null)),s()},[s,o]),y=n||b||o;return e.jsxs("div",{ref:r,className:`next-day-drop-zone ${y?"active":""}`,onMouseEnter:p,onMouseLeave:l,onClick:d,title:`Trascina qui per andare al giorno successivo (${M})`,children:[e.jsx("div",{className:"next-day-content",children:e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})})}),e.jsx("div",{className:"next-day-bg-effect"}),y&&e.jsx("div",{className:"next-day-pulse"})]})},Me=({currentDate:t,onNavigateToPreviousDay:s,isDragOver:n})=>{const[b,f]=g.useState(!1),[o,h]=g.useState(null),u=je(t),M=k(u,"yyyy-MM-dd"),{setNodeRef:r}=te({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:u,currentDate:t}});g.useEffect(()=>{if(n&&!o){const x=setTimeout(()=>{s(),h(null)},1600);h(x)}else!n&&o&&(clearTimeout(o),h(null));return()=>{o&&clearTimeout(o)}},[n,s,o]);const p=g.useCallback(()=>{f(!0)},[]),l=g.useCallback(()=>{f(!1)},[]),d=g.useCallback(()=>{o&&(clearTimeout(o),h(null)),s()},[s,o]),y=n||b||o;return e.jsxs("div",{ref:r,className:`previous-day-drop-zone ${y?"active":""}`,onMouseEnter:p,onMouseLeave:l,onClick:d,title:`Trascina qui per andare al giorno precedente (${M})`,children:[e.jsx("div",{className:"previous-day-content",children:e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})})}),e.jsx("div",{className:"previous-day-bg-effect"}),y&&e.jsx("div",{className:"previous-day-pulse"})]})},Ne=B.memo(({machine:t,hour:s,minute:n,isUnavailable:b,hasScheduledTask:f,dropTargetId:o,slotId:h,dragPreview:u})=>{const{setNodeRef:M}=te({id:`slot-${t.id}-${s}-${n}`,data:{machine:t,hour:s,minute:n,type:"slot",isUnavailable:b,hasScheduledTask:f}}),r=`time-slot${b?" unavailable":""}${f?" has-scheduled-task":""}`,p=o===h,l=(s-6)*4+Math.floor(n/15),d=u?.isActive&&u.machineId===t.id&&l>=u.startSlot&&l<u.startSlot+u.durationSlots;return e.jsxs("div",{ref:M,className:r,"data-hour":s,"data-minute":n,"data-machine-id":t.id,style:{position:"relative"},children:[p&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}}),d&&e.jsx("div",{className:"drag-preview-indicator",style:{position:"absolute",top:"0px",left:"0px",right:"0px",bottom:"0px",background:"rgba(59, 130, 246, 0.3)",border:"2px solid #3b82f6",pointerEvents:"none",zIndex:999,borderRadius:"2px"}})]})}),_e=B.memo(({event:t,machine:s,currentDate:n,queryClient:b,readOnly:f=!1})=>{const o=ie(),{getSplitTaskInfo:h,splitTasksInfo:u}=ee(),{schedulingLoading:M}=ye(),{attributes:r,listeners:p,setNodeRef:l,transform:d,isDragging:y}=xe({id:`event-${t.id}`,data:{event:t,type:"event",machine:s},disabled:f}),x=g.useMemo(()=>{const m=h(t.id),N=J(n),i=ve(n),I=t.duration||1,R=t.progress||0,V=I*(R/100);if(!m||!m.segments){if(console.warn(`⚠️ No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const L=new Date(t.scheduled_start_time),T=t.time_remaining||t.duration||1,H=new Date(L.getTime()+T*60*60*1e3),j={start:L,end:H},E=W(j.start,n),z=W(j.end,n),Z=j.start<i&&j.end>N;if(!E&&!z&&!Z)return null;let w,C;if(E&&z){const S=j.start.getUTCHours(),D=j.start.getUTCMinutes(),A=j.end.getUTCHours(),_=j.end.getUTCMinutes(),K=Math.max(6,S),X=Math.min(22,A),U=(K-6)*4+Math.floor(D/15),Y=(X-6)*4+Math.ceil(_/15);w=U*15,C=(Y-U)*15}else if(E){const S=j.start.getUTCHours(),D=j.start.getUTCMinutes(),_=(Math.max(6,S)-6)*4+Math.floor(D/15);w=_*15,C=(64-_)*15}else if(z){const S=j.end.getUTCHours(),D=j.end.getUTCMinutes(),_=(Math.min(22,S)-6)*4+Math.ceil(D/15);w=0,C=_*15}else w=0,C=960;const O=R;return[{left:w,width:C,start:j.start,end:j.end,progress:O,duration:T}]}const G=[];let Q=0;for(const L of m.segments){const T=new Date(L.start),H=new Date(L.end),j=L.duration||0,E=W(T,n),z=W(H,n),Z=T<i&&H>N;if(E||z||Z){let w,C;if(E&&z){const S=T.getUTCHours(),D=T.getUTCMinutes(),A=H.getUTCHours(),_=H.getUTCMinutes(),K=Math.max(6,S),X=Math.min(22,A),U=(K-6)*4+Math.floor(D/15),Y=(X-6)*4+Math.ceil(_/15);w=U*15,C=(Y-U)*15}else if(E){const S=T.getUTCHours(),D=T.getUTCMinutes(),_=(Math.max(6,S)-6)*4+Math.floor(D/15);w=_*15,C=(64-_)*15}else if(z){const S=H.getUTCHours(),D=H.getUTCMinutes(),_=(Math.min(22,S)-6)*4+Math.ceil(D/15);w=0,C=_*15}else w=0,C=960;let O=0;V>Q&&(O=Math.min(j,V-Q)/j*100),G.push({left:w,width:C,start:T,end:H,progress:O,duration:j}),Q+=j}}return G.length>0?G:null},[t.id,n,h,u]),a=x?x.reduce((m,N)=>m+N.width,0):0,c=a<60,F=a<120,P=c&&a<80,q=a<40;if(!x||x.length===0)return null;const $=(m=>m>70?"#059669":m>=40&&m<=69?"#d97706":"#dc2626")(t.material_availability_global||0);return e.jsx(e.Fragment,{children:x.map((m,N)=>e.jsxs("div",{ref:N===0?l:void 0,style:{position:"absolute",left:`${m.left}px`,width:`${m.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto",background:$},className:`scheduled-event ${c?"very-small":""} ${F?"small":""} ${q?"extremely-narrow":""} ${x.length>1?"split-segment":""} ${M.taskId===t.id&&(M.isScheduling||M.isRescheduling||M.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,N===0&&(()=>{const i=h(t.id);return i&&i.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${i.totalSegments} segments`,children:"✂️"}):null})()]})}),m.progress&&m.progress>0&&e.jsx("div",{className:"progress-bar-overlay",style:{width:`${Math.min(m.progress,100)}%`}}),N===0&&!f&&e.jsxs("div",{className:`event-controls ${P?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:i=>{i.stopPropagation(),i.preventDefault()},onMouseDown:i=>{i.stopPropagation(),i.preventDefault()},onPointerDown:i=>{i.stopPropagation(),i.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?k(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
Altezza Busta: ${t.bag_height||"Non specificata"} mm
Passo Busta: ${t.bag_step||"Non specificato"} mm
Note Libere: ${t.user_notes||"Nessuna nota"}
Note ASD: ${t.asd_notes||"Nessuna nota"}
Material Global: ${t.material_availability_global||"N/A"}%
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:i=>{i.stopPropagation(),i.preventDefault(),o(`/backlog/${t.id}/edit`)},onMouseDown:i=>{i.stopPropagation(),i.preventDefault()},onPointerDown:i=>{i.stopPropagation(),i.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("div",{className:"drag-handle",...p,...r,style:{transform:y?`translate3d(${d?.x||0}px, ${d?.y||0}px, 0)`:"none",zIndex:y?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),e.jsx("button",{className:"event-btn unschedule-btn",onClick:async i=>{i.stopPropagation(),i.preventDefault();try{await ee.getState().unscheduleTask(t.id,b)}catch(I){console.error("Error unscheduling task:",I)}},onMouseDown:i=>{i.stopPropagation(),i.preventDefault()},onPointerDown:i=>{i.stopPropagation(),i.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${N}`))})}),Se=B.memo(({machine:t,scheduledEvents:s,currentDate:n,unavailableByMachine:b,dropTargetId:f,hideMachineLabel:o=!1,queryClient:h,dragPreview:u,readOnly:M=!1})=>{const r=g.useMemo(()=>s.filter(l=>l.scheduled_machine_id===t.id),[s,t.id]),p=b[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!o&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(l,d)=>{const y=Math.floor(d/4)+6,x=d%4*15,a=p?p.has(y.toString()):!1,c=`${t.id}-${y}-${x}`;return e.jsx(Ne,{machine:t,hour:y,minute:x,isUnavailable:a,hasScheduledTask:!1,dropTargetId:f,slotId:c,dragPreview:u},c)}),r.length>0&&r.map(l=>e.jsx(_e,{event:l,machine:t,currentDate:n,queryClient:h,readOnly:M},`event-${l.id}`))]})]})},(t,s)=>t.machine.id===s.machine.id&&t.machine.machine_name===s.machine.machine_name&&t.machine.work_center===s.machine.work_center&&t.scheduledEvents===s.scheduledEvents&&t.currentDate.getTime()===s.currentDate.getTime()&&t.unavailableByMachine===s.unavailableByMachine&&t.hideMachineLabel===s.hideMachineLabel&&t.queryClient===s.queryClient&&t.dragPreview===s.dragPreview&&t.readOnly===s.readOnly),we=B.memo(({machines:t,currentDate:s,scheduledTasks:n})=>{const b=ie(),{getSplitTaskInfo:f}=ee(),o=g.useMemo(()=>{const r=pe(s,{weekStartsOn:fe.APP.FIRST_DAY_OF_WEEK}),p=[];for(let l=0;l<7;l++){const d=new Date(r);d.setUTCDate(r.getUTCDate()+l),p.push(d)}return p},[s]),h=g.useCallback((r,p)=>n.filter(l=>{if(l.scheduled_machine_id!==r||!l.scheduled_start_time)return!1;const d=f(l.id);if(d&&d.segments&&d.segments.length>0){const y=new Date(p+"T00:00:00Z"),x=new Date(y.getTime()+1440*60*1e3);return d.segments.some(a=>{const c=new Date(a.start),F=new Date(a.end);return c<x&&F>y})}else return k(new Date(l.scheduled_start_time),"yyyy-MM-dd")===p}),[n,f]),u=g.useCallback(r=>{b(`/backlog/${r.id}/edit`)},[b]),M=g.useCallback((r,p)=>h(r,p).length,[h]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),o.map(r=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:k(r,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:k(r,"yyyy-MM-dd")})]},r.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(r=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:r.machine_name}),e.jsx("div",{className:"machine-city",children:r.work_center})]}),o.map(p=>{const l=k(p,"yyyy-MM-dd"),d=h(r.id,l).sort((a,c)=>new Date(a.scheduled_start_time)-new Date(c.scheduled_start_time)),y=M(r.id,l),x=p.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${x?"today":""} ${y>0?"has-tasks":""}`,children:d.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[y," task",y!==1?"s":""]}),d.slice(0,3).map(a=>e.jsxs("div",{className:"day-task-item",title:`${a.odp_number} - ${a.article_code||"Codice articolo FLEXI"} - ${a.time_remaining?Number(a.time_remaining).toFixed(1):(a.duration||1).toFixed(1)}h`,children:[e.jsxs("div",{className:"day-task-content",children:[e.jsx("span",{className:"task-odp",children:a.odp_number}),e.jsxs("span",{className:"task-duration",children:[a.time_remaining?Number(a.time_remaining).toFixed(1):(a.duration||1).toFixed(1),"h"]})]}),e.jsxs("div",{className:"day-task-controls",children:[e.jsx("button",{className:"event-btn info-btn",onClick:c=>{c.stopPropagation(),c.preventDefault()},onMouseDown:c=>{c.stopPropagation(),c.preventDefault()},onPointerDown:c=>{c.stopPropagation(),c.preventDefault()},title:`Codice Articolo: ${a.article_code||"Non specificato"}
Codice Articolo Esterno: ${a.external_article_code||"Non specificato"}
Nome Cliente: ${a.nome_cliente||"Non specificato"}
Data Consegna: ${a.delivery_date?k(new Date(a.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${a.quantity||"Non specificata"}
Altezza Busta: ${a.bag_height||"Non specificata"} mm
Passo Busta: ${a.bag_step||"Non specificato"} mm
Note Libere: ${a.user_notes||"Nessuna nota"}
Note ASD: ${a.asd_notes||"Nessuna nota"}
Material Global: ${a.material_availability_global||"N/A"}%

${a.scheduled_end_time?`Fine Programmata: ${a.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"10px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:c=>{c.stopPropagation(),c.preventDefault(),u(a)},onMouseDown:c=>{c.stopPropagation(),c.preventDefault()},onPointerDown:c=>{c.stopPropagation(),c.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"8",height:"8",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})})]})]},a.id)),d.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",d.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${r.id}-${l}`)})]},r.id))})]})}),De=B.memo(({machines:t,currentDate:s,dropTargetId:n,dragPreview:b,onNavigateToNextDay:f,onNavigateToPreviousDay:o,readOnly:h=!1})=>{const[u,M]=g.useState(()=>localStorage.getItem("schedulerView")||"Daily"),[r,p]=g.useState(null),{odpOrders:l}=le(),d=g.useMemo(()=>l.filter(v=>v.status==="SCHEDULED"),[l]),y=ce(),x=g.useMemo(()=>k(s,"yyyy-MM-dd"),[s]),{data:a=[],isLoading:c,error:F}=de(x),P=g.useMemo(()=>{if(u!=="Daily")return{};if(!Array.isArray(a)||a.length===0)return{};const v={};for(let $=0;$<a.length;$++){const m=a[$];m.machine_id&&m.unavailable_hours&&(v[m.machine_id]=new Set(m.unavailable_hours.map(N=>N.toString())))}return v},[a,u]),q=g.useMemo(()=>Array.from({length:16},(v,$)=>{const m=$+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${$*4+1} / span 4`},children:m.toString().padStart(2,"0")},m)}),[]);return g.useEffect(()=>{const v=()=>{const m=new Date,N=m.getHours(),i=m.getMinutes();if(N>=6&&N<22){const I=(N-6)*4+Math.floor(i/15),R=i%15/15,V=I*15+R*15;p(V)}else p(null)};v();const $=setInterval(v,6e4);return()=>clearInterval($)},[]),!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsx("div",{className:"calendar-section",children:e.jsxs("div",{className:"gantt-chart-wrapper",children:[e.jsxs("div",{className:"gantt-controls-bar",children:[e.jsxs("div",{className:"gantt-date-navigation",children:[e.jsx(se,{variant:"secondary",size:"sm",onClick:()=>o&&o(u),children:"<"}),e.jsx("span",{className:"current-date",children:k(s,"dd/MM/yyyy")}),e.jsx(se,{variant:"secondary",size:"sm",onClick:()=>f&&f(u),children:">"})]}),e.jsx("div",{className:"gantt-view-selector",children:e.jsxs(ue,{value:u,onValueChange:v=>{M(v),localStorage.setItem("schedulerView",v)},children:[e.jsx(me,{className:"view-selector",children:e.jsx(he,{})}),e.jsxs(ge,{children:[e.jsx(ae,{value:"Daily",children:"Vista Giornaliera"}),e.jsx(ae,{value:"Weekly",children:"Vista Settimanale"})]})]})})]}),e.jsx("div",{className:"gantt-scroll-container",children:e.jsx("div",{className:"calendar-grid-container",children:u==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header sticky-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(v=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:v.machine_name}),e.jsx("div",{className:"machine-city",children:v.work_center})]},v.id))})]}),!h&&e.jsx(Me,{currentDate:s,onNavigateToPreviousDay:()=>o&&o(u),isDragOver:n==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row sticky-header",children:q}),e.jsxs("div",{className:"time-grid-body",style:{position:"relative"},children:[t.map(v=>e.jsx(Se,{machine:v,scheduledEvents:d,currentDate:s,unavailableByMachine:P,dropTargetId:n,hideMachineLabel:!0,queryClient:y,dragPreview:b,readOnly:h},v.id)),r!==null&&e.jsx("div",{style:{position:"absolute",left:`${r}px`,top:0,bottom:0,width:"2px",backgroundColor:"#ef4444",zIndex:100,pointerEvents:"none"}})]})]}),!h&&e.jsx(be,{currentDate:s,onNavigateToNextDay:()=>f&&f(u),isDragOver:n==="next-day-drop-zone"})]}):e.jsx(we,{machines:t,currentDate:s,scheduledTasks:d})})})]})})});export{De as default};
