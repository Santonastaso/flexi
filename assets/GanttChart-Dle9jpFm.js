import{R as S,a as R,r as d,e as D,t as W,j as e,b as B,d as I,g as P,f as F,i as M}from"./index-DHiCbUnl.js";const q=S.memo(({machine:t,hour:o,minute:i,isUnavailable:n,hasScheduledTask:c})=>{const{setNodeRef:h}=B({id:`slot-${t.id}-${o}-${i}`,data:{machine:t,hour:o,minute:i,type:"slot",isUnavailable:n,hasScheduledTask:c}}),r=`time-slot${n?" unavailable":""}${c?" has-scheduled-task":""}`;return e.jsx("div",{ref:h,className:r,"data-hour":o,"data-minute":i,"data-machine-id":t.id})}),G=S.memo(({event:t,machine:o,currentDate:i})=>{const[n,c]=d.useState(!0),{attributes:h,listeners:r,setNodeRef:g,transform:m,isDragging:a}=I({id:`event-${t.id}`,data:{event:t,type:"event",machine:o},disabled:n}),s=d.useMemo(()=>{const l=new Date(t.scheduled_start_time),v=t.time_remaining||t.duration||1,x=new Date(l.getTime()+v*60*60*1e3),L=P(i),O=F(i),N=M(l,i),w=M(x,i),C=l<O&&x>L;if(!N&&!w&&!C)return null;let b,f;if(N){const y=l.getHours(),$=l.getMinutes();b=(y*4+Math.floor($/15))*20;const V=24-y;f=Math.min(v,V)*4*20}else if(w){b=0;const y=x.getHours(),$=x.getMinutes();f=(y*4+Math.ceil($/15))*20}else b=0,f=1920;return{baseLeft:b,baseWidth:f,eventSpansCurrentDay:C,eventStartsOnCurrentDay:N,eventEndsOnCurrentDay:w}},[t.scheduled_start_time,t.time_remaining,t.duration,i]),u=s?.baseWidth<60,p=s?.baseWidth<120,j=u&&s?.baseWidth<80,_=s?.baseWidth<40,k=d.useMemo(()=>{if(!s)return{};const{baseLeft:l,baseWidth:v}=s;return a?{position:"absolute",left:`${l}px`,width:`${v}px`,transform:`translate3d(${m?.x||0}px, ${m?.y||0}px, 0)`,zIndex:1001,pointerEvents:"none",willChange:"transform",backfaceVisibility:"hidden",transition:"none",boxShadow:"none",opacity:.8,filter:"none",borderRadius:"4px",padding:"4px 6px",minHeight:"32px"}:{position:"absolute",left:`${l}px`,width:`${v}px`,transform:"none",zIndex:10,willChange:"auto",backfaceVisibility:"visible",opacity:1,transition:"opacity 0.1s ease"}},[s,a,m,p,u,_]),z=d.useCallback(l=>{l.stopPropagation(),c(!n)},[n]);if(!s)return null;const{baseLeft:U,baseWidth:J,eventSpansCurrentDay:E,eventStartsOnCurrentDay:H,eventEndsOnCurrentDay:T}=s;return e.jsxs("div",{ref:g,style:k||{},className:`scheduled-event ${a?"dragging":""} ${E&&!H&&!T?"cross-day":""} ${u?"very-small":""} ${p?"small":""} ${_?"extremely-narrow":""}`,children:[e.jsx("div",{className:"event-content",style:{opacity:a?.7:1,transform:a?"scale(0.95)":"none"},children:e.jsx("span",{className:"event-label",children:t.odp_number})}),!a&&e.jsxs("div",{className:`event-controls ${j?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Data Consegna: ${t.delivery_date?new Date(t.delivery_date).toLocaleDateString():"Non impostata"}
QuantitÃ : ${t.quantity||"Non specificata"}
${t.scheduled_start_time?`Inizio Programmato: ${new Date(t.scheduled_start_time).toLocaleString()}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${new Date(t.scheduled_end_time).toLocaleString()}`:"Non programmato"}`,children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}),e.jsx("button",{className:`event-btn lock-btn ${n?"locked":"unlocked"}`,onClick:z,title:n?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:n?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!n&&e.jsx("div",{className:"drag-handle",...r,...h,title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!n&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:l=>{l.stopPropagation(),D.getState().unscheduleTask(t.id)},title:"Annulla programmazione e riporta al pool",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M19 13H5v-2h14v2z"})})})]})]})}),Q=S.memo(({machine:t,scheduledEvents:o,currentDate:i,unavailableByMachine:n})=>{const c=d.useMemo(()=>o.filter(r=>r.scheduled_machine_id===t.id),[o,t.id]),h=n[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:96},(r,g)=>{const m=Math.floor(g/4),a=g%4*15,s=h?h.has(m.toString()):!1;return e.jsx(q,{machine:t,hour:m,minute:a,isUnavailable:s,hasScheduledTask:!1},`${t.id}-${m}-${a}`)}),c.length>0&&c.map(r=>e.jsx(G,{event:r,machine:t,currentDate:i},`event-${r.id}`))]})]})}),Z=S.memo(({machines:t,currentDate:o})=>{const{odpOrders:i}=R(),n=d.useMemo(()=>i.filter(a=>a.status==="SCHEDULED"),[i]),{loadMachineAvailabilityForDate:c,machineAvailability:h}=D(),r=d.useMemo(()=>W(o),[o]);d.useEffect(()=>(c(r),()=>{}),[r,c]);const g=d.useMemo(()=>{const a=h[r];if(!Array.isArray(a)||a.length===0)return{};const s={};performance.now();for(let u=0;u<a.length;u++){const p=a[u];p.machine_id&&p.unavailable_hours&&(s[p.machine_id]=new Set(p.unavailable_hours.map(j=>j.toString())))}return performance.now(),s},[h,r]),m=d.useMemo(()=>Array.from({length:24},(a,s)=>e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${s*4+1} / span 4`},children:s.toString().padStart(2,"0")},s)),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"calendar-grid",children:[e.jsxs("div",{className:"calendar-header-row",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"time-header",children:m})]}),e.jsx("div",{className:"calendar-body",children:t.map(a=>e.jsx(Q,{machine:a,scheduledEvents:n,currentDate:o,unavailableByMachine:g},a.id))})]})})})});export{Z as default};
