import{R as U,r as g,a as Q,g as I,t as W,j as e,d as R,h as J,f as F,b as K,e as X,i as Y,k as Z,l as O,m as L}from"./index-Bfd-AVWL.js";const ee=U.memo(({machine:t,hour:d,minute:l,isUnavailable:n,hasScheduledTask:j,dropTargetId:p,slotId:x})=>{const{setNodeRef:h}=K({id:`slot-${t.id}-${d}-${l}`,data:{machine:t,hour:d,minute:l,type:"slot",isUnavailable:n,hasScheduledTask:j}}),s=`time-slot${n?" unavailable":""}${j?" has-scheduled-task":""}`,i=p===x;return e.jsx("div",{ref:h,className:s,"data-hour":d,"data-minute":l,"data-machine-id":t.id,style:{position:"relative"},children:i&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:0,left:0,right:0,bottom:0,border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),te=U.memo(({event:t,machine:d,currentDate:l})=>{const[n,j]=g.useState(!0),p=R(),{getSplitTaskInfo:x,splitTasksInfo:h}=I(),{attributes:s,listeners:i,setNodeRef:r,transform:u,isDragging:a}=X({id:`event-${t.id}`,data:{event:t,type:"event",machine:d},disabled:n}),m=g.useMemo(()=>{const f=x(t.id),y=Y(l),C=Z(l);if(console.log(`üîç Task ${t.odp_number} (${t.id}):`,{hasSegmentInfo:!!f,segmentCount:f?.segments?.length||0,wasSplit:f?.wasSplit||!1,description:t.description?.substring(0,100)+"..."}),!f||!f.segments){if(console.warn(`‚ö†Ô∏è No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const D=new Date(t.scheduled_start_time),$=t.time_remaining||t.duration||1,_=new Date(D.getTime()+$*60*60*1e3),c={start:D,end:_},k=O(c.start,l),H=O(c.end,l),T=c.start<C&&c.end>y;if(!k&&!H&&!T)return null;let N,b;if(k&&H){const S=c.start.getUTCHours(),v=c.start.getUTCMinutes(),w=c.end.getUTCHours(),E=c.end.getUTCMinutes(),V=S*4+Math.floor(v/15),q=w*4+Math.ceil(E/15);N=V*20,b=(q-V)*20}else if(k){const S=c.start.getUTCHours(),v=c.start.getUTCMinutes(),w=S*4+Math.floor(v/15);N=w*20,b=(96-w)*20}else if(H){const S=c.end.getUTCHours(),v=c.end.getUTCMinutes(),w=S*4+Math.ceil(v/15);N=0,b=w*20}else N=0,b=1920;return[{left:N,width:b,start:c.start,end:c.end}]}const z=[];for(const D of f.segments){const $=new Date(D.start),_=new Date(D.end),c=O($,l),k=O(_,l),H=$<C&&_>y;if(c||k||H){let T,N;if(c&&k){const b=$.getUTCHours(),S=$.getUTCMinutes(),v=_.getUTCHours(),w=_.getUTCMinutes(),E=b*4+Math.floor(S/15),V=v*4+Math.ceil(w/15);T=E*20,N=(V-E)*20}else if(c){const b=$.getUTCHours(),S=$.getUTCMinutes(),v=b*4+Math.floor(S/15);T=v*20,N=(96-v)*20}else if(k){const b=_.getUTCHours(),S=_.getUTCMinutes(),v=b*4+Math.ceil(S/15);T=0,N=v*20}else T=0,N=1920;z.push({left:T,width:N,start:$,end:_})}}return console.log(`‚úÖ Task ${t.odp_number}: ${z.length} visible segments`),z.length>0?z:null},[t.id,l,x,h]),o=m?m.reduce((f,y)=>f+y.width,0):0,M=o<60,A=o<120,B=M&&o<80,P=o<40,G=g.useCallback(f=>{f.stopPropagation(),j(!n)},[n]);return!m||m.length===0?null:e.jsx(e.Fragment,{children:m.map((f,y)=>e.jsxs("div",{ref:y===0?r:void 0,style:{position:"absolute",left:`${f.left}px`,width:`${f.width}px`,transform:a&&y===0?`translate3d(${u?.x||0}px, ${u?.y||0}px, 0)`:"none",zIndex:a?1001:10,opacity:a?.8:1,transition:a?"none":"opacity 0.1s ease",pointerEvents:a?"none":"auto"},className:`scheduled-event ${a?"dragging":""} ${M?"very-small":""} ${A?"small":""} ${P?"extremely-narrow":""} ${m.length>1?"split-segment":""}`,...y===0?{...s,...i}:{},children:[e.jsx("div",{className:"event-content",style:{opacity:a?.7:1,transform:a?"scale(0.95)":"none"},children:e.jsxs("span",{className:"event-label",children:[t.odp_number,y===0&&(()=>{const C=x(t.id);return C&&C.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${C.totalSegments} segments`,children:"‚úÇÔ∏è"}):null})()]})}),!a&&y===0&&e.jsxs("div",{className:`event-controls ${B?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
Data Consegna: ${F(t.delivery_date)||"Non impostata"}
Quantit√†: ${t.quantity||"Non specificata"}
${t.scheduled_start_time?`Inizio Programmato: ${L(t.scheduled_start_time)}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${L(t.scheduled_end_time)}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:C=>{C.stopPropagation(),p(`/backlog/${t.id}/edit`)},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${n?"locked":"unlocked"}`,onClick:G,title:n?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:n?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!n&&e.jsx("div",{className:"drag-handle",...i,...s,title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!n&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:C=>{C.stopPropagation(),I.getState().unscheduleTask(t.id)},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"√ó"})})]})]},`${t.id}-segment-${y}`))})}),se=U.memo(({machine:t,scheduledEvents:d,currentDate:l,unavailableByMachine:n,dropTargetId:j})=>{const p=g.useMemo(()=>d.filter(h=>h.scheduled_machine_id===t.id),[d,t.id]),x=n[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:96},(h,s)=>{const i=Math.floor(s/4),r=s%4*15,u=x?x.has(i.toString()):!1,a=`${t.id}-${i}-${r}`;return e.jsx(ee,{machine:t,hour:i,minute:r,isUnavailable:u,hasScheduledTask:!1,dropTargetId:j,slotId:a},a)}),p.length>0&&p.map(h=>e.jsx(te,{event:h,machine:t,currentDate:l},`event-${h.id}`))]})]})}),ae=U.memo(({machines:t,currentDate:d,scheduledTasks:l})=>{const n=R(),j=g.useMemo(()=>{const s=J(d),i=[];for(let r=0;r<7;r++){const u=new Date(s);u.setDate(s.getDate()+r),i.push(u)}return i},[d]),p=g.useCallback((s,i)=>l.filter(r=>r.scheduled_machine_id===s&&r.scheduled_start_time&&W(new Date(r.scheduled_start_time))===i),[l]),x=g.useCallback(s=>{n(`/backlog/${s.id}/edit`)},[n]),h=g.useCallback((s,i)=>p(s,i).length,[p]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),j.map(s=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:F(s)}),e.jsx("div",{className:"day-date",children:F(s)})]},s.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(s=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:s.machine_name}),e.jsx("div",{className:"machine-city",children:s.work_center})]}),j.map(i=>{const r=W(i),u=p(s.id,r),a=h(s.id,r),m=i.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${m?"today":""} ${a>0?"has-tasks":""}`,children:u.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[a," task",a!==1?"s":""]}),u.slice(0,3).map(o=>e.jsxs("div",{className:"day-task-item",onClick:()=>x(o),title:`${o.odp_number} - ${o.product_name||"Prodotto non specificato"} - ${o.time_remaining?Number(o.time_remaining).toFixed(1):(o.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:o.odp_number}),e.jsxs("span",{className:"task-duration",children:[o.time_remaining?Number(o.time_remaining).toFixed(1):(o.duration||1).toFixed(1),"h"]})]},o.id)),u.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",u.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${s.id}-${r}`)})]},s.id))})]})}),ie=U.memo(({machines:t,currentDate:d,dropTargetId:l})=>{const[n,j]=g.useState("Daily"),{odpOrders:p}=Q(),x=g.useMemo(()=>p.filter(a=>a.status==="SCHEDULED"),[p]),{loadMachineAvailabilityForDate:h,machineAvailability:s}=I(),i=g.useMemo(()=>W(d),[d]);g.useEffect(()=>(n==="Daily"&&h(i),()=>{}),[i,h,n]);const r=g.useMemo(()=>{if(n!=="Daily")return{};const a=s[i];if(!Array.isArray(a)||a.length===0)return{};const m={};for(let o=0;o<a.length;o++){const M=a[o];M.machine_id&&M.unavailable_hours&&(m[M.machine_id]=new Set(M.unavailable_hours.map(A=>A.toString())))}return m},[s,i,n]),u=g.useMemo(()=>Array.from({length:24},(a,m)=>e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${m*4+1} / span 4`},children:m.toString().padStart(2,"0")},m)),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:n,onChange:a=>j(a.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:n==="Daily"?e.jsxs("div",{className:"calendar-grid",children:[e.jsxs("div",{className:"calendar-header-row",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"time-header",children:u})]}),e.jsx("div",{className:"calendar-body",children:t.map(a=>e.jsx(se,{machine:a,scheduledEvents:x,currentDate:d,unavailableByMachine:r,dropTargetId:l},a.id))})]}):e.jsx(ae,{machines:t,currentDate:d,scheduledTasks:x})})]})});export{ie as default};
