const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DQH2hy3E.js","assets/index-DYuSv39q.css"])))=>i.map(i=>d[i]);
import{u as A,h as L,w as I,c as C,x as O,y as B,z as Q,r as v,g as S,j as e,v as R,f as T,_ as w,b as V,E as F,F as H}from"./index-DQH2hy3E.js";function W({task:s,index:N,machineId:m}){const _=A(),j=L(),{removeTaskFromQueue:a}=I(),{data:y=[]}=C(),{data:g}=O(s.fase),h=g?.name||null,{attributes:t,listeners:l,setNodeRef:x,transform:f,transition:E,isDragging:b}=B({id:`task-${s.id}`,data:{type:"queue-task",task:s,machineId:m,index:N}}),M={transform:Q.Transform.toString(f),transition:E,opacity:b?.5:1},{isPauseTask:r,splitInfo:n}=v.useMemo(()=>{try{if(s.description){const o=JSON.parse(s.description),u=o.is_pause===!0,c=o.wasSplit?{wasSplit:o.wasSplit,totalSegments:o.totalSegments||1,segments:o.segments||[]}:null;return{isPauseTask:u,splitInfo:c}}}catch{}return{isPauseTask:s.odp_number?.startsWith("PAUSE-")||s.article_code==="PAUSE",splitInfo:null}},[s]),q=s.time_remaining||s.duration||0,D=s.scheduled_start_time?S(s.scheduled_start_time):"—",P=s.scheduled_end_time?S(s.scheduled_end_time):"—",$=(i=>r?"#6b7280":i>70?"#059669":i>=40&&i<=69?"#d97706":"#dc2626")(s.material_availability_global||0),z=async i=>{if(i.stopPropagation(),i.preventDefault(),!!window.confirm(r?"Sei sicuro di voler rimuovere questa pausa?":`Sei sicuro di voler rimuovere "${s.odp_number}" dalla coda?

I task successivi verranno ricalcolati automaticamente.`))try{const u=await a(m,s.id,y);if(u.error){const{showError:c}=await w(async()=>{const{showError:d}=await import("./index-DQH2hy3E.js").then(p=>p.G);return{showError:d}},__vite__mapDeps([0,1]));c(u.error)}else{j.invalidateQueries({queryKey:["orders"],exact:!0,refetchType:"all"}),await new Promise(d=>setTimeout(d,100)),await j.refetchQueries({queryKey:["orders"],exact:!0,type:"active"});const{showSuccess:c}=await w(async()=>{const{showSuccess:d}=await import("./index-DQH2hy3E.js").then(p=>p.G);return{showSuccess:d}},__vite__mapDeps([0,1]));c("Lavoro rimosso dalla coda")}}catch(u){console.error("Error unscheduling task:",u);const{showError:c}=await w(async()=>{const{showError:d}=await import("./index-DQH2hy3E.js").then(p=>p.G);return{showError:d}},__vite__mapDeps([0,1]));c("Errore durante la rimozione del lavoro dalla coda")}},k=i=>{i.stopPropagation(),i.preventDefault(),r||_(`/backlog/${s.id}/edit`)};return e.jsxs("div",{ref:x,style:M,className:`queue-task-card ${r?"pause-task":""} ${b?"dragging":""}`,children:[e.jsx("div",{className:"queue-task-drag-handle",...t,...l,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),e.jsxs("div",{className:"queue-task-content",style:{borderLeftColor:$},children:[e.jsxs("div",{className:"queue-task-position",children:["#",N+1]}),e.jsxs("div",{className:"queue-task-main",children:[e.jsxs("div",{className:"queue-task-odp",children:[s.odp_number,n&&n.wasSplit&&e.jsxs("span",{className:"split-badge",title:`Task split into ${n.totalSegments} segments due to machine unavailability`,children:["✂️ ",n.totalSegments]})]}),!r&&s.article_code&&e.jsx("div",{className:"queue-task-article",children:s.article_code}),r&&e.jsx("div",{className:"queue-task-pause-label",children:"⏸ Pausa"})]}),!r&&(h||s.delivery_date||s.bag_step)&&e.jsxs("div",{className:"queue-task-details",children:[h&&e.jsxs("div",{className:"queue-task-detail-item",children:[e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),e.jsx("path",{d:"M2 17l10 5 10-5"}),e.jsx("path",{d:"M2 12l10 5 10-5"})]}),e.jsx("span",{className:"detail-value",children:h})]}),s.delivery_date&&e.jsxs("div",{className:"queue-task-detail-item",children:[e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{className:"detail-value",children:R(s.delivery_date)})]}),s.bag_step&&e.jsxs("div",{className:"queue-task-detail-item",children:[e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"})}),e.jsxs("span",{className:"detail-value",children:[s.bag_step,"mm"]})]})]}),e.jsxs("div",{className:"queue-task-duration",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]}),e.jsxs("span",{children:[q.toFixed(1),"h"]})]}),e.jsxs("div",{className:"queue-task-times",children:[e.jsxs("div",{className:"queue-task-time",children:[e.jsx("span",{className:"time-label",children:"Inizio:"}),e.jsx("span",{className:"time-value",children:D})]}),e.jsxs("div",{className:"queue-task-time",children:[e.jsx("span",{className:"time-label",children:"Fine:"}),e.jsx("span",{className:"time-value",children:P})]})]}),n&&n.wasSplit&&e.jsxs("div",{className:"queue-task-split-info",children:[e.jsx("span",{className:"split-info-icon",children:"⚠️"}),e.jsxs("span",{className:"split-info-text",children:["Diviso in ",n.totalSegments," segmenti"]})]}),!r&&s.progress>0&&e.jsxs("div",{className:"queue-task-progress",children:[e.jsx("div",{className:"progress-bar-bg",children:e.jsx("div",{className:"progress-bar-fill",style:{width:`${Math.min(s.progress,100)}%`}})}),e.jsxs("span",{className:"progress-text",children:[Math.round(s.progress),"%"]})]})]}),e.jsxs("div",{className:"queue-task-actions",children:[e.jsx("button",{className:"queue-task-btn info-btn",onClick:i=>{i.stopPropagation(),i.preventDefault()},title:r?`Pausa di ${q}h`:`Codice Articolo: ${s.article_code||"Non specificato"}
Codice Articolo Esterno: ${s.external_article_code||"Non specificato"}
Nome Cliente: ${s.nome_cliente||"Non specificato"}
Data Consegna: ${s.delivery_date?T(new Date(s.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${s.quantity||"Non specificata"}
Note Libere: ${s.user_notes||"Nessuna nota"}
Note ASD: ${s.asd_notes||"Nessuna nota"}
Material Global: ${s.material_availability_global||"N/A"}%`,children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}),!r&&e.jsx("button",{className:"queue-task-btn edit-btn",onClick:k,title:"Modifica",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:"queue-task-btn remove-btn",onClick:z,title:r?"Rimuovi pausa":"Rimuovi dalla coda",children:e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]})}function K({machine:s,queryClient:N}){const{data:m=[]}=C(),{setNodeRef:_,isOver:j}=V({id:`machine-queue-${s.id}`,data:{type:"queue-column",machineId:s.id,machine:s}}),a=v.useMemo(()=>m.filter(t=>t.scheduled_machine_id===s.id&&t.status==="SCHEDULED"&&t.scheduled_start_time).sort((t,l)=>{const x=new Date(t.scheduled_start_time).getTime(),f=new Date(l.scheduled_start_time).getTime();return x-f}),[m,s.id]),y=v.useMemo(()=>a.reduce((t,l)=>{const x=l.time_remaining||l.duration||0;return t+x},0),[a]),g=v.useMemo(()=>{if(a.length===0)return null;const t=a[a.length-1];return t.scheduled_end_time?new Date(t.scheduled_end_time):null},[a]),h=v.useMemo(()=>a.map(t=>`task-${t.id}`),[a]);return e.jsxs("div",{ref:_,className:`machine-queue-column ${j?"is-drag-over":""}`,children:[e.jsxs("div",{className:"queue-column-header",children:[e.jsxs("div",{className:"queue-column-title",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:s.machine_name}),e.jsx("span",{className:"text-[10px] text-gray-500",children:s.work_center})]}),e.jsxs("div",{className:"queue-column-stats",children:[e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-label",children:"Tasks:"}),e.jsx("span",{className:"stat-value",children:a.length})]}),e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-label",children:"Durata:"}),e.jsxs("span",{className:"stat-value",children:[y.toFixed(1),"h"]})]}),g&&e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-label",children:"Fine:"}),e.jsx("span",{className:"stat-value",children:T(g,"dd/MM HH:mm")})]})]})]}),e.jsx("div",{className:"queue-column-body",children:a.length===0?e.jsxs("div",{className:"queue-empty-state",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Nessun lavoro in coda"}),e.jsx("p",{className:"text-[10px] text-gray-400",children:"Trascina un lavoro qui per iniziare"})]}):e.jsx(F,{items:h,strategy:H,children:e.jsx("div",{className:"queue-tasks-list",children:a.map((t,l)=>e.jsx(W,{task:t,index:l,machineId:s.id},t.id))})})})]})}export{K as default};
