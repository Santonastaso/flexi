import{R as E,r as p,a as Q,g as A,t as F,j as e,d as P,h as X,f as L,b as J,e as K,i as Y,k as Z,l as I,m as W}from"./index-BAK4NH6G.js";const ee=E.memo(({machine:t,hour:m,minute:l,isUnavailable:n,hasScheduledTask:y,dropTargetId:x,slotId:f})=>{const{setNodeRef:u}=J({id:`slot-${t.id}-${m}-${l}`,data:{machine:t,hour:m,minute:l,type:"slot",isUnavailable:n,hasScheduledTask:y}}),s=`time-slot${n?" unavailable":""}${y?" has-scheduled-task":""}`,i=x===f;return e.jsx("div",{ref:u,className:s,"data-hour":m,"data-minute":l,"data-machine-id":t.id,style:{position:"relative"},children:i&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:0,left:0,right:0,bottom:0,border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),te=E.memo(({event:t,machine:m,currentDate:l})=>{const[n,y]=p.useState(!0),x=P(),{getSplitTaskInfo:f,splitTasksInfo:u}=A(),{attributes:s,listeners:i,setNodeRef:r,transform:g,isDragging:a}=K({id:`event-${t.id}`,data:{event:t,type:"event",machine:m},disabled:n}),h=p.useMemo(()=>{const v=f(t.id),N=Y(l),d=Z(l);if(console.log(`üîç Task ${t.odp_number} (${t.id}):`,{hasSegmentInfo:!!v,segmentCount:v?.segments?.length||0,wasSplit:v?.wasSplit||!1,description:t.description?.substring(0,100)+"..."}),!v||!v.segments){if(console.warn(`‚ö†Ô∏è No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const H=new Date(t.scheduled_start_time),w=t.time_remaining||t.duration||1,$=new Date(H.getTime()+w*60*60*1e3),c={start:H,end:$},k=I(c.start,l),U=I(c.end,l),T=c.start<d&&c.end>N;if(!k&&!U&&!T)return null;let b,S;if(k&&U){const C=c.start.getUTCHours(),j=c.start.getUTCMinutes(),_=c.end.getUTCHours(),z=c.end.getUTCMinutes(),V=C*4+Math.floor(j/15),q=_*4+Math.ceil(z/15);b=V*20,S=(q-V)*20}else if(k){const C=c.start.getUTCHours(),j=c.start.getUTCMinutes(),_=C*4+Math.floor(j/15);b=_*20,S=(96-_)*20}else if(U){const C=c.end.getUTCHours(),j=c.end.getUTCMinutes(),_=C*4+Math.ceil(j/15);b=0,S=_*20}else b=0,S=1920;return[{left:b,width:S,start:c.start,end:c.end}]}const D=[];for(const H of v.segments){const w=new Date(H.start),$=new Date(H.end),c=I(w,l),k=I($,l),U=w<d&&$>N;if(c||k||U){let T,b;if(c&&k){const S=w.getUTCHours(),C=w.getUTCMinutes(),j=$.getUTCHours(),_=$.getUTCMinutes(),z=S*4+Math.floor(C/15),V=j*4+Math.ceil(_/15);T=z*20,b=(V-z)*20}else if(c){const S=w.getUTCHours(),C=w.getUTCMinutes(),j=S*4+Math.floor(C/15);T=j*20,b=(96-j)*20}else if(k){const S=$.getUTCHours(),C=$.getUTCMinutes(),j=S*4+Math.ceil(C/15);T=0,b=j*20}else T=0,b=1920;D.push({left:T,width:b,start:w,end:$})}}return console.log(`‚úÖ Task ${t.odp_number}: ${D.length} visible segments`),D.length>0?D:null},[t.id,l,f,u]),o=h?h.reduce((v,N)=>v+N.width,0):0,M=o<60,O=o<120,R=M&&o<80,B=o<40,G=p.useCallback(v=>{v.stopPropagation(),y(!n)},[n]);return!h||h.length===0?null:e.jsx(e.Fragment,{children:h.map((v,N)=>e.jsxs("div",{ref:N===0?r:void 0,style:{position:"absolute",left:`${v.left}px`,width:`${v.width}px`,transform:a&&N===0?`translate3d(${g?.x||0}px, ${g?.y||0}px, 0)`:"none",zIndex:a?1001:10,opacity:a?.8:1,transition:a?"none":"opacity 0.1s ease",pointerEvents:a?"none":"auto"},className:`scheduled-event ${a?"dragging":""} ${M?"very-small":""} ${O?"small":""} ${B?"extremely-narrow":""} ${h.length>1?"split-segment":""}`,...N===0?{...s,...i}:{},children:[e.jsx("div",{className:"event-content",style:{opacity:a?.7:1,transform:a?"scale(0.95)":"none"},children:e.jsxs("span",{className:"event-label",children:[t.odp_number,N===0&&(()=>{const d=f(t.id);return d&&d.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${d.totalSegments} segments`,children:"‚úÇÔ∏è"}):null})()]})}),!a&&N===0&&e.jsxs("div",{className:`event-controls ${R?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
Data Consegna: ${L(t.delivery_date)||"Non impostata"}
Quantit√†: ${t.quantity||"Non specificata"}
${t.scheduled_start_time?`Inizio Programmato: ${W(t.scheduled_start_time)}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${W(t.scheduled_end_time)}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:d=>{d.stopPropagation(),x(`/backlog/${t.id}/edit`)},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${n?"locked":"unlocked"}`,onClick:G,title:n?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:n?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!n&&e.jsx("div",{className:"drag-handle",...i,...s,title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!n&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async d=>{d.stopPropagation(),d.preventDefault();try{await A.getState().unscheduleTask(t.id)}catch(D){console.error("Error unscheduling task:",D)}},onMouseDown:d=>{d.stopPropagation(),d.preventDefault()},onPointerDown:d=>{d.stopPropagation(),d.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"√ó"})})]})]},`${t.id}-segment-${N}`))})}),se=E.memo(({machine:t,scheduledEvents:m,currentDate:l,unavailableByMachine:n,dropTargetId:y})=>{const x=p.useMemo(()=>m.filter(u=>u.scheduled_machine_id===t.id),[m,t.id]),f=n[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:96},(u,s)=>{const i=Math.floor(s/4),r=s%4*15,g=f?f.has(i.toString()):!1,a=`${t.id}-${i}-${r}`;return e.jsx(ee,{machine:t,hour:i,minute:r,isUnavailable:g,hasScheduledTask:!1,dropTargetId:y,slotId:a},a)}),x.length>0&&x.map(u=>e.jsx(te,{event:u,machine:t,currentDate:l},`event-${u.id}`))]})]})}),ae=E.memo(({machines:t,currentDate:m,scheduledTasks:l})=>{const n=P(),y=p.useMemo(()=>{const s=X(m),i=[];for(let r=0;r<7;r++){const g=new Date(s);g.setDate(s.getDate()+r),i.push(g)}return i},[m]),x=p.useCallback((s,i)=>l.filter(r=>r.scheduled_machine_id===s&&r.scheduled_start_time&&F(new Date(r.scheduled_start_time))===i),[l]),f=p.useCallback(s=>{n(`/backlog/${s.id}/edit`)},[n]),u=p.useCallback((s,i)=>x(s,i).length,[x]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),y.map(s=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:L(s)}),e.jsx("div",{className:"day-date",children:L(s)})]},s.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(s=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:s.machine_name}),e.jsx("div",{className:"machine-city",children:s.work_center})]}),y.map(i=>{const r=F(i),g=x(s.id,r),a=u(s.id,r),h=i.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${h?"today":""} ${a>0?"has-tasks":""}`,children:g.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[a," task",a!==1?"s":""]}),g.slice(0,3).map(o=>e.jsxs("div",{className:"day-task-item",onClick:()=>f(o),title:`${o.odp_number} - ${o.article_code||"Codice articolo FLEXI"} - ${o.time_remaining?Number(o.time_remaining).toFixed(1):(o.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:o.odp_number}),e.jsxs("span",{className:"task-duration",children:[o.time_remaining?Number(o.time_remaining).toFixed(1):(o.duration||1).toFixed(1),"h"]})]},o.id)),g.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",g.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${s.id}-${r}`)})]},s.id))})]})}),ie=E.memo(({machines:t,currentDate:m,dropTargetId:l})=>{const[n,y]=p.useState("Daily"),{odpOrders:x}=Q(),f=p.useMemo(()=>x.filter(a=>a.status==="SCHEDULED"),[x]),{loadMachineAvailabilityForDate:u,machineAvailability:s}=A(),i=p.useMemo(()=>F(m),[m]);p.useEffect(()=>(n==="Daily"&&u(i),()=>{}),[i,u,n]);const r=p.useMemo(()=>{if(n!=="Daily")return{};const a=s[i];if(!Array.isArray(a)||a.length===0)return{};const h={};for(let o=0;o<a.length;o++){const M=a[o];M.machine_id&&M.unavailable_hours&&(h[M.machine_id]=new Set(M.unavailable_hours.map(O=>O.toString())))}return h},[s,i,n]),g=p.useMemo(()=>Array.from({length:24},(a,h)=>e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${h*4+1} / span 4`},children:h.toString().padStart(2,"0")},h)),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:n,onChange:a=>y(a.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:n==="Daily"?e.jsxs("div",{className:"calendar-grid",children:[e.jsxs("div",{className:"calendar-header-row",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"time-header",children:g})]}),e.jsx("div",{className:"calendar-body",children:t.map(a=>e.jsx(se,{machine:a,scheduledEvents:f,currentDate:m,unavailableByMachine:r,dropTargetId:l},a.id))})]}):e.jsx(ae,{machines:t,currentDate:m,scheduledTasks:f})})]})});export{ie as default};
