import{R as H,r as u,a as P,f as O,t as V,j as e,d as A,g as G,b as Z,e as q,h as Q,i as J,k as E}from"./index-BgfeLQuv.js";const K=H.memo(({machine:t,hour:r,minute:a,isUnavailable:o,hasScheduledTask:g})=>{const{setNodeRef:h}=Z({id:`slot-${t.id}-${r}-${a}`,data:{machine:t,hour:r,minute:a,type:"slot",isUnavailable:o,hasScheduledTask:g}}),m=`time-slot${o?" unavailable":""}${g?" has-scheduled-task":""}`;return e.jsx("div",{ref:h,className:m,"data-hour":r,"data-minute":a,"data-machine-id":t.id})}),X=H.memo(({event:t,machine:r,currentDate:a})=>{const[o,g]=u.useState(!0),h=A(),{getSplitTaskInfo:m,splitTasksInfo:w}=O(),{attributes:s,listeners:c,setNodeRef:d,transform:n,isDragging:l}=q({id:`event-${t.id}`,data:{event:t,type:"event",machine:r},disabled:o}),x=u.useMemo(()=>{const f=m(t.id),v=Q(a),j=J(a);if(f&&f.wasSplit){const y=[];for(const D of f.segments){const p=new Date(D.start),S=new Date(D.end),k=E(p,a),T=E(S,a),M=p<j&&S>v;if(k||T||M){let N,b;if(k&&T){const C=p.getUTCHours(),$=p.getUTCMinutes(),_=S.getUTCHours(),I=S.getUTCMinutes(),U=C*4+Math.floor($/15),B=_*4+Math.ceil(I/15);N=U*20,b=(B-U)*20}else if(k){const C=p.getUTCHours(),$=p.getUTCMinutes(),_=C*4+Math.floor($/15);N=_*20,b=(96-_)*20}else if(T){const C=S.getUTCHours(),$=S.getUTCMinutes(),_=C*4+Math.ceil($/15);N=0,b=_*20}else N=0,b=1920;y.push({left:N,width:b,start:p,end:S})}}return y.length>0?y:null}else{const y=new Date(t.scheduled_start_time),D=t.time_remaining||t.duration||1,p=new Date(y.getTime()+D*60*60*1e3),S=E(y,a),k=E(p,a),T=y<j&&p>v;if(!S&&!k&&!T)return null;let M,N;if(S){const b=y.getUTCHours(),C=y.getUTCMinutes();M=(b*4+Math.floor(C/15))*20;const _=24-b;N=Math.min(D,_)*4*20}else if(k){M=0;const b=p.getUTCHours(),C=p.getUTCMinutes();N=(b*4+Math.ceil(C/15))*20}else M=0,N=1920;return[{left:M,width:N,start:y,end:p}]}},[t.scheduled_start_time,t.time_remaining,t.duration,a,m,t.id,w]),i=x?x.reduce((f,v)=>f+v.width,0):0,z=i<60,L=i<120,W=z&&i<80,F=i<40,R=u.useCallback(f=>{f.stopPropagation(),g(!o)},[o]);return!x||x.length===0?null:e.jsx(e.Fragment,{children:x.map((f,v)=>e.jsxs("div",{ref:v===0?d:void 0,style:{position:"absolute",left:`${f.left}px`,width:`${f.width}px`,transform:l&&v===0?`translate3d(${n?.x||0}px, ${n?.y||0}px, 0)`:"none",zIndex:l?1001:10,opacity:l?.8:1,transition:l?"none":"opacity 0.1s ease",pointerEvents:l?"none":"auto"},className:`scheduled-event ${l?"dragging":""} ${z?"very-small":""} ${L?"small":""} ${F?"extremely-narrow":""} ${x.length>1?"split-segment":""}`,...v===0?{...s,...c}:{},children:[e.jsx("div",{className:"event-content",style:{opacity:l?.7:1,transform:l?"scale(0.95)":"none"},children:e.jsxs("span",{className:"event-label",children:[t.odp_number,v===0&&(()=>{const j=m(t.id);return j&&j.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${j.totalSegments} segments`,children:"✂️"}):null})()]})}),!l&&v===0&&e.jsxs("div",{className:`event-controls ${W?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
Data Consegna: ${t.delivery_date?new Date(t.delivery_date).toLocaleDateString():"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
${t.scheduled_start_time?`Inizio Programmato: ${new Date(t.scheduled_start_time).toISOString().replace("T"," ").replace(".000Z","")}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${new Date(t.scheduled_end_time).toISOString().replace("T"," ").replace(".000Z","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:j=>{j.stopPropagation(),h(`/backlog/${t.id}/edit`)},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${o?"locked":"unlocked"}`,onClick:R,title:o?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:o?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!o&&e.jsx("div",{className:"drag-handle",...c,...s,title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!o&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:j=>{j.stopPropagation(),O.getState().unscheduleTask(t.id)},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${v}`))})}),Y=H.memo(({machine:t,scheduledEvents:r,currentDate:a,unavailableByMachine:o})=>{const g=u.useMemo(()=>r.filter(m=>m.scheduled_machine_id===t.id),[r,t.id]),h=o[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:96},(m,w)=>{const s=Math.floor(w/4),c=w%4*15,d=h?h.has(s.toString()):!1;return e.jsx(K,{machine:t,hour:s,minute:c,isUnavailable:d,hasScheduledTask:!1},`${t.id}-${s}-${c}`)}),g.length>0&&g.map(m=>e.jsx(X,{event:m,machine:t,currentDate:a},`event-${m.id}`))]})]})}),ee=H.memo(({machines:t,currentDate:r,scheduledTasks:a})=>{const o=A(),g=u.useMemo(()=>{const s=G(r),c=[];for(let d=0;d<7;d++){const n=new Date(s);n.setDate(s.getDate()+d),c.push(n)}return c},[r]),h=u.useCallback((s,c)=>a.filter(d=>d.scheduled_machine_id===s&&d.scheduled_start_time&&V(new Date(d.scheduled_start_time))===c),[a]),m=u.useCallback(s=>{o(`/backlog/${s.id}/edit`)},[o]),w=u.useCallback((s,c)=>h(s,c).length,[h]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),g.map(s=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:s.toLocaleDateString("en-US",{weekday:"short"})}),e.jsx("div",{className:"day-date",children:s.toLocaleDateString("en-US",{month:"short",day:"numeric"})})]},s.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(s=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:s.machine_name}),e.jsx("div",{className:"machine-city",children:s.work_center})]}),g.map(c=>{const d=V(c),n=h(s.id,d),l=w(s.id,d),x=c.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${x?"today":""} ${l>0?"has-tasks":""}`,children:n.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[l," task",l!==1?"s":""]}),n.slice(0,3).map(i=>e.jsxs("div",{className:"day-task-item",onClick:()=>m(i),title:`${i.odp_number} - ${i.product_name||"Prodotto non specificato"} - ${i.time_remaining?Number(i.time_remaining).toFixed(1):(i.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:i.odp_number}),e.jsxs("span",{className:"task-duration",children:[i.time_remaining?Number(i.time_remaining).toFixed(1):(i.duration||1).toFixed(1),"h"]})]},i.id)),n.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",n.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${s.id}-${d}`)})]},s.id))})]})}),se=H.memo(({machines:t,currentDate:r})=>{const[a,o]=u.useState("Daily"),{odpOrders:g}=P(),h=u.useMemo(()=>g.filter(n=>n.status==="SCHEDULED"),[g]),{loadMachineAvailabilityForDate:m,machineAvailability:w}=O(),s=u.useMemo(()=>V(r),[r]);console.log("GanttChart render:",{machinesCount:t?.length,machines:t,currentDate:r.toISOString(),dateStr:s,scheduledTasksCount:h.length}),u.useEffect(()=>(a==="Daily"&&m(s),()=>{}),[s,m,a]);const c=u.useMemo(()=>{if(a!=="Daily")return{};const n=w[s];if(!Array.isArray(n)||n.length===0)return{};const l={};for(let x=0;x<n.length;x++){const i=n[x];i.machine_id&&i.unavailable_hours&&(l[i.machine_id]=new Set(i.unavailable_hours.map(z=>z.toString())))}return l},[w,s,a]),d=u.useMemo(()=>Array.from({length:24},(n,l)=>e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${l*4+1} / span 4`},children:l.toString().padStart(2,"0")},l)),[]);return!t||t.length===0?(console.log("GanttChart: No machines available, showing empty state"),e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})})):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:a,onChange:n=>o(n.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:a==="Daily"?e.jsxs("div",{className:"calendar-grid",children:[e.jsxs("div",{className:"calendar-header-row",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"time-header",children:d})]}),e.jsx("div",{className:"calendar-body",children:t.map(n=>e.jsx(Y,{machine:n,scheduledEvents:h,currentDate:r,unavailableByMachine:c},n.id))})]}):e.jsx(ee,{machines:t,currentDate:r,scheduledTasks:h})})]})});export{se as default};
