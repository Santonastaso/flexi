import{u as x,a as O,b as y,c as $,d as P,e as M,f as v,r as l,j as r,D as R,g as T,h as A}from"./index-QXY9iq7x.js";const k=({task:o,isEditMode:i,schedulingLoading:s,conflictDialog:d})=>{x();const{updateOdpOrder:c}=y();v("TaskPoolDataTable");const{attributes:u,listeners:m,setNodeRef:n}=T({id:`task-${o.id}`,data:{task:o,type:"task"},disabled:!i}),p=s.taskId===o.id&&(s.isScheduling||s.isRescheduling||s.isShunting);return r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{className:"inline-flex items-center justify-center w-6 h-6 text-xs font-bold text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors",onClick:e=>{e.stopPropagation(),e.preventDefault()},onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},onPointerDown:e=>{e.stopPropagation(),e.preventDefault()},title:`Codice Articolo: ${o.article_code||"Non specificato"}
Codice Articolo Esterno: ${o.external_article_code||"Non specificato"}
Nome Cliente: ${o.nome_cliente||"Non specificato"}
Data Consegna: ${o.delivery_date?A(new Date(o.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${o.quantity||"Non specificata"}
Note Libere: ${o.user_notes||"Nessuna nota"}
${o.scheduled_start_time?`Inizio Programmato: ${o.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
${o.scheduled_end_time?`Fine Programmata: ${o.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:"i"}),i&&r.jsx("div",{ref:n,className:"drag-handle",...m,...u,title:"Trascina per programmare",style:{background:"#f3f4f6",border:"1px solid #d1d5db",minWidth:"30px",minHeight:"30px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"grab",borderRadius:"4px",transition:"all 0.2s ease"},onMouseEnter:e=>{e.target.style.background="#e5e7eb",e.target.style.borderColor="#9ca3af"},onMouseLeave:e=>{e.target.style.background="#f3f4f6",e.target.style.borderColor="#d1d5db"},onClick:e=>{e.stopPropagation()},onMouseDown:e=>{e.stopPropagation()},children:r.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),p&&r.jsx("div",{className:"inline-flex items-center justify-center w-6 h-6",children:r.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-blue-600"})})]})};function I(){const o=x(),{selectedWorkCenter:i,isEditMode:s,conflictDialog:d,schedulingLoading:c,showConfirmDialog:u}=O(),{odpOrders:m,setOdpOrders:n}=y(),{setNodeRef:p}=$({id:"task-pool",data:{type:"pool"}}),{data:e=[],isLoading:_,error:N,refetch:f}=P(),j=M(),{handleAsync:w}=v("TaskPoolDataTable");l.useEffect(()=>{e.length>0&&n(e)},[e,n]),l.useEffect(()=>{const t=()=>{f()};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[f]);const h=e.length>0?e:m,b=l.useMemo(()=>{let t=h.filter(a=>a.status!=="SCHEDULED"&&a.duration>0&&a.cost>0);return i&&i!=="BOTH"&&(t=t.filter(a=>a.work_center===i)),t},[h,i]),D=l.useMemo(()=>[{header:"ODP",accessorKey:"odp_number"},{header:"Codice Articolo",accessorKey:"article_code"},{header:"Nome Cliente",accessorKey:"nome_cliente"},{header:"Durata (h)",accessorKey:"duration",cell:({row:t})=>{const a=t.original.duration;return a?Number(a).toFixed(1):"N/A"}},{header:"Costo (€)",accessorKey:"cost",cell:({row:t})=>{const a=t.original.cost;return a?Number(a).toFixed(2):"N/A"}},{header:"Material ISP (%)",accessorKey:"material_availability_isp",cell:({row:t})=>{const a=t.original.material_availability_isp;if(typeof a!="number")return a||"N/A";const g=a<=39?"bg-gray-300":a<=69?"bg-yellow-400":"bg-green-400";return r.jsx("div",{className:`inline-flex items-center justify-center w-8 h-8 rounded-full ${g} text-black text-[10px] font-medium`,children:a})}},{header:"Material Lotti (%)",accessorKey:"material_availability_lotti",cell:({row:t})=>{const a=t.original.material_availability_lotti;if(typeof a!="number")return a||"N/A";const g=a<=39?"bg-gray-300":a<=69?"bg-yellow-400":"bg-green-400";return r.jsx("div",{className:`inline-flex items-center justify-center w-8 h-8 rounded-full ${g} text-black text-[10px] font-medium`,children:a})}},{header:"Gantt",id:"gantt_actions",cell:({row:t})=>r.jsx(k,{task:t.original,isEditMode:s,schedulingLoading:c,conflictDialog:d})}],[s,c,d]),C=t=>{if(!t||!t.id){console.error("Invalid task data for editing:",t);return}o(`/backlog/${t.id}/edit`)},E=async t=>{u("Elimina Ordine",`Sei sicuro di voler eliminare "${t.odp_number}"? Questa azione non può essere annullata.`,async()=>{await w(async()=>{await j.mutateAsync(t.id)},{context:"Delete Order",fallbackMessage:"Eliminazione ordine fallita"})},"danger")};return r.jsx("div",{ref:p,id:"task_pool",className:"task-pool-table-container",children:_?r.jsxs("div",{className:"empty-state",children:[r.jsx("h3",{children:"Caricamento..."}),r.jsx("p",{children:"Recupero dati dal server..."})]}):N?r.jsxs("div",{className:"empty-state",children:[r.jsx("h3",{children:"Errore nel caricamento"}),r.jsx("p",{children:"Impossibile caricare i dati. Riprova più tardi."})]}):b.length>0?r.jsx(R,{data:b,columns:D,onEditRow:C,onDeleteRow:E,enableFiltering:!0,filterableColumns:["odp_number","article_code","nome_cliente"]}):r.jsxs("div",{className:"empty-state",children:[r.jsx("h3",{children:"Nessun lavoro non programmato disponibile"}),r.jsx("p",{children:"I lavori devono avere durata e costo maggiori di 0 per essere visualizzati qui."})]})})}export{I as default};
