import{n as P,s as G,t as ee,i as Q,r as d,h as T,c as Z,j as e,R as F,b as te,k as O,l as se,u as K,m as ae,A as ne,a as ie,g as oe}from"./index-CZ0b7BAn.js";function B(t,s,o){const[g,r]=P(o?.in,t,s);return+G(g)==+G(r)}function le(t,s){const o=ee(t,s?.in);return o.setHours(23,59,59,999),o}function re(t,s,o){return Q(t,-1,o)}const ce=({currentDate:t,onNavigateToNextDay:s,isDragOver:o})=>{const[g,r]=d.useState(!1),[a,h]=d.useState(null),y=Q(t,1),v=T(y,"yyyy-MM-dd"),{setNodeRef:n}=Z({id:"next-day-drop-zone",data:{type:"next-day",targetDate:y,currentDate:t}});d.useEffect(()=>{if(o&&!a){const f=setTimeout(()=>{s(),h(null)},1600);h(f)}else!o&&a&&(clearTimeout(a),h(null));return()=>{a&&clearTimeout(a)}},[o,s,a]);const u=d.useCallback(()=>{r(!0)},[]),m=d.useCallback(()=>{r(!1)},[]),c=d.useCallback(()=>{a&&(clearTimeout(a),h(null)),s()},[s,a]),p=o||g||a;return e.jsxs("div",{ref:n,className:`next-day-drop-zone ${p?"active":""}`,onMouseEnter:u,onMouseLeave:m,onClick:c,title:`Trascina qui per andare al giorno successivo (${v})`,children:[e.jsxs("div",{className:"next-day-content",children:[e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})}),e.jsxs("div",{className:"next-day-text",children:[e.jsx("div",{className:"next-day-label",children:"Giorno Successivo"}),e.jsx("div",{className:"next-day-date",children:v})]}),e.jsx("div",{className:"next-day-hint",children:a?"Navigazione in corso...":"Trascina qui per andare al giorno successivo"})]}),e.jsx("div",{className:"next-day-bg-effect"}),p&&e.jsx("div",{className:"next-day-pulse"})]})},de=({currentDate:t,onNavigateToPreviousDay:s,isDragOver:o})=>{const[g,r]=d.useState(!1),[a,h]=d.useState(null),y=re(t),v=T(y,"yyyy-MM-dd"),{setNodeRef:n}=Z({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:y,currentDate:t}});d.useEffect(()=>{if(o&&!a){const f=setTimeout(()=>{s(),h(null)},1600);h(f)}else!o&&a&&(clearTimeout(a),h(null));return()=>{a&&clearTimeout(a)}},[o,s,a]);const u=d.useCallback(()=>{r(!0)},[]),m=d.useCallback(()=>{r(!1)},[]),c=d.useCallback(()=>{a&&(clearTimeout(a),h(null)),s()},[s,a]),p=o||g||a;return e.jsxs("div",{ref:n,className:`previous-day-drop-zone ${p?"active":""}`,onMouseEnter:u,onMouseLeave:m,onClick:c,title:`Trascina qui per andare al giorno precedente (${v})`,children:[e.jsxs("div",{className:"previous-day-content",children:[e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})}),e.jsxs("div",{className:"previous-day-text",children:[e.jsx("div",{className:"previous-day-label",children:"Giorno Precedente"}),e.jsx("div",{className:"previous-day-date",children:v})]}),e.jsx("div",{className:"previous-day-hint",children:a?"Navigazione in corso...":"Trascina qui per andare al giorno precedente"})]}),e.jsx("div",{className:"previous-day-bg-effect"}),p&&e.jsx("div",{className:"previous-day-pulse"})]})},ue=F.memo(({machine:t,hour:s,minute:o,isUnavailable:g,hasScheduledTask:r,dropTargetId:a,slotId:h})=>{const{setNodeRef:y}=Z({id:`slot-${t.id}-${s}-${o}`,data:{machine:t,hour:s,minute:o,type:"slot",isUnavailable:g,hasScheduledTask:r}}),v=`time-slot${g?" unavailable":""}${r?" has-scheduled-task":""}`,n=a===h;return e.jsx("div",{ref:y,className:v,"data-hour":s,"data-minute":o,"data-machine-id":t.id,style:{position:"relative"},children:n&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),me=F.memo(({event:t,machine:s,currentDate:o,queryClient:g})=>{const[r,a]=d.useState(!0),h=K(),{getSplitTaskInfo:y,splitTasksInfo:v}=O(),{schedulingLoading:n}=ie(),{attributes:u,listeners:m,setNodeRef:c,transform:p,isDragging:f}=oe({id:`event-${t.id}`,data:{event:t,type:"event",machine:s},disabled:r}),i=d.useMemo(()=>{const S=y(t.id),k=G(o),l=le(o);if(!S||!S.segments){if(console.warn(`⚠️ No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const A=new Date(t.scheduled_start_time),_=t.time_remaining||t.duration||1,D=new Date(A.getTime()+_*60*60*1e3),x={start:A,end:D},E=B(x.start,o),I=B(x.end,o),z=x.start<l&&x.end>k;if(!E&&!I&&!z)return null;let N,b;if(E&&I){const C=x.start.getUTCHours(),$=x.start.getUTCMinutes(),w=x.end.getUTCHours(),H=x.end.getUTCMinutes(),q=Math.max(6,C),R=Math.min(22,w),V=(q-6)*4+Math.floor($/15),J=(R-6)*4+Math.ceil(H/15);N=V*15,b=(J-V)*15}else if(E){const C=x.start.getUTCHours(),$=x.start.getUTCMinutes(),H=(Math.max(6,C)-6)*4+Math.floor($/15);N=H*15,b=(64-H)*15}else if(I){const C=x.end.getUTCHours(),$=x.end.getUTCMinutes(),H=(Math.min(22,C)-6)*4+Math.ceil($/15);N=0,b=H*15}else N=0,b=960;return[{left:N,width:b,start:x.start,end:x.end}]}const U=[];for(const A of S.segments){const _=new Date(A.start),D=new Date(A.end),x=B(_,o),E=B(D,o),I=_<l&&D>k;if(x||E||I){let z,N;if(x&&E){const b=_.getUTCHours(),C=_.getUTCMinutes(),$=D.getUTCHours(),w=D.getUTCMinutes(),H=Math.max(6,b),q=Math.min(22,$),R=(H-6)*4+Math.floor(C/15),V=(q-6)*4+Math.ceil(w/15);z=R*15,N=(V-R)*15}else if(x){const b=_.getUTCHours(),C=_.getUTCMinutes(),w=(Math.max(6,b)-6)*4+Math.floor(C/15);z=w*15,N=(64-w)*15}else if(E){const b=D.getUTCHours(),C=D.getUTCMinutes(),w=(Math.min(22,b)-6)*4+Math.ceil(C/15);z=0,N=w*15}else z=0,N=960;U.push({left:z,width:N,start:_,end:D})}}return U.length>0?U:null},[t.id,o,y,v]),j=i?i.reduce((S,k)=>S+k.width,0):0,M=j<60,L=j<120,W=M&&j<80,X=j<40,Y=d.useCallback(S=>{S.stopPropagation(),a(!r)},[r]);return!i||i.length===0?null:e.jsx(e.Fragment,{children:i.map((S,k)=>e.jsxs("div",{ref:k===0?c:void 0,style:{position:"absolute",left:`${S.left}px`,width:`${S.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${M?"very-small":""} ${L?"small":""} ${X?"extremely-narrow":""} ${i.length>1?"split-segment":""} ${n.taskId===t.id&&(n.isScheduling||n.isRescheduling||n.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,k===0&&(()=>{const l=y(t.id);return l&&l.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${l.totalSegments} segments`,children:"✂️"}):null})()]})}),k===0&&e.jsxs("div",{className:`event-controls ${W?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:l=>{l.stopPropagation(),l.preventDefault()},onMouseDown:l=>{l.stopPropagation(),l.preventDefault()},onPointerDown:l=>{l.stopPropagation(),l.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?T(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
Note Libere: ${t.user_notes||"Nessuna nota"}
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:l=>{l.stopPropagation(),l.preventDefault(),h(`/backlog/${t.id}/edit`)},onMouseDown:l=>{l.stopPropagation(),l.preventDefault()},onPointerDown:l=>{l.stopPropagation(),l.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${r?"locked":"unlocked"}`,onClick:Y,title:r?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:r?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!r&&e.jsx("div",{className:"drag-handle",...m,...u,style:{transform:f?`translate3d(${p?.x||0}px, ${p?.y||0}px, 0)`:"none",zIndex:f?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!r&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async l=>{l.stopPropagation(),l.preventDefault();try{await O.getState().unscheduleTask(t.id,g)}catch(U){console.error("Error unscheduling task:",U)}},onMouseDown:l=>{l.stopPropagation(),l.preventDefault()},onPointerDown:l=>{l.stopPropagation(),l.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${k}`))})}),he=F.memo(({machine:t,scheduledEvents:s,currentDate:o,unavailableByMachine:g,dropTargetId:r,hideMachineLabel:a=!1,queryClient:h})=>{const y=d.useMemo(()=>s.filter(n=>n.scheduled_machine_id===t.id),[s,t.id]),v=g[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!a&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(n,u)=>{const m=Math.floor(u/4)+6,c=u%4*15,p=v?v.has(m.toString()):!1,f=`${t.id}-${m}-${c}`;return e.jsx(ue,{machine:t,hour:m,minute:c,isUnavailable:p,hasScheduledTask:!1,dropTargetId:r,slotId:f},f)}),y.length>0&&y.map(n=>e.jsx(me,{event:n,machine:t,currentDate:o,queryClient:h},`event-${n.id}`))]})]})},(t,s)=>t.machine.id===s.machine.id&&t.machine.machine_name===s.machine.machine_name&&t.machine.work_center===s.machine.work_center&&t.scheduledEvents===s.scheduledEvents&&t.currentDate.getTime()===s.currentDate.getTime()&&t.unavailableByMachine===s.unavailableByMachine&&t.hideMachineLabel===s.hideMachineLabel&&t.queryClient===s.queryClient),ge=F.memo(({machines:t,currentDate:s,scheduledTasks:o})=>{const g=K(),{getSplitTaskInfo:r}=O(),a=d.useMemo(()=>{const n=ae(s,{weekStartsOn:ne.APP.FIRST_DAY_OF_WEEK}),u=[];for(let m=0;m<7;m++){const c=new Date(n);c.setUTCDate(n.getUTCDate()+m),u.push(c)}return u},[s]),h=d.useCallback((n,u)=>o.filter(m=>{if(m.scheduled_machine_id!==n||!m.scheduled_start_time)return!1;const c=r(m.id);if(c&&c.segments&&c.segments.length>0){const p=new Date(u+"T00:00:00Z"),f=new Date(p.getTime()+1440*60*1e3);return c.segments.some(i=>{const j=new Date(i.start),M=new Date(i.end);return j<f&&M>p})}else return T(new Date(m.scheduled_start_time),"yyyy-MM-dd")===u}),[o,r]),y=d.useCallback(n=>{g(`/backlog/${n.id}/edit`)},[g]),v=d.useCallback((n,u)=>h(n,u).length,[h]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),a.map(n=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:T(n,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:T(n,"yyyy-MM-dd")})]},n.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(n=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:n.machine_name}),e.jsx("div",{className:"machine-city",children:n.work_center})]}),a.map(u=>{const m=T(u,"yyyy-MM-dd"),c=h(n.id,m),p=v(n.id,m),f=u.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${f?"today":""} ${p>0?"has-tasks":""}`,children:c.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[p," task",p!==1?"s":""]}),c.slice(0,3).map(i=>e.jsxs("div",{className:"day-task-item",onClick:()=>y(i),title:`${i.odp_number} - ${i.article_code||"Codice articolo FLEXI"} - ${i.time_remaining?Number(i.time_remaining).toFixed(1):(i.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:i.odp_number}),e.jsxs("span",{className:"task-duration",children:[i.time_remaining?Number(i.time_remaining).toFixed(1):(i.duration||1).toFixed(1),"h"]})]},i.id)),c.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",c.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${n.id}-${m}`)})]},n.id))})]})}),pe=F.memo(({machines:t,currentDate:s,dropTargetId:o,onNavigateToNextDay:g,onNavigateToPreviousDay:r})=>{const[a,h]=d.useState("Daily"),{odpOrders:y}=te(),v=d.useMemo(()=>y.filter(i=>i.status==="SCHEDULED"),[y]),{loadMachineAvailabilityForDate:n,machineAvailability:u}=O(),m=se(),c=d.useMemo(()=>T(s,"yyyy-MM-dd"),[s]);d.useEffect(()=>(a==="Daily"&&!u[c]?._loading&&n(c),()=>{}),[c,n,a,u]);const p=d.useMemo(()=>{if(a!=="Daily")return{};const i=u[c];if(!Array.isArray(i)||i.length===0)return{};const j={};for(let M=0;M<i.length;M++){const L=i[M];L.machine_id&&L.unavailable_hours&&(j[L.machine_id]=new Set(L.unavailable_hours.map(W=>W.toString())))}return j},[u,c,a]),f=d.useMemo(()=>Array.from({length:16},(i,j)=>{const M=j+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${j*4+1} / span 4`},children:M.toString().padStart(2,"0")},M)}),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:a,onChange:i=>h(i.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsxs("div",{className:"gantt-date-navigation",children:[e.jsx("button",{className:"nav-btn secondary",onClick:()=>r&&r(),children:"<"}),e.jsx("span",{className:"current-date",children:T(s,"dd/MM/yyyy")}),e.jsx("button",{className:"nav-btn secondary",onClick:()=>g&&g(),children:">"})]}),e.jsx("div",{className:"gantt-scroll-container",children:e.jsx("div",{className:"calendar-grid-container",children:a==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header sticky-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(i=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:i.machine_name}),e.jsx("div",{className:"machine-city",children:i.work_center})]},i.id))})]}),e.jsx(de,{currentDate:s,onNavigateToPreviousDay:r,isDragOver:o==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row sticky-header",children:f}),e.jsx("div",{className:"time-grid-body",children:t.map(i=>e.jsx(he,{machine:i,scheduledEvents:v,currentDate:s,unavailableByMachine:p,dropTargetId:o,hideMachineLabel:!0,queryClient:m},i.id))})]}),e.jsx(ce,{currentDate:s,onNavigateToNextDay:g,isDragOver:o==="next-day-drop-zone"})]}):e.jsx(ge,{machines:t,currentDate:s,scheduledTasks:v})})})]})});export{pe as default};
