import{n as X,s as q,t as J,g as Z,r as c,f as z,b as G,j as e,R as O,a as ee,h as W,d as K,i as te,A as se,u as ae,e as ne}from"./index-DHTj7Clj.js";function R(t,n,a){const[u,v]=X(a?.in,t,n);return+q(u)==+q(v)}function ie(t,n){const a=J(t,n?.in);return a.setHours(23,59,59,999),a}function oe(t,n,a){return Z(t,-1,a)}const re=({currentDate:t,onNavigateToNextDay:n,isDragOver:a})=>{const[u,v]=c.useState(!1),[s,m]=c.useState(null),f=Z(t,1),h=z(f,"yyyy-MM-dd"),{setNodeRef:i}=G({id:"next-day-drop-zone",data:{type:"next-day",targetDate:f,currentDate:t}});c.useEffect(()=>{if(a&&!s){const r=setTimeout(()=>{n(),m(null)},1600);m(r)}else!a&&s&&(clearTimeout(s),m(null));return()=>{s&&clearTimeout(s)}},[a,n,s]);const d=c.useCallback(()=>{v(!0)},[]),l=c.useCallback(()=>{v(!1)},[]),x=c.useCallback(()=>{s&&(clearTimeout(s),m(null)),n()},[n,s]),g=a||u||s;return e.jsxs("div",{ref:i,className:`next-day-drop-zone ${g?"active":""}`,onMouseEnter:d,onMouseLeave:l,onClick:x,title:`Trascina qui per andare al giorno successivo (${h})`,children:[e.jsxs("div",{className:"next-day-content",children:[e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})}),e.jsxs("div",{className:"next-day-text",children:[e.jsx("div",{className:"next-day-label",children:"Giorno Successivo"}),e.jsx("div",{className:"next-day-date",children:h})]}),e.jsx("div",{className:"next-day-hint",children:s?"Navigazione in corso...":"Trascina qui per andare al giorno successivo"})]}),e.jsx("div",{className:"next-day-bg-effect"}),g&&e.jsx("div",{className:"next-day-pulse"})]})},le=({currentDate:t,onNavigateToPreviousDay:n,isDragOver:a})=>{const[u,v]=c.useState(!1),[s,m]=c.useState(null),f=oe(t),h=z(f,"yyyy-MM-dd"),{setNodeRef:i}=G({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:f,currentDate:t}});c.useEffect(()=>{if(a&&!s){const r=setTimeout(()=>{n(),m(null)},1600);m(r)}else!a&&s&&(clearTimeout(s),m(null));return()=>{s&&clearTimeout(s)}},[a,n,s]);const d=c.useCallback(()=>{v(!0)},[]),l=c.useCallback(()=>{v(!1)},[]),x=c.useCallback(()=>{s&&(clearTimeout(s),m(null)),n()},[n,s]),g=a||u||s;return e.jsxs("div",{ref:i,className:`previous-day-drop-zone ${g?"active":""}`,onMouseEnter:d,onMouseLeave:l,onClick:x,title:`Trascina qui per andare al giorno precedente (${h})`,children:[e.jsxs("div",{className:"previous-day-content",children:[e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})}),e.jsxs("div",{className:"previous-day-text",children:[e.jsx("div",{className:"previous-day-label",children:"Giorno Precedente"}),e.jsx("div",{className:"previous-day-date",children:h})]}),e.jsx("div",{className:"previous-day-hint",children:s?"Navigazione in corso...":"Trascina qui per andare al giorno precedente"})]}),e.jsx("div",{className:"previous-day-bg-effect"}),g&&e.jsx("div",{className:"previous-day-pulse"})]})},ce=O.memo(({machine:t,hour:n,minute:a,isUnavailable:u,hasScheduledTask:v,dropTargetId:s,slotId:m})=>{const{setNodeRef:f}=G({id:`slot-${t.id}-${n}-${a}`,data:{machine:t,hour:n,minute:a,type:"slot",isUnavailable:u,hasScheduledTask:v}}),h=`time-slot${u?" unavailable":""}${v?" has-scheduled-task":""}`,i=s===m;return e.jsx("div",{ref:f,className:h,"data-hour":n,"data-minute":a,"data-machine-id":t.id,style:{position:"relative"},children:i&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),de=O.memo(({event:t,machine:n,currentDate:a})=>{const[u,v]=c.useState(!0),s=K(),{getSplitTaskInfo:m,splitTasksInfo:f}=W(),{schedulingLoading:h}=ae(),{attributes:i,listeners:d,setNodeRef:l,transform:x,isDragging:g}=ne({id:`event-${t.id}`,data:{event:t,type:"event",machine:n},disabled:u}),r=c.useMemo(()=>{const b=m(t.id),k=q(a),o=ie(a);if(!b||!b.segments){if(console.warn(`‚ö†Ô∏è No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const I=new Date(t.scheduled_start_time),D=t.time_remaining||t.duration||1,_=new Date(I.getTime()+D*60*60*1e3),y={start:I,end:_},H=R(y.start,a),A=R(y.end,a),E=y.start<o&&y.end>k;if(!H&&!A&&!E)return null;let N,M;if(H&&A){const S=y.start.getUTCHours(),$=y.start.getUTCMinutes(),w=y.end.getUTCHours(),T=y.end.getUTCMinutes(),B=Math.max(6,S),V=Math.min(22,w),F=(B-6)*4+Math.floor($/15),Q=(V-6)*4+Math.ceil(T/15);N=F*15,M=(Q-F)*15}else if(H){const S=y.start.getUTCHours(),$=y.start.getUTCMinutes(),T=(Math.max(6,S)-6)*4+Math.floor($/15);N=T*15,M=(64-T)*15}else if(A){const S=y.end.getUTCHours(),$=y.end.getUTCMinutes(),T=(Math.min(22,S)-6)*4+Math.ceil($/15);N=0,M=T*15}else N=0,M=960;return[{left:N,width:M,start:y.start,end:y.end}]}const U=[];for(const I of b.segments){const D=new Date(I.start),_=new Date(I.end),y=R(D,a),H=R(_,a),A=D<o&&_>k;if(y||H||A){let E,N;if(y&&H){const M=D.getUTCHours(),S=D.getUTCMinutes(),$=_.getUTCHours(),w=_.getUTCMinutes(),T=Math.max(6,M),B=Math.min(22,$),V=(T-6)*4+Math.floor(S/15),F=(B-6)*4+Math.ceil(w/15);E=V*15,N=(F-V)*15}else if(y){const M=D.getUTCHours(),S=D.getUTCMinutes(),w=(Math.max(6,M)-6)*4+Math.floor(S/15);E=w*15,N=(64-w)*15}else if(H){const M=_.getUTCHours(),S=_.getUTCMinutes(),w=(Math.min(22,M)-6)*4+Math.ceil(S/15);E=0,N=w*15}else E=0,N=960;U.push({left:E,width:N,start:D,end:_})}}return U.length>0?U:null},[t.id,a,m,f]),p=r?r.reduce((b,k)=>b+k.width,0):0,j=p<60,C=p<120,L=j&&p<80,P=p<40,Y=c.useCallback(b=>{b.stopPropagation(),v(!u)},[u]);return!r||r.length===0?null:e.jsx(e.Fragment,{children:r.map((b,k)=>e.jsxs("div",{ref:k===0?l:void 0,style:{position:"absolute",left:`${b.left}px`,width:`${b.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${j?"very-small":""} ${C?"small":""} ${P?"extremely-narrow":""} ${r.length>1?"split-segment":""} ${h.taskId===t.id&&(h.isScheduling||h.isRescheduling||h.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,k===0&&(()=>{const o=m(t.id);return o&&o.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${o.totalSegments} segments`,children:"‚úÇÔ∏è"}):null})()]})}),k===0&&e.jsxs("div",{className:`event-controls ${L?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:o=>{o.stopPropagation(),o.preventDefault()},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?z(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantit√†: ${t.quantity||"Non specificata"}
Note Libere: ${t.user_notes||"Nessuna nota"}
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:o=>{o.stopPropagation(),o.preventDefault(),s(`/backlog/${t.id}/edit`)},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${u?"locked":"unlocked"}`,onClick:Y,title:u?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:u?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!u&&e.jsx("div",{className:"drag-handle",...d,...i,style:{transform:g?`translate3d(${x?.x||0}px, ${x?.y||0}px, 0)`:"none",zIndex:g?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!u&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async o=>{o.stopPropagation(),o.preventDefault();try{await W.getState().unscheduleTask(t.id)}catch(U){console.error("Error unscheduling task:",U)}},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"√ó"})})]})]},`${t.id}-segment-${k}`))})}),ue=O.memo(({machine:t,scheduledEvents:n,currentDate:a,unavailableByMachine:u,dropTargetId:v,hideMachineLabel:s=!1})=>{const m=c.useMemo(()=>n.filter(h=>h.scheduled_machine_id===t.id),[n,t.id]),f=u[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!s&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(h,i)=>{const d=Math.floor(i/4)+6,l=i%4*15,x=f?f.has(d.toString()):!1,g=`${t.id}-${d}-${l}`;return e.jsx(ce,{machine:t,hour:d,minute:l,isUnavailable:x,hasScheduledTask:!1,dropTargetId:v,slotId:g},g)}),m.length>0&&m.map(h=>e.jsx(de,{event:h,machine:t,currentDate:a},`event-${h.id}`))]})]})}),me=O.memo(({machines:t,currentDate:n,scheduledTasks:a})=>{const u=K(),{getTaskOccupiedSegments:v}=W(),s=c.useMemo(()=>{const i=te(n,{weekStartsOn:se.APP.FIRST_DAY_OF_WEEK}),d=[];for(let l=0;l<7;l++){const x=new Date(i);x.setUTCDate(i.getUTCDate()+l),d.push(x)}return d},[n]),m=c.useCallback((i,d)=>{const l=new Date(d+"T00:00:00.000Z"),x=new Date(l.getTime()+1440*60*1e3);return a.filter(g=>g.scheduled_machine_id!==i||!g.scheduled_start_time?!1:v(g).some(j=>{const C=new Date(j.start),L=new Date(j.end),P=C<x&&L>l;return P&&console.log(`üìÖ WEEKLY VIEW: Task ${g.odp_number} segment overlaps with ${d}:`,{segmentStart:C.toISOString(),segmentEnd:L.toISOString(),targetDate:l.toISOString(),nextDay:x.toISOString()}),P}))},[a,v]),f=c.useCallback(i=>{u(`/backlog/${i.id}/edit`)},[u]),h=c.useCallback((i,d)=>m(i,d).length,[m]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),s.map(i=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:z(i,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:z(i,"yyyy-MM-dd")})]},i.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(i=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:i.machine_name}),e.jsx("div",{className:"machine-city",children:i.work_center})]}),s.map(d=>{const l=z(d,"yyyy-MM-dd"),x=m(i.id,l),g=h(i.id,l),r=d.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${r?"today":""} ${g>0?"has-tasks":""}`,children:x.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[g," task",g!==1?"s":""]}),x.slice(0,3).map(p=>e.jsxs("div",{className:"day-task-item",onClick:()=>f(p),title:`${p.odp_number} - ${p.article_code||"Codice articolo FLEXI"} - ${p.time_remaining?Number(p.time_remaining).toFixed(1):(p.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:p.odp_number}),e.jsxs("span",{className:"task-duration",children:[p.time_remaining?Number(p.time_remaining).toFixed(1):(p.duration||1).toFixed(1),"h"]})]},p.id)),x.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",x.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${i.id}-${l}`)})]},i.id))})]})}),pe=O.memo(({machines:t,currentDate:n,dropTargetId:a,onNavigateToNextDay:u,onNavigateToPreviousDay:v})=>{const[s,m]=c.useState("Daily"),{odpOrders:f}=ee(),h=c.useMemo(()=>f.filter(r=>r.status==="SCHEDULED"),[f]),{loadMachineAvailabilityForDate:i,machineAvailability:d}=W(),l=c.useMemo(()=>z(n,"yyyy-MM-dd"),[n]);c.useEffect(()=>(s==="Daily"&&!d[l]?._loading&&i(l),()=>{}),[l,i,s,d]);const x=c.useMemo(()=>{if(s!=="Daily")return{};const r=d[l];if(!Array.isArray(r)||r.length===0)return{};const p={};for(let j=0;j<r.length;j++){const C=r[j];C.machine_id&&C.unavailable_hours&&(p[C.machine_id]=new Set(C.unavailable_hours.map(L=>L.toString())))}return p},[d,l,s]),g=c.useMemo(()=>Array.from({length:16},(r,p)=>{const j=p+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${p*4+1} / span 4`},children:j.toString().padStart(2,"0")},j)}),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:s,onChange:r=>m(r.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:s==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(r=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:r.machine_name}),e.jsx("div",{className:"machine-city",children:r.work_center})]},r.id))})]}),e.jsx(le,{currentDate:n,onNavigateToPreviousDay:v,isDragOver:a==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row",children:g}),e.jsx("div",{className:"time-grid-body",children:t.map(r=>e.jsx(ue,{machine:r,scheduledEvents:h,currentDate:n,unavailableByMachine:x,dropTargetId:a,hideMachineLabel:!0},r.id))})]}),e.jsx(re,{currentDate:n,onNavigateToNextDay:u,isDragOver:a==="next-day-drop-zone"})]}):e.jsx(me,{machines:t,currentDate:n,scheduledTasks:h})})]})});export{pe as default};
