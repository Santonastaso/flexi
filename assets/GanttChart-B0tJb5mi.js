import{n as X,s as q,t as J,g as K,r,f as I,b as Z,j as e,R as V,a as ee,h as W,d as Y,i as te,A as se,u as ae,e as ne}from"./index-CJPhNWzd.js";function B(t,i,a){const[d,x]=X(a?.in,t,i);return+q(d)==+q(x)}function ie(t,i){const a=J(t,i?.in);return a.setHours(23,59,59,999),a}function oe(t,i,a){return K(t,-1,a)}const re=({currentDate:t,onNavigateToNextDay:i,isDragOver:a})=>{const[d,x]=r.useState(!1),[s,u]=r.useState(null),f=K(t,1),h=I(f,"yyyy-MM-dd"),{setNodeRef:o}=Z({id:"next-day-drop-zone",data:{type:"next-day",targetDate:f,currentDate:t}});r.useEffect(()=>{if(a&&!s){const j=setTimeout(()=>{i(),u(null)},1600);u(j)}else!a&&s&&(clearTimeout(s),u(null));return()=>{s&&clearTimeout(s)}},[a,i,s]);const p=r.useCallback(()=>{x(!0)},[]),g=r.useCallback(()=>{x(!1)},[]),m=r.useCallback(()=>{s&&(clearTimeout(s),u(null)),i()},[i,s]),l=a||d||s;return e.jsxs("div",{ref:o,className:`next-day-drop-zone ${l?"active":""}`,onMouseEnter:p,onMouseLeave:g,onClick:m,title:`Trascina qui per andare al giorno successivo (${h})`,children:[e.jsxs("div",{className:"next-day-content",children:[e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})}),e.jsxs("div",{className:"next-day-text",children:[e.jsx("div",{className:"next-day-label",children:"Giorno Successivo"}),e.jsx("div",{className:"next-day-date",children:h})]}),e.jsx("div",{className:"next-day-hint",children:s?"Navigazione in corso...":"Trascina qui per andare al giorno successivo"})]}),e.jsx("div",{className:"next-day-bg-effect"}),l&&e.jsx("div",{className:"next-day-pulse"})]})},le=({currentDate:t,onNavigateToPreviousDay:i,isDragOver:a})=>{const[d,x]=r.useState(!1),[s,u]=r.useState(null),f=oe(t),h=I(f,"yyyy-MM-dd"),{setNodeRef:o}=Z({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:f,currentDate:t}});r.useEffect(()=>{if(a&&!s){const j=setTimeout(()=>{i(),u(null)},1600);u(j)}else!a&&s&&(clearTimeout(s),u(null));return()=>{s&&clearTimeout(s)}},[a,i,s]);const p=r.useCallback(()=>{x(!0)},[]),g=r.useCallback(()=>{x(!1)},[]),m=r.useCallback(()=>{s&&(clearTimeout(s),u(null)),i()},[i,s]),l=a||d||s;return e.jsxs("div",{ref:o,className:`previous-day-drop-zone ${l?"active":""}`,onMouseEnter:p,onMouseLeave:g,onClick:m,title:`Trascina qui per andare al giorno precedente (${h})`,children:[e.jsxs("div",{className:"previous-day-content",children:[e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})}),e.jsxs("div",{className:"previous-day-text",children:[e.jsx("div",{className:"previous-day-label",children:"Giorno Precedente"}),e.jsx("div",{className:"previous-day-date",children:h})]}),e.jsx("div",{className:"previous-day-hint",children:s?"Navigazione in corso...":"Trascina qui per andare al giorno precedente"})]}),e.jsx("div",{className:"previous-day-bg-effect"}),l&&e.jsx("div",{className:"previous-day-pulse"})]})},ce=V.memo(({machine:t,hour:i,minute:a,isUnavailable:d,hasScheduledTask:x,dropTargetId:s,slotId:u})=>{const{setNodeRef:f}=Z({id:`slot-${t.id}-${i}-${a}`,data:{machine:t,hour:i,minute:a,type:"slot",isUnavailable:d,hasScheduledTask:x}}),h=`time-slot${d?" unavailable":""}${x?" has-scheduled-task":""}`,o=s===u;return e.jsx("div",{ref:f,className:h,"data-hour":i,"data-minute":a,"data-machine-id":t.id,style:{position:"relative"},children:o&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),de=V.memo(({event:t,machine:i,currentDate:a})=>{const[d,x]=r.useState(!0),s=Y(),{getSplitTaskInfo:u,splitTasksInfo:f}=W(),{schedulingLoading:h}=ae(),{attributes:o,listeners:p,setNodeRef:g,transform:m,isDragging:l}=ne({id:`event-${t.id}`,data:{event:t,type:"event",machine:i},disabled:d}),j=r.useMemo(()=>{const S=u(t.id),w=q(a),n=ie(a);if(!S||!S.segments){if(console.warn(`‚ö†Ô∏è No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const P=new Date(t.scheduled_start_time),$=t.time_remaining||t.duration||1,T=new Date(P.getTime()+$*60*60*1e3),y={start:P,end:T},z=B(y.start,a),O=B(y.end,a),L=y.start<n&&y.end>w;if(!z&&!O&&!L)return null;let C,_;if(z&&O){const D=y.start.getUTCHours(),H=y.start.getUTCMinutes(),k=y.end.getUTCHours(),E=y.end.getUTCMinutes(),G=Math.max(6,D),F=Math.min(22,k),R=(G-6)*4+Math.floor(H/15),Q=(F-6)*4+Math.ceil(E/15);C=R*15,_=(Q-R)*15}else if(z){const D=y.start.getUTCHours(),H=y.start.getUTCMinutes(),E=(Math.max(6,D)-6)*4+Math.floor(H/15);C=E*15,_=(64-E)*15}else if(O){const D=y.end.getUTCHours(),H=y.end.getUTCMinutes(),E=(Math.min(22,D)-6)*4+Math.ceil(H/15);C=0,_=E*15}else C=0,_=960;return[{left:C,width:_,start:y.start,end:y.end}]}const U=[];for(const P of S.segments){const $=new Date(P.start),T=new Date(P.end),y=B($,a),z=B(T,a),O=$<n&&T>w;if(y||z||O){let L,C;if(y&&z){const _=$.getUTCHours(),D=$.getUTCMinutes(),H=T.getUTCHours(),k=T.getUTCMinutes(),E=Math.max(6,_),G=Math.min(22,H),F=(E-6)*4+Math.floor(D/15),R=(G-6)*4+Math.ceil(k/15);L=F*15,C=(R-F)*15}else if(y){const _=$.getUTCHours(),D=$.getUTCMinutes(),k=(Math.max(6,_)-6)*4+Math.floor(D/15);L=k*15,C=(64-k)*15}else if(z){const _=T.getUTCHours(),D=T.getUTCMinutes(),k=(Math.min(22,_)-6)*4+Math.ceil(D/15);L=0,C=k*15}else L=0,C=960;U.push({left:L,width:C,start:$,end:T})}}return U.length>0?U:null},[t.id,a,u,f]),v=j?j.reduce((S,w)=>S+w.width,0):0,c=v<60,M=v<120,N=c&&v<80,b=v<40,A=r.useCallback(S=>{S.stopPropagation(),x(!d)},[d]);return!j||j.length===0?null:e.jsx(e.Fragment,{children:j.map((S,w)=>e.jsxs("div",{ref:w===0?g:void 0,style:{position:"absolute",left:`${S.left}px`,width:`${S.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${c?"very-small":""} ${M?"small":""} ${b?"extremely-narrow":""} ${j.length>1?"split-segment":""} ${h.taskId===t.id&&(h.isScheduling||h.isRescheduling||h.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,w===0&&(()=>{const n=u(t.id);return n&&n.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${n.totalSegments} segments`,children:"‚úÇÔ∏è"}):null})()]})}),w===0&&e.jsxs("div",{className:`event-controls ${N?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:n=>{n.stopPropagation(),n.preventDefault()},onMouseDown:n=>{n.stopPropagation(),n.preventDefault()},onPointerDown:n=>{n.stopPropagation(),n.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?I(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantit√†: ${t.quantity||"Non specificata"}
Altezza Busta: ${t.bag_height||"Non specificata"} mm
Passo Busta: ${t.bag_step||"Non specificato"} mm
Note Libere: ${t.user_notes||"Nessuna nota"}
Note ASD: ${t.asd_notes||"Nessuna nota"}
Material Global: ${t.material_availability_global||"N/A"}%
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:n=>{n.stopPropagation(),n.preventDefault(),s(`/backlog/${t.id}/edit`)},onMouseDown:n=>{n.stopPropagation(),n.preventDefault()},onPointerDown:n=>{n.stopPropagation(),n.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${d?"locked":"unlocked"}`,onClick:A,title:d?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:d?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!d&&e.jsx("div",{className:"drag-handle",...p,...o,style:{transform:l?`translate3d(${m?.x||0}px, ${m?.y||0}px, 0)`:"none",zIndex:l?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!d&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async n=>{n.stopPropagation(),n.preventDefault();try{await W.getState().unscheduleTask(t.id)}catch(U){console.error("Error unscheduling task:",U)}},onMouseDown:n=>{n.stopPropagation(),n.preventDefault()},onPointerDown:n=>{n.stopPropagation(),n.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"√ó"})})]})]},`${t.id}-segment-${w}`))})}),ue=V.memo(({machine:t,scheduledEvents:i,currentDate:a,unavailableByMachine:d,dropTargetId:x,hideMachineLabel:s=!1})=>{const u=r.useMemo(()=>i.filter(h=>h.scheduled_machine_id===t.id),[i,t.id]),f=d[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!s&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(h,o)=>{const p=Math.floor(o/4)+6,g=o%4*15,m=f?f.has(p.toString()):!1,l=`${t.id}-${p}-${g}`;return e.jsx(ce,{machine:t,hour:p,minute:g,isUnavailable:m,hasScheduledTask:!1,dropTargetId:x,slotId:l},l)}),u.length>0&&u.map(h=>e.jsx(de,{event:h,machine:t,currentDate:a},`event-${h.id}`))]})]})}),me=V.memo(({machines:t,currentDate:i,scheduledTasks:a})=>{const d=Y(),{getTaskOccupiedSegments:x}=W(),s=r.useMemo(()=>{const o=te(i,{weekStartsOn:se.APP.FIRST_DAY_OF_WEEK}),p=[];for(let g=0;g<7;g++){const m=new Date(o);m.setUTCDate(o.getUTCDate()+g),p.push(m)}return p},[i]),u=r.useCallback((o,p)=>{const g=new Date(p+"T00:00:00.000Z"),m=new Date(g.getTime()+1440*60*1e3);return a.filter(l=>l.scheduled_machine_id!==o||!l.scheduled_start_time?!1:x(l).some(c=>{const M=new Date(c.start),N=new Date(c.end),b=M<m&&N>g;return b&&console.log(`üìÖ WEEKLY VIEW: Task ${l.odp_number} segment overlaps with ${p}:`,{segmentStart:M.toISOString(),segmentEnd:N.toISOString(),targetDate:g.toISOString(),nextDay:m.toISOString()}),b}))},[a,x]),f=r.useCallback(o=>{d(`/backlog/${o.id}/edit`)},[d]),h=r.useCallback((o,p)=>u(o,p).length,[u]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),s.map(o=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:I(o,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:I(o,"yyyy-MM-dd")})]},o.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(o=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:o.machine_name}),e.jsx("div",{className:"machine-city",children:o.work_center})]}),s.map(p=>{const g=I(p,"yyyy-MM-dd"),m=u(o.id,g),l=h(o.id,g),j=p.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${j?"today":""} ${l>0?"has-tasks":""}`,children:m.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[l," task",l!==1?"s":""]}),m.slice(0,3).map(v=>e.jsxs("div",{className:"day-task-item",onClick:()=>f(v),title:`${v.odp_number} - ${v.article_code||"Codice articolo FLEXI"} - ${v.time_remaining?Number(v.time_remaining).toFixed(1):(v.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:v.odp_number}),e.jsxs("span",{className:"task-duration",children:[v.time_remaining?Number(v.time_remaining).toFixed(1):(v.duration||1).toFixed(1),"h"]})]},v.id)),m.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",m.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${o.id}-${g}`)})]},o.id))})]})}),pe=V.memo(({machines:t,currentDate:i,dropTargetId:a,onNavigateToNextDay:d,onNavigateToPreviousDay:x})=>{const[s,u]=r.useState("Daily"),[f,h]=r.useState(null),{odpOrders:o}=ee(),p=r.useMemo(()=>o.filter(c=>c.status==="SCHEDULED"),[o]),{loadMachineAvailabilityForDate:g,machineAvailability:m}=W(),l=r.useMemo(()=>I(i,"yyyy-MM-dd"),[i]);r.useEffect(()=>(s==="Daily"&&!m[l]?._loading&&g(l),()=>{}),[l,g,s,m]),r.useEffect(()=>{const c=()=>{const N=new Date,b=N.getHours(),A=N.getMinutes();if(b>=6&&b<22){const S=(b-6)*4+Math.floor(A/15),w=A%15/15,n=S*15+w*15;h(n)}else h(null)};c();const M=setInterval(c,6e4);return()=>clearInterval(M)},[]);const j=r.useMemo(()=>{if(s!=="Daily")return{};const c=m[l];if(!Array.isArray(c)||c.length===0)return{};const M={};for(let N=0;N<c.length;N++){const b=c[N];b.machine_id&&b.unavailable_hours&&(M[b.machine_id]=new Set(b.unavailable_hours.map(A=>A.toString())))}return M},[m,l,s]),v=r.useMemo(()=>Array.from({length:16},(c,M)=>{const N=M+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${M*4+1} / span 4`},children:N.toString().padStart(2,"0")},N)}),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:s,onChange:c=>u(c.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:s==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(c=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:c.machine_name}),e.jsx("div",{className:"machine-city",children:c.work_center})]},c.id))})]}),e.jsx(le,{currentDate:i,onNavigateToPreviousDay:x,isDragOver:a==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row",children:v}),e.jsxs("div",{className:"time-grid-body",style:{position:"relative"},children:[t.map(c=>e.jsx(ue,{machine:c,scheduledEvents:p,currentDate:i,unavailableByMachine:j,dropTargetId:a,hideMachineLabel:!0},c.id)),f!==null&&e.jsx("div",{style:{position:"absolute",left:`${f}px`,top:0,bottom:0,width:"2px",backgroundColor:"#ef4444",zIndex:100,pointerEvents:"none"}})]})]}),e.jsx(re,{currentDate:i,onNavigateToNextDay:d,isDragOver:a==="next-day-drop-zone"})]}):e.jsx(me,{machines:t,currentDate:i,scheduledTasks:p})})]})});export{pe as default};
