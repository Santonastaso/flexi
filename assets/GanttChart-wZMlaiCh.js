import{n as oe,s as X,t as re,i as ae,r as h,h as T,c as J,j as e,R as V,b as le,k as ce,l as de,B as te,S as ue,m as me,o as he,p as ge,q as se,u as ne,v as Y,w as pe,A as ye,a as xe,g as fe}from"./index-CJ_H5D4p.js";function B(t,s,a){const[x,l]=oe(a?.in,t,s);return+X(x)==+X(l)}function ve(t,s){const a=re(t,s?.in);return a.setHours(23,59,59,999),a}function je(t,s,a){return ae(t,-1,a)}const Me=({currentDate:t,onNavigateToNextDay:s,isDragOver:a})=>{const[x,l]=h.useState(!1),[i,c]=h.useState(null),g=ae(t,1),v=T(g,"yyyy-MM-dd"),{setNodeRef:n}=J({id:"next-day-drop-zone",data:{type:"next-day",targetDate:g,currentDate:t}});h.useEffect(()=>{if(a&&!i){const j=setTimeout(()=>{s(),c(null)},1600);c(j)}else!a&&i&&(clearTimeout(i),c(null));return()=>{i&&clearTimeout(i)}},[a,s,i]);const d=h.useCallback(()=>{l(!0)},[]),u=h.useCallback(()=>{l(!1)},[]),r=h.useCallback(()=>{i&&(clearTimeout(i),c(null)),s()},[s,i]),p=a||x||i;return e.jsxs("div",{ref:n,className:`next-day-drop-zone ${p?"active":""}`,onMouseEnter:d,onMouseLeave:u,onClick:r,title:`Trascina qui per andare al giorno successivo (${v})`,children:[e.jsx("div",{className:"next-day-content",children:e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})})}),e.jsx("div",{className:"next-day-bg-effect"}),p&&e.jsx("div",{className:"next-day-pulse"})]})},be=({currentDate:t,onNavigateToPreviousDay:s,isDragOver:a})=>{const[x,l]=h.useState(!1),[i,c]=h.useState(null),g=je(t),v=T(g,"yyyy-MM-dd"),{setNodeRef:n}=J({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:g,currentDate:t}});h.useEffect(()=>{if(a&&!i){const j=setTimeout(()=>{s(),c(null)},1600);c(j)}else!a&&i&&(clearTimeout(i),c(null));return()=>{i&&clearTimeout(i)}},[a,s,i]);const d=h.useCallback(()=>{l(!0)},[]),u=h.useCallback(()=>{l(!1)},[]),r=h.useCallback(()=>{i&&(clearTimeout(i),c(null)),s()},[s,i]),p=a||x||i;return e.jsxs("div",{ref:n,className:`previous-day-drop-zone ${p?"active":""}`,onMouseEnter:d,onMouseLeave:u,onClick:r,title:`Trascina qui per andare al giorno precedente (${v})`,children:[e.jsx("div",{className:"previous-day-content",children:e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})})}),e.jsx("div",{className:"previous-day-bg-effect"}),p&&e.jsx("div",{className:"previous-day-pulse"})]})},Ne=V.memo(({machine:t,hour:s,minute:a,isUnavailable:x,hasScheduledTask:l,dropTargetId:i,slotId:c,dragPreview:g})=>{const{setNodeRef:v}=J({id:`slot-${t.id}-${s}-${a}`,data:{machine:t,hour:s,minute:a,type:"slot",isUnavailable:x,hasScheduledTask:l}}),n=`time-slot${x?" unavailable":""}${l?" has-scheduled-task":""}`,d=i===c,u=(s-6)*4+Math.floor(a/15),r=g?.isActive&&g.machineId===t.id&&u>=g.startSlot&&u<g.startSlot+g.durationSlots;return e.jsxs("div",{ref:v,className:n,"data-hour":s,"data-minute":a,"data-machine-id":t.id,style:{position:"relative"},children:[d&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}}),r&&e.jsx("div",{className:"drag-preview-indicator",style:{position:"absolute",top:"0px",left:"0px",right:"0px",bottom:"0px",background:"rgba(59, 130, 246, 0.3)",border:"2px solid #3b82f6",pointerEvents:"none",zIndex:999,borderRadius:"2px"}})]})}),Se=V.memo(({event:t,machine:s,currentDate:a,queryClient:x})=>{const[l,i]=h.useState(!0),c=ne(),{getSplitTaskInfo:g,splitTasksInfo:v}=Y(),{schedulingLoading:n}=xe(),{attributes:d,listeners:u,setNodeRef:r,transform:p,isDragging:j}=fe({id:`event-${t.id}`,data:{event:t,type:"event",machine:s},disabled:l}),m=h.useMemo(()=>{const M=g(t.id),D=X(a),o=ve(a),O=t.duration||1,P=t.progress||0,ee=O*(P/100);if(!M||!M.segments){if(console.warn(`⚠️ No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const I=new Date(t.scheduled_start_time),k=t.time_remaining||t.duration||1,$=new Date(I.getTime()+k*60*60*1e3),y={start:I,end:$},z=B(y.start,a),L=B(y.end,a),G=y.start<o&&y.end>D;if(!z&&!L&&!G)return null;let S,C;if(z&&L){const N=y.start.getUTCHours(),w=y.start.getUTCMinutes(),A=y.end.getUTCHours(),b=y.end.getUTCMinutes(),Z=Math.max(6,N),Q=Math.min(22,A),U=(Z-6)*4+Math.floor(w/15),K=(Q-6)*4+Math.ceil(b/15);S=U*15,C=(K-U)*15}else if(z){const N=y.start.getUTCHours(),w=y.start.getUTCMinutes(),b=(Math.max(6,N)-6)*4+Math.floor(w/15);S=b*15,C=(64-b)*15}else if(L){const N=y.end.getUTCHours(),w=y.end.getUTCMinutes(),b=(Math.min(22,N)-6)*4+Math.ceil(w/15);S=0,C=b*15}else S=0,C=960;const R=P;return[{left:S,width:C,start:y.start,end:y.end,progress:R,duration:k}]}const W=[];let q=0;for(const I of M.segments){const k=new Date(I.start),$=new Date(I.end),y=I.duration||0,z=B(k,a),L=B($,a),G=k<o&&$>D;if(z||L||G){let S,C;if(z&&L){const N=k.getUTCHours(),w=k.getUTCMinutes(),A=$.getUTCHours(),b=$.getUTCMinutes(),Z=Math.max(6,N),Q=Math.min(22,A),U=(Z-6)*4+Math.floor(w/15),K=(Q-6)*4+Math.ceil(b/15);S=U*15,C=(K-U)*15}else if(z){const N=k.getUTCHours(),w=k.getUTCMinutes(),b=(Math.max(6,N)-6)*4+Math.floor(w/15);S=b*15,C=(64-b)*15}else if(L){const N=$.getUTCHours(),w=$.getUTCMinutes(),b=(Math.min(22,N)-6)*4+Math.ceil(w/15);S=0,C=b*15}else S=0,C=960;let R=0;ee>q&&(R=Math.min(y,ee-q)/y*100),W.push({left:S,width:C,start:k,end:$,progress:R,duration:y}),q+=y}}return W.length>0?W:null},[t.id,a,g,v]),H=m?m.reduce((M,D)=>M+D.width,0):0,f=H<60,E=H<120,_=f&&H<80,F=H<40,ie=h.useCallback(M=>{M.stopPropagation(),i(!l)},[l]);return!m||m.length===0?null:e.jsx(e.Fragment,{children:m.map((M,D)=>e.jsxs("div",{ref:D===0?r:void 0,style:{position:"absolute",left:`${M.left}px`,width:`${M.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${f?"very-small":""} ${E?"small":""} ${F?"extremely-narrow":""} ${m.length>1?"split-segment":""} ${n.taskId===t.id&&(n.isScheduling||n.isRescheduling||n.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,D===0&&(()=>{const o=g(t.id);return o&&o.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${o.totalSegments} segments`,children:"✂️"}):null})()]})}),M.progress&&M.progress>0&&e.jsx("div",{className:"progress-bar-overlay",style:{width:`${Math.min(M.progress,100)}%`}}),D===0&&e.jsxs("div",{className:`event-controls ${_?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:o=>{o.stopPropagation(),o.preventDefault()},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?T(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
Note Libere: ${t.user_notes||"Nessuna nota"}
Note ASD: ${t.asd_notes||"Nessuna nota"}
Material Global: ${t.material_availability_global||"N/A"}%
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:o=>{o.stopPropagation(),o.preventDefault(),c(`/backlog/${t.id}/edit`)},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${l?"locked":"unlocked"}`,onClick:ie,title:l?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:l?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!l&&e.jsx("div",{className:"drag-handle",...u,...d,style:{transform:j?`translate3d(${p?.x||0}px, ${p?.y||0}px, 0)`:"none",zIndex:j?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!l&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async o=>{o.stopPropagation(),o.preventDefault();try{await Y.getState().unscheduleTask(t.id,x)}catch(O){console.error("Error unscheduling task:",O)}},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${D}`))})}),Ce=V.memo(({machine:t,scheduledEvents:s,currentDate:a,unavailableByMachine:x,dropTargetId:l,hideMachineLabel:i=!1,queryClient:c,dragPreview:g})=>{const v=h.useMemo(()=>s.filter(d=>d.scheduled_machine_id===t.id),[s,t.id]),n=x[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!i&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(d,u)=>{const r=Math.floor(u/4)+6,p=u%4*15,j=n?n.has(r.toString()):!1,m=`${t.id}-${r}-${p}`;return e.jsx(Ne,{machine:t,hour:r,minute:p,isUnavailable:j,hasScheduledTask:!1,dropTargetId:l,slotId:m,dragPreview:g},m)}),v.length>0&&v.map(d=>e.jsx(Se,{event:d,machine:t,currentDate:a,queryClient:c},`event-${d.id}`))]})]})},(t,s)=>t.machine.id===s.machine.id&&t.machine.machine_name===s.machine.machine_name&&t.machine.work_center===s.machine.work_center&&t.scheduledEvents===s.scheduledEvents&&t.currentDate.getTime()===s.currentDate.getTime()&&t.unavailableByMachine===s.unavailableByMachine&&t.hideMachineLabel===s.hideMachineLabel&&t.queryClient===s.queryClient&&t.dragPreview===s.dragPreview),we=V.memo(({machines:t,currentDate:s,scheduledTasks:a})=>{const x=ne(),{getSplitTaskInfo:l}=Y(),i=h.useMemo(()=>{const n=pe(s,{weekStartsOn:ye.APP.FIRST_DAY_OF_WEEK}),d=[];for(let u=0;u<7;u++){const r=new Date(n);r.setUTCDate(n.getUTCDate()+u),d.push(r)}return d},[s]),c=h.useCallback((n,d)=>a.filter(u=>{if(u.scheduled_machine_id!==n||!u.scheduled_start_time)return!1;const r=l(u.id);if(r&&r.segments&&r.segments.length>0){const p=new Date(d+"T00:00:00Z"),j=new Date(p.getTime()+1440*60*1e3);return r.segments.some(m=>{const H=new Date(m.start),f=new Date(m.end);return H<j&&f>p})}else return T(new Date(u.scheduled_start_time),"yyyy-MM-dd")===d}),[a,l]),g=h.useCallback(n=>{x(`/backlog/${n.id}/edit`)},[x]),v=h.useCallback((n,d)=>c(n,d).length,[c]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),i.map(n=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:T(n,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:T(n,"yyyy-MM-dd")})]},n.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(n=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:n.machine_name}),e.jsx("div",{className:"machine-city",children:n.work_center})]}),i.map(d=>{const u=T(d,"yyyy-MM-dd"),r=c(n.id,u),p=v(n.id,u),j=d.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${j?"today":""} ${p>0?"has-tasks":""}`,children:r.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[p," task",p!==1?"s":""]}),r.slice(0,3).map(m=>e.jsxs("div",{className:"day-task-item",onClick:()=>g(m),title:`${m.odp_number} - ${m.article_code||"Codice articolo FLEXI"} - ${m.time_remaining?Number(m.time_remaining).toFixed(1):(m.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:m.odp_number}),e.jsxs("span",{className:"task-duration",children:[m.time_remaining?Number(m.time_remaining).toFixed(1):(m.duration||1).toFixed(1),"h"]})]},m.id)),r.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",r.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${n.id}-${u}`)})]},n.id))})]})}),_e=V.memo(({machines:t,currentDate:s,dropTargetId:a,dragPreview:x,onNavigateToNextDay:l,onNavigateToPreviousDay:i})=>{const[c,g]=h.useState("Daily"),{odpOrders:v}=le(),n=h.useMemo(()=>v.filter(f=>f.status==="SCHEDULED"),[v]),d=ce(),u=h.useMemo(()=>T(s,"yyyy-MM-dd"),[s]),{data:r=[],isLoading:p,error:j}=de(u),m=h.useMemo(()=>{if(c!=="Daily")return{};if(!Array.isArray(r)||r.length===0)return{};const f={};for(let E=0;E<r.length;E++){const _=r[E];_.machine_id&&_.unavailable_hours&&(f[_.machine_id]=new Set(_.unavailable_hours.map(F=>F.toString())))}return f},[r,c]),H=h.useMemo(()=>Array.from({length:16},(f,E)=>{const _=E+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${E*4+1} / span 4`},children:_.toString().padStart(2,"0")},_)}),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsx("div",{className:"calendar-section",children:e.jsxs("div",{className:"gantt-chart-wrapper",children:[e.jsxs("div",{className:"gantt-controls-bar",children:[e.jsxs("div",{className:"gantt-date-navigation",children:[e.jsx(te,{variant:"secondary",size:"sm",onClick:()=>i&&i(c),children:"<"}),e.jsx("span",{className:"current-date",children:T(s,"dd/MM/yyyy")}),e.jsx(te,{variant:"secondary",size:"sm",onClick:()=>l&&l(c),children:">"})]}),e.jsx("div",{className:"gantt-view-selector",children:e.jsxs(ue,{value:c,onValueChange:g,children:[e.jsx(me,{className:"view-selector",children:e.jsx(he,{})}),e.jsxs(ge,{children:[e.jsx(se,{value:"Daily",children:"Vista Giornaliera"}),e.jsx(se,{value:"Weekly",children:"Vista Settimanale"})]})]})})]}),e.jsx("div",{className:"gantt-scroll-container",children:e.jsx("div",{className:"calendar-grid-container",children:c==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header sticky-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(f=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:f.machine_name}),e.jsx("div",{className:"machine-city",children:f.work_center})]},f.id))})]}),e.jsx(be,{currentDate:s,onNavigateToPreviousDay:()=>i&&i(c),isDragOver:a==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row sticky-header",children:H}),e.jsx("div",{className:"time-grid-body",children:t.map(f=>e.jsx(Ce,{machine:f,scheduledEvents:n,currentDate:s,unavailableByMachine:m,dropTargetId:a,hideMachineLabel:!0,queryClient:d,dragPreview:x},f.id))})]}),e.jsx(Me,{currentDate:s,onNavigateToNextDay:()=>l&&l(c),isDragOver:a==="next-day-drop-zone"})]}):e.jsx(we,{machines:t,currentDate:s,scheduledTasks:n})})})]})})});export{_e as default};
