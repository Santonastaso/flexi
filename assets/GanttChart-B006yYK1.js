import{n as J,s as W,t as ee,g as Q,r as d,f as H,b as G,j as e,R as I,a as te,h as q,i as se,d as Z,k as ae,A as ne,u as ie,e as oe}from"./index-C4cgJIS8.js";function V(t,i,a){const[v,l]=J(a?.in,t,i);return+W(v)==+W(l)}function re(t,i){const a=ee(t,i?.in);return a.setHours(23,59,59,999),a}function le(t,i,a){return Q(t,-1,a)}const de=({currentDate:t,onNavigateToNextDay:i,isDragOver:a})=>{const[v,l]=d.useState(!1),[s,h]=d.useState(null),p=Q(t,1),n=H(p,"yyyy-MM-dd"),{setNodeRef:r}=G({id:"next-day-drop-zone",data:{type:"next-day",targetDate:p,currentDate:t}});d.useEffect(()=>{if(a&&!s){const u=setTimeout(()=>{i(),h(null)},1600);h(u)}else!a&&s&&(clearTimeout(s),h(null));return()=>{s&&clearTimeout(s)}},[a,i,s]);const c=d.useCallback(()=>{l(!0)},[]),g=d.useCallback(()=>{l(!1)},[]),x=d.useCallback(()=>{s&&(clearTimeout(s),h(null)),i()},[i,s]),f=a||v||s;return e.jsxs("div",{ref:r,className:`next-day-drop-zone ${f?"active":""}`,onMouseEnter:c,onMouseLeave:g,onClick:x,title:`Trascina qui per andare al giorno successivo (${n})`,children:[e.jsxs("div",{className:"next-day-content",children:[e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})}),e.jsxs("div",{className:"next-day-text",children:[e.jsx("div",{className:"next-day-label",children:"Giorno Successivo"}),e.jsx("div",{className:"next-day-date",children:n})]}),e.jsx("div",{className:"next-day-hint",children:s?"Navigazione in corso...":"Trascina qui per andare al giorno successivo"})]}),e.jsx("div",{className:"next-day-bg-effect"}),f&&e.jsx("div",{className:"next-day-pulse"})]})},ce=({currentDate:t,onNavigateToPreviousDay:i,isDragOver:a})=>{const[v,l]=d.useState(!1),[s,h]=d.useState(null),p=le(t),n=H(p,"yyyy-MM-dd"),{setNodeRef:r}=G({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:p,currentDate:t}});d.useEffect(()=>{if(a&&!s){const u=setTimeout(()=>{i(),h(null)},1600);h(u)}else!a&&s&&(clearTimeout(s),h(null));return()=>{s&&clearTimeout(s)}},[a,i,s]);const c=d.useCallback(()=>{l(!0)},[]),g=d.useCallback(()=>{l(!1)},[]),x=d.useCallback(()=>{s&&(clearTimeout(s),h(null)),i()},[i,s]),f=a||v||s;return e.jsxs("div",{ref:r,className:`previous-day-drop-zone ${f?"active":""}`,onMouseEnter:c,onMouseLeave:g,onClick:x,title:`Trascina qui per andare al giorno precedente (${n})`,children:[e.jsxs("div",{className:"previous-day-content",children:[e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})}),e.jsxs("div",{className:"previous-day-text",children:[e.jsx("div",{className:"previous-day-label",children:"Giorno Precedente"}),e.jsx("div",{className:"previous-day-date",children:n})]}),e.jsx("div",{className:"previous-day-hint",children:s?"Navigazione in corso...":"Trascina qui per andare al giorno precedente"})]}),e.jsx("div",{className:"previous-day-bg-effect"}),f&&e.jsx("div",{className:"previous-day-pulse"})]})},ue=I.memo(({machine:t,hour:i,minute:a,isUnavailable:v,hasScheduledTask:l,dropTargetId:s,slotId:h})=>{const{setNodeRef:p}=G({id:`slot-${t.id}-${i}-${a}`,data:{machine:t,hour:i,minute:a,type:"slot",isUnavailable:v,hasScheduledTask:l}}),n=`time-slot${v?" unavailable":""}${l?" has-scheduled-task":""}`,r=s===h;return e.jsx("div",{ref:p,className:n,"data-hour":i,"data-minute":a,"data-machine-id":t.id,style:{position:"relative"},children:r&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),me=I.memo(({event:t,machine:i,currentDate:a,queryClient:v})=>{const[l,s]=d.useState(!0),h=Z(),{getSplitTaskInfo:p,splitTasksInfo:n}=q(),{schedulingLoading:r}=ie(),{attributes:c,listeners:g,setNodeRef:x,transform:f,isDragging:u}=oe({id:`event-${t.id}`,data:{event:t,type:"event",machine:i},disabled:l}),m=d.useMemo(()=>{const S=p(t.id),_=W(a),o=re(a);if(!S||!S.segments){if(console.warn(`⚠️ No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const A=new Date(t.scheduled_start_time),k=t.time_remaining||t.duration||1,$=new Date(A.getTime()+k*60*60*1e3),y={start:A,end:$},E=V(y.start,a),P=V(y.end,a),z=y.start<o&&y.end>_;if(!E&&!P&&!z)return null;let j,N;if(E&&P){const M=y.start.getUTCHours(),D=y.start.getUTCMinutes(),C=y.end.getUTCHours(),T=y.end.getUTCMinutes(),O=Math.max(6,M),F=Math.min(22,C),R=(O-6)*4+Math.floor(D/15),Y=(F-6)*4+Math.ceil(T/15);j=R*15,N=(Y-R)*15}else if(E){const M=y.start.getUTCHours(),D=y.start.getUTCMinutes(),T=(Math.max(6,M)-6)*4+Math.floor(D/15);j=T*15,N=(64-T)*15}else if(P){const M=y.end.getUTCHours(),D=y.end.getUTCMinutes(),T=(Math.min(22,M)-6)*4+Math.ceil(D/15);j=0,N=T*15}else j=0,N=960;return[{left:j,width:N,start:y.start,end:y.end}]}const U=[];for(const A of S.segments){const k=new Date(A.start),$=new Date(A.end),y=V(k,a),E=V($,a),P=k<o&&$>_;if(y||E||P){let z,j;if(y&&E){const N=k.getUTCHours(),M=k.getUTCMinutes(),D=$.getUTCHours(),C=$.getUTCMinutes(),T=Math.max(6,N),O=Math.min(22,D),F=(T-6)*4+Math.floor(M/15),R=(O-6)*4+Math.ceil(C/15);z=F*15,j=(R-F)*15}else if(y){const N=k.getUTCHours(),M=k.getUTCMinutes(),C=(Math.max(6,N)-6)*4+Math.floor(M/15);z=C*15,j=(64-C)*15}else if(E){const N=$.getUTCHours(),M=$.getUTCMinutes(),C=(Math.min(22,N)-6)*4+Math.ceil(M/15);z=0,j=C*15}else z=0,j=960;U.push({left:z,width:j,start:k,end:$})}}return U.length>0?U:null},[t.id,a,p,n]),b=m?m.reduce((S,_)=>S+_.width,0):0,w=b<60,L=b<120,B=w&&b<80,K=b<40,X=d.useCallback(S=>{S.stopPropagation(),s(!l)},[l]);return!m||m.length===0?null:e.jsx(e.Fragment,{children:m.map((S,_)=>e.jsxs("div",{ref:_===0?x:void 0,style:{position:"absolute",left:`${S.left}px`,width:`${S.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${w?"very-small":""} ${L?"small":""} ${K?"extremely-narrow":""} ${m.length>1?"split-segment":""} ${r.taskId===t.id&&(r.isScheduling||r.isRescheduling||r.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,_===0&&(()=>{const o=p(t.id);return o&&o.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${o.totalSegments} segments`,children:"✂️"}):null})()]})}),_===0&&e.jsxs("div",{className:`event-controls ${B?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:o=>{o.stopPropagation(),o.preventDefault()},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?H(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
Note Libere: ${t.user_notes||"Nessuna nota"}
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:o=>{o.stopPropagation(),o.preventDefault(),h(`/backlog/${t.id}/edit`)},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${l?"locked":"unlocked"}`,onClick:X,title:l?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:l?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!l&&e.jsx("div",{className:"drag-handle",...g,...c,style:{transform:u?`translate3d(${f?.x||0}px, ${f?.y||0}px, 0)`:"none",zIndex:u?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!l&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async o=>{o.stopPropagation(),o.preventDefault();try{await q.getState().unscheduleTask(t.id,v)}catch(U){console.error("Error unscheduling task:",U)}},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${_}`))})}),he=I.memo(({machine:t,scheduledEvents:i,currentDate:a,unavailableByMachine:v,dropTargetId:l,hideMachineLabel:s=!1,queryClient:h})=>{const p=d.useMemo(()=>i.filter(r=>r.scheduled_machine_id===t.id),[i,t.id]),n=v[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!s&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(r,c)=>{const g=Math.floor(c/4)+6,x=c%4*15,f=n?n.has(g.toString()):!1,u=`${t.id}-${g}-${x}`;return e.jsx(ue,{machine:t,hour:g,minute:x,isUnavailable:f,hasScheduledTask:!1,dropTargetId:l,slotId:u},u)}),p.length>0&&p.map(r=>e.jsx(me,{event:r,machine:t,currentDate:a,queryClient:h},`event-${r.id}`))]})]})}),pe=I.memo(({machines:t,currentDate:i,scheduledTasks:a})=>{const v=Z(),l=d.useMemo(()=>{const n=ae(i,{weekStartsOn:ne.APP.FIRST_DAY_OF_WEEK}),r=[];for(let c=0;c<7;c++){const g=new Date(n);g.setUTCDate(n.getUTCDate()+c),r.push(g)}return r},[i]),s=d.useCallback((n,r)=>a.filter(c=>c.scheduled_machine_id===n&&c.scheduled_start_time&&H(new Date(c.scheduled_start_time),"yyyy-MM-dd")===r),[a]),h=d.useCallback(n=>{v(`/backlog/${n.id}/edit`)},[v]),p=d.useCallback((n,r)=>s(n,r).length,[s]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),l.map(n=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:H(n,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:H(n,"yyyy-MM-dd")})]},n.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(n=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:n.machine_name}),e.jsx("div",{className:"machine-city",children:n.work_center})]}),l.map(r=>{const c=H(r,"yyyy-MM-dd"),g=s(n.id,c),x=p(n.id,c),f=r.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${f?"today":""} ${x>0?"has-tasks":""}`,children:g.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[x," task",x!==1?"s":""]}),g.slice(0,3).map(u=>e.jsxs("div",{className:"day-task-item",onClick:()=>h(u),title:`${u.odp_number} - ${u.article_code||"Codice articolo FLEXI"} - ${u.time_remaining?Number(u.time_remaining).toFixed(1):(u.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:u.odp_number}),e.jsxs("span",{className:"task-duration",children:[u.time_remaining?Number(u.time_remaining).toFixed(1):(u.duration||1).toFixed(1),"h"]})]},u.id)),g.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",g.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${n.id}-${c}`)})]},n.id))})]})}),xe=I.memo(({machines:t,currentDate:i,dropTargetId:a,onNavigateToNextDay:v,onNavigateToPreviousDay:l})=>{const[s,h]=d.useState("Daily"),{odpOrders:p}=te(),n=d.useMemo(()=>p.filter(m=>m.status==="SCHEDULED"),[p]),{loadMachineAvailabilityForDate:r,machineAvailability:c}=q(),g=se(),x=d.useMemo(()=>H(i,"yyyy-MM-dd"),[i]);d.useEffect(()=>(s==="Daily"&&!c[x]?._loading&&r(x),()=>{}),[x,r,s,c]);const f=d.useMemo(()=>{if(s!=="Daily")return{};const m=c[x];if(!Array.isArray(m)||m.length===0)return{};const b={};for(let w=0;w<m.length;w++){const L=m[w];L.machine_id&&L.unavailable_hours&&(b[L.machine_id]=new Set(L.unavailable_hours.map(B=>B.toString())))}return b},[c,x,s]),u=d.useMemo(()=>Array.from({length:16},(m,b)=>{const w=b+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${b*4+1} / span 4`},children:w.toString().padStart(2,"0")},w)}),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:s,onChange:m=>h(m.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:s==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(m=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:m.machine_name}),e.jsx("div",{className:"machine-city",children:m.work_center})]},m.id))})]}),e.jsx(ce,{currentDate:i,onNavigateToPreviousDay:l,isDragOver:a==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row",children:u}),e.jsx("div",{className:"time-grid-body",children:t.map(m=>e.jsx(he,{machine:m,scheduledEvents:n,currentDate:i,unavailableByMachine:f,dropTargetId:a,hideMachineLabel:!0,queryClient:g},m.id))})]}),e.jsx(de,{currentDate:i,onNavigateToNextDay:v,isDragOver:a==="next-day-drop-zone"})]}):e.jsx(pe,{machines:t,currentDate:i,scheduledTasks:n})})]})});export{xe as default};
