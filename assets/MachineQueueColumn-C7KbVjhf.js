const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DEpIqjbk.js","assets/index-o65vP_1O.css"])))=>i.map(i=>d[i]);
import{u as I,k,v as E,x as z,C as A,r as d,h as w,j as e,_ as S,y as H,z as L,E as O,F,G as R,L as B,I as Q,H as V,B as D,b as U,c as K,J as W,K as J}from"./index-DEpIqjbk.js";function G({task:s,index:c,machineId:x}){const j=I(),p=k(),{unscheduleTask:u}=E(),{attributes:m,listeners:o,setNodeRef:g,transform:i,transition:v,isDragging:l}=z({id:`task-${s.id}`,data:{type:"queue-task",task:s,machineId:x,index:c}}),N={transform:A.Transform.toString(i),transition:v,opacity:l?.5:1},{isPauseTask:a,splitInfo:t}=d.useMemo(()=>{try{if(s.description){const h=JSON.parse(s.description),C=h.is_pause===!0,q=h.wasSplit?{wasSplit:h.wasSplit,totalSegments:h.totalSegments||1,segments:h.segments||[]}:null;return{isPauseTask:C,splitInfo:q}}}catch{}return{isPauseTask:s.odp_number?.startsWith("PAUSE-")||s.article_code==="PAUSE",splitInfo:null}},[s]),r=s.time_remaining||s.duration||0,_=s.scheduled_start_time?w(new Date(s.scheduled_start_time),"dd/MM HH:mm"):"—",f=s.scheduled_end_time?w(new Date(s.scheduled_end_time),"dd/MM HH:mm"):"—",b=(n=>a?"#6b7280":n>70?"#059669":n>=40&&n<=69?"#d97706":"#dc2626")(s.material_availability_global||0),P=async n=>{if(n.stopPropagation(),n.preventDefault(),!!window.confirm(a?"Sei sicuro di voler rimuovere questa pausa?":`Sei sicuro di voler rimuovere "${s.odp_number}" dalla coda?

I task successivi verranno ricalcolati automaticamente.`))try{await u(s.id,p),await p.invalidateQueries({queryKey:["orders"]})}catch(C){console.error("Error unscheduling task:",C);const{showError:q}=await S(async()=>{const{showError:T}=await import("./index-DEpIqjbk.js").then($=>$.M);return{showError:T}},__vite__mapDeps([0,1]));q("Errore durante la rimozione del lavoro dalla coda")}},M=n=>{n.stopPropagation(),n.preventDefault(),a||j(`/backlog/${s.id}/edit`)};return e.jsxs("div",{ref:g,style:N,className:`queue-task-card ${a?"pause-task":""} ${l?"dragging":""}`,children:[e.jsx("div",{className:"queue-task-drag-handle",...m,...o,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),e.jsxs("div",{className:"queue-task-content",style:{borderLeftColor:b},children:[e.jsxs("div",{className:"queue-task-position",children:["#",c+1]}),e.jsxs("div",{className:"queue-task-main",children:[e.jsxs("div",{className:"queue-task-odp",children:[s.odp_number,t&&t.wasSplit&&e.jsxs("span",{className:"split-badge",title:`Task split into ${t.totalSegments} segments due to machine unavailability`,children:["✂️ ",t.totalSegments]})]}),!a&&s.article_code&&e.jsx("div",{className:"queue-task-article",children:s.article_code}),a&&e.jsx("div",{className:"queue-task-pause-label",children:"⏸ Pausa"})]}),e.jsxs("div",{className:"queue-task-duration",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]}),e.jsxs("span",{children:[r.toFixed(1),"h"]})]}),e.jsxs("div",{className:"queue-task-times",children:[e.jsxs("div",{className:"queue-task-time",children:[e.jsx("span",{className:"time-label",children:"Inizio:"}),e.jsx("span",{className:"time-value",children:_})]}),e.jsxs("div",{className:"queue-task-time",children:[e.jsx("span",{className:"time-label",children:"Fine:"}),e.jsx("span",{className:"time-value",children:f})]}),t&&t.wasSplit&&e.jsxs("div",{className:"queue-task-split-info",children:[e.jsx("span",{className:"split-info-icon",children:"⚠️"}),e.jsxs("span",{className:"split-info-text",children:["Task diviso in ",t.totalSegments," segmenti per non disponibilità macchina"]})]})]}),!a&&s.progress>0&&e.jsxs("div",{className:"queue-task-progress",children:[e.jsx("div",{className:"progress-bar-bg",children:e.jsx("div",{className:"progress-bar-fill",style:{width:`${Math.min(s.progress,100)}%`}})}),e.jsxs("span",{className:"progress-text",children:[Math.round(s.progress),"%"]})]})]}),e.jsxs("div",{className:"queue-task-actions",children:[e.jsx("button",{className:"queue-task-btn info-btn",onClick:n=>{n.stopPropagation(),n.preventDefault()},title:a?`Pausa di ${r}h`:`Codice Articolo: ${s.article_code||"Non specificato"}
Codice Articolo Esterno: ${s.external_article_code||"Non specificato"}
Nome Cliente: ${s.nome_cliente||"Non specificato"}
Data Consegna: ${s.delivery_date?w(new Date(s.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${s.quantity||"Non specificata"}
Note Libere: ${s.user_notes||"Nessuna nota"}
Note ASD: ${s.asd_notes||"Nessuna nota"}
Material Global: ${s.material_availability_global||"N/A"}%`,children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}),!a&&e.jsx("button",{className:"queue-task-btn edit-btn",onClick:M,title:"Modifica",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:"queue-task-btn remove-btn",onClick:P,title:a?"Rimuovi pausa":"Rimuovi dalla coda",children:e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]})}function X({isOpen:s,onClose:c,onCreatePause:x,machineId:j,machineName:p}){const[u,m]=d.useState("1"),[o,g]=d.useState(!1),i=async()=>{const l=parseFloat(u);if(isNaN(l)||l<=0){alert("Inserisci una durata valida maggiore di 0");return}g(!0);try{await x(j,l),m("1"),c()}catch(N){console.error("Error creating pause:",N),alert("Errore nella creazione della pausa")}finally{g(!1)}},v=()=>{o||(m("1"),c())};return e.jsx(H,{open:s,onOpenChange:v,children:e.jsxs(L,{className:"sm:max-w-[425px]",children:[e.jsxs(O,{children:[e.jsx(F,{children:"Aggiungi Pausa"}),e.jsxs(R,{children:["Crea una pausa nella coda di ",e.jsx("strong",{children:p})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(B,{htmlFor:"duration",className:"text-right",children:"Durata (ore)"}),e.jsx(Q,{id:"duration",type:"number",step:"0.5",min:"0.5",value:u,onChange:l=>m(l.target.value),className:"col-span-3",disabled:o})]}),e.jsx("div",{className:"text-xs text-gray-500 ml-auto",children:"La pausa verrà aggiunta alla fine della coda"})]}),e.jsxs(V,{children:[e.jsx(D,{variant:"secondary",onClick:v,disabled:o,children:"Annulla"}),e.jsx(D,{onClick:i,disabled:o,children:o?"Creazione...":"Crea Pausa"})]})]})})}function Z({machine:s,queryClient:c}){const{odpOrders:x}=U(),{createPauseTask:j}=E(),[p,u]=d.useState(!1),m=async(a,t)=>{try{const r=await j(a,t,!0);if(r.error){console.error("Error creating pause:",r.error);const{showError:f}=await S(async()=>{const{showError:y}=await import("./index-DEpIqjbk.js").then(b=>b.M);return{showError:y}},__vite__mapDeps([0,1]));throw f(r.error),new Error(r.error)}c&&await c.invalidateQueries({queryKey:["orders"]});const{showSuccess:_}=await S(async()=>{const{showSuccess:f}=await import("./index-DEpIqjbk.js").then(y=>y.M);return{showSuccess:f}},__vite__mapDeps([0,1]));_("Pausa creata con successo")}catch(r){throw console.error("Error creating pause:",r),r}},{setNodeRef:o,isOver:g}=K({id:`machine-queue-${s.id}`,data:{type:"queue-column",machineId:s.id,machine:s}}),i=d.useMemo(()=>x.filter(a=>a.scheduled_machine_id===s.id&&a.status==="SCHEDULED"&&a.scheduled_start_time).sort((a,t)=>{const r=new Date(a.scheduled_start_time).getTime(),_=new Date(t.scheduled_start_time).getTime();return r-_}),[x,s.id]),v=d.useMemo(()=>i.reduce((a,t)=>{const r=t.time_remaining||t.duration||0;return a+r},0),[i]),l=d.useMemo(()=>{if(i.length===0)return null;const a=i[i.length-1];return a.scheduled_end_time?new Date(a.scheduled_end_time):null},[i]),N=d.useMemo(()=>i.map(a=>`task-${a.id}`),[i]);return e.jsxs("div",{ref:o,className:`machine-queue-column ${g?"is-drag-over":""}`,children:[e.jsxs("div",{className:"queue-column-header",children:[e.jsxs("div",{className:"queue-column-title",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:s.machine_name}),e.jsx("span",{className:"text-[10px] text-gray-500",children:s.work_center})]}),e.jsxs("div",{className:"queue-column-stats",children:[e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-label",children:"Tasks:"}),e.jsx("span",{className:"stat-value",children:i.length})]}),e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-label",children:"Durata:"}),e.jsxs("span",{className:"stat-value",children:[v.toFixed(1),"h"]})]}),l&&e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-label",children:"Fine:"}),e.jsx("span",{className:"stat-value",children:w(l,"dd/MM HH:mm")})]})]})]}),e.jsx("div",{className:"queue-column-body",children:i.length===0?e.jsxs("div",{className:"queue-empty-state",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Nessun lavoro in coda"}),e.jsx("p",{className:"text-[10px] text-gray-400",children:"Trascina un lavoro qui per iniziare"})]}):e.jsx(W,{items:N,strategy:J,children:e.jsx("div",{className:"queue-tasks-list",children:i.map((a,t)=>e.jsx(G,{task:a,index:t,machineId:s.id},a.id))})})}),e.jsx("div",{className:"queue-column-footer",children:e.jsx(D,{variant:"secondary",size:"sm",onClick:()=>u(!0),className:"w-full",children:"+ Aggiungi Pausa"})}),e.jsx(X,{isOpen:p,onClose:()=>u(!1),onCreatePause:m,machineId:s.id,machineName:s.machine_name})]})}export{Z as default};
