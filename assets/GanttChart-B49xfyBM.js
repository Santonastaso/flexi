import{R as V,r as v,a as Q,h as L,t as H,i as Y,j as e,d as G,f as R,k as O,b as X,e as J,l as K,m as Z,g as B}from"./index-BdUhbY7s.js";const ee=V.memo(({machine:t,hour:u,minute:m,isUnavailable:r,hasScheduledTask:j,dropTargetId:C,slotId:f})=>{const{setNodeRef:x}=X({id:`slot-${t.id}-${u}-${m}`,data:{machine:t,hour:u,minute:m,type:"slot",isUnavailable:r,hasScheduledTask:j}}),a=`time-slot${r?" unavailable":""}${j?" has-scheduled-task":""}`,i=C===f;return e.jsx("div",{ref:x,className:a,"data-hour":u,"data-minute":m,"data-machine-id":t.id,style:{position:"relative"},children:i&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:0,left:0,right:0,bottom:0,border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),te=V.memo(({event:t,machine:u,currentDate:m})=>{const[r,j]=v.useState(!0),C=G(),{getSplitTaskInfo:f,splitTasksInfo:x}=L(),{attributes:a,listeners:i,setNodeRef:l,transform:d,isDragging:n}=J({id:`event-${t.id}`,data:{event:t,type:"event",machine:u},disabled:r}),c=v.useMemo(()=>{const p=f(t.id),N=K(m),s=Z(m);if(!p||!p.segments){if(console.warn(`⚠️ No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const P=new Date(t.scheduled_start_time),M=t.time_remaining||t.duration||1,S=new Date(P.getTime()+M*60*60*1e3),h={start:P,end:S},$=O(h.start,m),A=O(h.end,m),E=h.start<s&&h.end>N;if(!$&&!A&&!E)return null;let T,b;if($&&A){const w=h.start.getUTCHours(),D=h.start.getUTCMinutes(),U=h.end.getUTCHours(),W=h.end.getUTCMinutes(),I=w*4+Math.floor(D/15),q=U*4+Math.ceil(W/15);T=I*20,b=(q-I)*20}else if($){const w=h.start.getUTCHours(),D=h.start.getUTCMinutes(),U=w*4+Math.floor(D/15);T=U*20,b=(96-U)*20}else if(A){const w=h.end.getUTCHours(),D=h.end.getUTCMinutes(),U=w*4+Math.ceil(D/15);T=0,b=U*20}else T=0,b=1920;return[{left:T,width:b,start:h.start,end:h.end}]}const F=[];for(const P of p.segments){const M=new Date(P.start),S=new Date(P.end),h=O(M,m),$=O(S,m),A=M<s&&S>N;if(h||$||A){let E,T;if(h&&$){const b=M.getUTCHours(),w=M.getUTCMinutes(),D=S.getUTCHours(),U=S.getUTCMinutes(),W=b*4+Math.floor(w/15),I=D*4+Math.ceil(U/15);E=W*20,T=(I-W)*20}else if(h){const b=M.getUTCHours(),w=M.getUTCMinutes(),D=b*4+Math.floor(w/15);E=D*20,T=(96-D)*20}else if($){const b=S.getUTCHours(),w=S.getUTCMinutes(),D=b*4+Math.ceil(w/15);E=0,T=D*20}else E=0,T=1920;F.push({left:E,width:T,start:M,end:S})}}return F.length>0?F:null},[t.id,m,f,x]),o=c?c.reduce((p,N)=>p+N.width,0):0,g=o<60,y=o<120,z=g&&o<80,k=o<40,_=v.useCallback(p=>{p.stopPropagation(),j(!r)},[r]);return!c||c.length===0?null:e.jsx(e.Fragment,{children:c.map((p,N)=>e.jsxs("div",{ref:N===0?l:void 0,style:{position:"absolute",left:`${p.left}px`,width:`${p.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${g?"very-small":""} ${y?"small":""} ${k?"extremely-narrow":""} ${c.length>1?"split-segment":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,N===0&&(()=>{const s=f(t.id);return s&&s.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${s.totalSegments} segments`,children:"✂️"}):null})()]})}),N===0&&e.jsxs("div",{className:`event-controls ${z?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:s=>{s.stopPropagation(),s.preventDefault()},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
Data Consegna: ${R(t.delivery_date)||"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
${t.scheduled_start_time?`Inizio Programmato: ${B(t.scheduled_start_time)}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${B(t.scheduled_end_time)}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:s=>{s.stopPropagation(),s.preventDefault(),C(`/backlog/${t.id}/edit`)},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${r?"locked":"unlocked"}`,onClick:_,title:r?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:r?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!r&&e.jsx("div",{className:"drag-handle",...i,...a,style:{transform:n?`translate3d(${d?.x||0}px, ${d?.y||0}px, 0)`:"none",zIndex:n?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!r&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async s=>{s.stopPropagation(),s.preventDefault();try{await L.getState().unscheduleTask(t.id)}catch(F){console.error("Error unscheduling task:",F)}},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${N}`))})}),se=V.memo(({machine:t,scheduledEvents:u,currentDate:m,unavailableByMachine:r,dropTargetId:j})=>{const C=v.useMemo(()=>u.filter(x=>x.scheduled_machine_id===t.id),[u,t.id]),f=r[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:96},(x,a)=>{const i=Math.floor(a/4),l=a%4*15,d=f?f.has(i.toString()):!1,n=`${t.id}-${i}-${l}`;return e.jsx(ee,{machine:t,hour:i,minute:l,isUnavailable:d,hasScheduledTask:!1,dropTargetId:j,slotId:n},n)}),C.length>0&&C.map(x=>e.jsx(te,{event:x,machine:t,currentDate:m},`event-${x.id}`))]})]})}),ae=V.memo(({machines:t,currentDate:u,scheduledTasks:m,machineAvailability:r})=>{const j=G(),C=v.useMemo(()=>{const a=Y(u),i=[];for(let l=0;l<7;l++){const d=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate()+l,0,0,0,0));i.push(d)}return i},[u]),f=v.useCallback((a,i)=>m.filter(l=>{if(l.scheduled_machine_id!==a||!l.scheduled_start_time)return!1;const d=new Date(l.scheduled_start_time);if(H(d)===i)return!0;if(l.scheduled_end_time){const c=new Date(l.scheduled_end_time);if(H(c)===i)return!0;const g=new Date(i),y=new Date(Date.UTC(g.getUTCFullYear(),g.getUTCMonth(),g.getUTCDate(),0,0,0,0)),z=new Date(Date.UTC(g.getUTCFullYear(),g.getUTCMonth(),g.getUTCDate(),23,59,59,999));if(d<z&&c>y){const k=r[i];if(k&&Array.isArray(k)){const _=k.find(p=>p.machine_id===a);if(_&&_.unavailable_hours&&_.unavailable_hours.length===24)return!1}return!0}}if(!l.scheduled_end_time&&(l.time_remaining||l.duration)){const c=l.time_remaining||l.duration||1,o=new Date(d.getTime()+c*60*60*1e3);if(H(o)===i)return!0;const y=new Date(i),z=new Date(Date.UTC(y.getUTCFullYear(),y.getUTCMonth(),y.getUTCDate(),0,0,0,0)),k=new Date(Date.UTC(y.getUTCFullYear(),y.getUTCMonth(),y.getUTCDate(),23,59,59,999));if(d<k&&o>z){const _=r[i];if(_&&Array.isArray(_)){const p=_.find(N=>N.machine_id===a);if(p&&p.unavailable_hours&&p.unavailable_hours.length===24)return!1}return!0}}return!1}),[m,r]),x=v.useCallback(a=>{j(`/backlog/${a.id}/edit`)},[j]);return v.useCallback((a,i)=>f(a,i).length,[f]),e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),C.map(a=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:R(a)}),e.jsx("div",{className:"day-date",children:R(a)})]},a.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(a=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:a.machine_name}),e.jsx("div",{className:"machine-city",children:a.work_center})]}),C.map(i=>{const l=H(i),d=f(a.id,l),n=d.length,c=O(i,new Date);return e.jsx("div",{className:`day-cell ${c?"today":""} ${n>0?"has-tasks":""}`,children:d.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[n," task",n!==1?"s":""]}),d.slice(0,3).map(o=>e.jsxs("div",{className:"day-task-item",onClick:()=>x(o),title:`${o.odp_number} - ${o.article_code||"Codice articolo FLEXI"} - ${o.time_remaining?Number(o.time_remaining).toFixed(1):(o.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:o.odp_number}),e.jsxs("span",{className:"task-duration",children:[o.time_remaining?Number(o.time_remaining).toFixed(1):(o.duration||1).toFixed(1),"h"]})]},o.id)),d.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",d.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${a.id}-${l}`)})]},a.id))})]})}),ie=V.memo(({machines:t,currentDate:u,dropTargetId:m})=>{const[r,j]=v.useState("Daily"),{odpOrders:C}=Q(),f=v.useMemo(()=>C.filter(n=>n.status==="SCHEDULED"),[C]),{loadMachineAvailabilityForDate:x,machineAvailability:a}=L(),i=v.useMemo(()=>H(u),[u]);v.useEffect(()=>{if(r==="Daily")x(i);else if(r==="Weekly"){const n=Y(u);new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()+6,23,59,59,999));for(let c=0;c<7;c++){const o=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()+c,0,0,0,0)),g=H(o);x(g)}}return()=>{}},[i,x,r,u]);const l=v.useMemo(()=>{if(r!=="Daily")return{};const n=a[i];if(!Array.isArray(n)||n.length===0)return{};const c={};for(let o=0;o<n.length;o++){const g=n[o];g.machine_id&&g.unavailable_hours&&(c[g.machine_id]=new Set(g.unavailable_hours.map(y=>y.toString())))}return c},[a,i,r]),d=v.useMemo(()=>Array.from({length:24},(n,c)=>e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${c*4+1} / span 4`},children:c.toString().padStart(2,"0")},c)),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:r,onChange:n=>j(n.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:r==="Daily"?e.jsxs("div",{className:"calendar-grid",children:[e.jsxs("div",{className:"calendar-header-row",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"time-header",children:d})]}),e.jsx("div",{className:"calendar-body",children:t.map(n=>e.jsx(se,{machine:n,scheduledEvents:f,currentDate:u,unavailableByMachine:l,dropTargetId:m},n.id))})]}):e.jsx(ae,{machines:t,currentDate:u,scheduledTasks:f,machineAvailability:a})})]})});export{ie as default};
