import{R as D,a as R,r as C,f as E,t as P,j as e,b as F,d as W,e as Z,g as q,h as G,i as k}from"./index-sO_E3kZg.js";const Q=D.memo(({machine:t,hour:l,minute:s,isUnavailable:n,hasScheduledTask:m})=>{const{setNodeRef:S}=F({id:`slot-${t.id}-${l}-${s}`,data:{machine:t,hour:l,minute:s,type:"slot",isUnavailable:n,hasScheduledTask:m}}),a=`time-slot${n?" unavailable":""}${m?" has-scheduled-task":""}`;return e.jsx("div",{ref:S,className:a,"data-hour":l,"data-minute":s,"data-machine-id":t.id})}),J=D.memo(({event:t,machine:l,currentDate:s})=>{const[n,m]=C.useState(!0),S=W(),{getSplitTaskInfo:a}=E(),{attributes:b,listeners:y,setNodeRef:i,transform:c,isDragging:o}=Z({id:`event-${t.id}`,data:{event:t,type:"event",machine:l},disabled:n}),d=C.useMemo(()=>{const u=a(t.id),h=q(s),g=G(s);if(u&&u.wasSplit){const p=[];for(const _ of u.segments){const r=new Date(_.start),f=new Date(_.end),$=k(r,s),H=k(f,s),T=r<g&&f>h;if($||H||T){let v,x;if($&&H){const j=r.getUTCHours(),M=r.getUTCMinutes(),N=f.getUTCHours(),O=f.getUTCMinutes(),z=j*4+Math.floor(M/15),V=N*4+Math.ceil(O/15);v=z*20,x=(V-z)*20}else if($){const j=r.getUTCHours(),M=r.getUTCMinutes(),N=j*4+Math.floor(M/15);v=N*20,x=(96-N)*20}else if(H){const j=f.getUTCHours(),M=f.getUTCMinutes(),N=j*4+Math.ceil(M/15);v=0,x=N*20}else v=0,x=1920;p.push({left:v,width:x,start:r,end:f})}}return p.length>0?p:null}else{const p=new Date(t.scheduled_start_time),_=t.time_remaining||t.duration||1,r=new Date(p.getTime()+_*60*60*1e3),f=k(p,s),$=k(r,s),H=p<g&&r>h;if(!f&&!$&&!H)return null;let T,v;if(f){const x=p.getUTCHours(),j=p.getUTCMinutes();T=(x*4+Math.floor(j/15))*20;const N=24-x;v=Math.min(_,N)*4*20}else if($){T=0;const x=r.getUTCHours(),j=r.getUTCMinutes();v=(x*4+Math.ceil(j/15))*20}else T=0,v=1920;return[{left:T,width:v,start:p,end:r}]}},[t.scheduled_start_time,t.time_remaining,t.duration,s,a,t.id]),w=d?d.reduce((u,h)=>u+h.width,0):0,U=w<60,A=w<120,B=U&&w<80,I=w<40,L=C.useCallback(u=>{u.stopPropagation(),m(!n)},[n]);return!d||d.length===0?null:e.jsx(e.Fragment,{children:d.map((u,h)=>e.jsxs("div",{ref:h===0?i:void 0,style:{position:"absolute",left:`${u.left}px`,width:`${u.width}px`,transform:o&&h===0?`translate3d(${c?.x||0}px, ${c?.y||0}px, 0)`:"none",zIndex:o?1001:10,opacity:o?.8:1,transition:o?"none":"opacity 0.1s ease",pointerEvents:o?"none":"auto"},className:`scheduled-event ${o?"dragging":""} ${U?"very-small":""} ${A?"small":""} ${I?"extremely-narrow":""} ${d.length>1?"split-segment":""}`,...h===0?{...b,...y}:{},children:[e.jsx("div",{className:"event-content",style:{opacity:o?.7:1,transform:o?"scale(0.95)":"none"},children:e.jsxs("span",{className:"event-label",children:[t.odp_number,h===0&&(()=>{const g=a(t.id);return g&&g.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${g.totalSegments} segments`,children:"✂️"}):null})()]})}),!o&&h===0&&e.jsxs("div",{className:`event-controls ${B?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
Data Consegna: ${t.delivery_date?new Date(t.delivery_date).toLocaleDateString():"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
${t.scheduled_start_time?`Inizio Programmato: ${new Date(t.scheduled_start_time).toISOString().replace("T"," ").replace(".000Z","")}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${new Date(t.scheduled_end_time).toISOString().replace("T"," ").replace(".000Z","")}`:"Non programmato"}`,children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})}),e.jsx("button",{className:"event-btn edit-btn",onClick:g=>{g.stopPropagation(),S(`/backlog/${t.id}/edit`)},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${n?"locked":"unlocked"}`,onClick:L,title:n?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:n?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!n&&e.jsx("div",{className:"drag-handle",...y,...b,title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!n&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:g=>{g.stopPropagation(),E.getState().unscheduleTask(t.id)},title:"Annulla programmazione e riporta al pool",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M19 13H5v-2h14v2z"})})})]})]},`${t.id}-segment-${h}`))})}),K=D.memo(({machine:t,scheduledEvents:l,currentDate:s,unavailableByMachine:n})=>{const m=C.useMemo(()=>l.filter(a=>a.scheduled_machine_id===t.id),[l,t.id]),S=n[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:96},(a,b)=>{const y=Math.floor(b/4),i=b%4*15,c=S?S.has(y.toString()):!1;return e.jsx(Q,{machine:t,hour:y,minute:i,isUnavailable:c,hasScheduledTask:!1},`${t.id}-${y}-${i}`)}),m.length>0&&m.map(a=>e.jsx(J,{event:a,machine:t,currentDate:s},`event-${a.id}`))]})]})}),Y=D.memo(({machines:t,currentDate:l})=>{const{odpOrders:s}=R(),n=C.useMemo(()=>s.filter(i=>i.status==="SCHEDULED"),[s]),{loadMachineAvailabilityForDate:m,machineAvailability:S}=E(),a=C.useMemo(()=>P(l),[l]);C.useEffect(()=>(m(a),()=>{}),[a,m]);const b=C.useMemo(()=>{const i=S[a];if(!Array.isArray(i)||i.length===0)return{};const c={};for(let o=0;o<i.length;o++){const d=i[o];d.machine_id&&d.unavailable_hours&&(c[d.machine_id]=new Set(d.unavailable_hours.map(w=>w.toString())))}return c},[S,a]),y=C.useMemo(()=>Array.from({length:24},(i,c)=>e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${c*4+1} / span 4`},children:c.toString().padStart(2,"0")},c)),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"calendar-grid",children:[e.jsxs("div",{className:"calendar-header-row",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"time-header",children:y})]}),e.jsx("div",{className:"calendar-body",children:t.map(i=>e.jsx(K,{machine:i,scheduledEvents:n,currentDate:l,unavailableByMachine:b},i.id))})]})})})});export{Y as default};
