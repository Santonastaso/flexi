import{R as E,r as p,a as Q,h as O,t as A,j as e,d as W,i as X,f as F,b as J,e as K,k as Y,l as Z,m as I,g as L}from"./index-L6qDKstN.js";const ee=E.memo(({machine:t,hour:m,minute:l,isUnavailable:n,hasScheduledTask:y,dropTargetId:x,slotId:f})=>{const{setNodeRef:u}=J({id:`slot-${t.id}-${m}-${l}`,data:{machine:t,hour:m,minute:l,type:"slot",isUnavailable:n,hasScheduledTask:y}}),a=`time-slot${n?" unavailable":""}${y?" has-scheduled-task":""}`,i=x===f;return e.jsx("div",{ref:u,className:a,"data-hour":m,"data-minute":l,"data-machine-id":t.id,style:{position:"relative"},children:i&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:0,left:0,right:0,bottom:0,border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),te=E.memo(({event:t,machine:m,currentDate:l})=>{const[n,y]=p.useState(!0),x=W(),{getSplitTaskInfo:f,splitTasksInfo:u}=O(),{attributes:a,listeners:i,setNodeRef:c,transform:g,isDragging:o}=K({id:`event-${t.id}`,data:{event:t,type:"event",machine:m},disabled:n}),h=p.useMemo(()=>{const v=f(t.id),C=Y(l),s=Z(l);if(console.log(`üîç Task ${t.odp_number} (${t.id}):`,{hasSegmentInfo:!!v,segmentCount:v?.segments?.length||0,wasSplit:v?.wasSplit||!1,description:t.description?.substring(0,100)+"..."}),!v||!v.segments){if(console.warn(`‚ö†Ô∏è No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const H=new Date(t.scheduled_start_time),w=t.time_remaining||t.duration||1,M=new Date(H.getTime()+w*60*60*1e3),d={start:H,end:M},$=I(d.start,l),U=I(d.end,l),k=d.start<s&&d.end>C;if(!$&&!U&&!k)return null;let N,b;if($&&U){const S=d.start.getUTCHours(),j=d.start.getUTCMinutes(),D=d.end.getUTCHours(),z=d.end.getUTCMinutes(),P=S*4+Math.floor(j/15),q=D*4+Math.ceil(z/15);N=P*20,b=(q-P)*20}else if($){const S=d.start.getUTCHours(),j=d.start.getUTCMinutes(),D=S*4+Math.floor(j/15);N=D*20,b=(96-D)*20}else if(U){const S=d.end.getUTCHours(),j=d.end.getUTCMinutes(),D=S*4+Math.ceil(j/15);N=0,b=D*20}else N=0,b=1920;return[{left:N,width:b,start:d.start,end:d.end}]}const T=[];for(const H of v.segments){const w=new Date(H.start),M=new Date(H.end),d=I(w,l),$=I(M,l),U=w<s&&M>C;if(d||$||U){let k,N;if(d&&$){const b=w.getUTCHours(),S=w.getUTCMinutes(),j=M.getUTCHours(),D=M.getUTCMinutes(),z=b*4+Math.floor(S/15),P=j*4+Math.ceil(D/15);k=z*20,N=(P-z)*20}else if(d){const b=w.getUTCHours(),S=w.getUTCMinutes(),j=b*4+Math.floor(S/15);k=j*20,N=(96-j)*20}else if($){const b=M.getUTCHours(),S=M.getUTCMinutes(),j=b*4+Math.ceil(S/15);k=0,N=j*20}else k=0,N=1920;T.push({left:k,width:N,start:w,end:M})}}return console.log(`‚úÖ Task ${t.odp_number}: ${T.length} visible segments`),T.length>0?T:null},[t.id,l,f,u]),r=h?h.reduce((v,C)=>v+C.width,0):0,_=r<60,V=r<120,R=_&&r<80,B=r<40,G=p.useCallback(v=>{v.stopPropagation(),y(!n)},[n]);return!h||h.length===0?null:e.jsx(e.Fragment,{children:h.map((v,C)=>e.jsxs("div",{ref:C===0?c:void 0,style:{position:"absolute",left:`${v.left}px`,width:`${v.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${_?"very-small":""} ${V?"small":""} ${B?"extremely-narrow":""} ${h.length>1?"split-segment":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,C===0&&(()=>{const s=f(t.id);return s&&s.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${s.totalSegments} segments`,children:"‚úÇÔ∏è"}):null})()]})}),C===0&&e.jsxs("div",{className:`event-controls ${R?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:s=>{s.stopPropagation(),s.preventDefault()},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
Data Consegna: ${F(t.delivery_date)||"Non impostata"}
Quantit√†: ${t.quantity||"Non specificata"}
${t.scheduled_start_time?`Inizio Programmato: ${L(t.scheduled_start_time)}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${L(t.scheduled_end_time)}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:s=>{s.stopPropagation(),s.preventDefault(),x(`/backlog/${t.id}/edit`)},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${n?"locked":"unlocked"}`,onClick:G,title:n?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:n?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!n&&e.jsx("div",{className:"drag-handle",...i,...a,style:{transform:o?`translate3d(${g?.x||0}px, ${g?.y||0}px, 0)`:"none",zIndex:o?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!n&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async s=>{s.stopPropagation(),s.preventDefault();try{await O.getState().unscheduleTask(t.id)}catch(T){console.error("Error unscheduling task:",T)}},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"√ó"})})]})]},`${t.id}-segment-${C}`))})}),se=E.memo(({machine:t,scheduledEvents:m,currentDate:l,unavailableByMachine:n,dropTargetId:y})=>{const x=p.useMemo(()=>m.filter(u=>u.scheduled_machine_id===t.id),[m,t.id]),f=n[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:96},(u,a)=>{const i=Math.floor(a/4),c=a%4*15,g=f?f.has(i.toString()):!1,o=`${t.id}-${i}-${c}`;return e.jsx(ee,{machine:t,hour:i,minute:c,isUnavailable:g,hasScheduledTask:!1,dropTargetId:y,slotId:o},o)}),x.length>0&&x.map(u=>e.jsx(te,{event:u,machine:t,currentDate:l},`event-${u.id}`))]})]})}),ae=E.memo(({machines:t,currentDate:m,scheduledTasks:l})=>{const n=W(),y=p.useMemo(()=>{const a=X(m),i=[];for(let c=0;c<7;c++){const g=new Date(a);g.setDate(a.getDate()+c),i.push(g)}return i},[m]),x=p.useCallback((a,i)=>l.filter(c=>c.scheduled_machine_id===a&&c.scheduled_start_time&&A(new Date(c.scheduled_start_time))===i),[l]),f=p.useCallback(a=>{n(`/backlog/${a.id}/edit`)},[n]),u=p.useCallback((a,i)=>x(a,i).length,[x]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),y.map(a=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:F(a)}),e.jsx("div",{className:"day-date",children:F(a)})]},a.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(a=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:a.machine_name}),e.jsx("div",{className:"machine-city",children:a.work_center})]}),y.map(i=>{const c=A(i),g=x(a.id,c),o=u(a.id,c),h=i.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${h?"today":""} ${o>0?"has-tasks":""}`,children:g.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[o," task",o!==1?"s":""]}),g.slice(0,3).map(r=>e.jsxs("div",{className:"day-task-item",onClick:()=>f(r),title:`${r.odp_number} - ${r.article_code||"Codice articolo FLEXI"} - ${r.time_remaining?Number(r.time_remaining).toFixed(1):(r.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:r.odp_number}),e.jsxs("span",{className:"task-duration",children:[r.time_remaining?Number(r.time_remaining).toFixed(1):(r.duration||1).toFixed(1),"h"]})]},r.id)),g.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",g.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${a.id}-${c}`)})]},a.id))})]})}),ie=E.memo(({machines:t,currentDate:m,dropTargetId:l})=>{const[n,y]=p.useState("Daily"),{odpOrders:x}=Q(),f=p.useMemo(()=>x.filter(o=>o.status==="SCHEDULED"),[x]),{loadMachineAvailabilityForDate:u,machineAvailability:a}=O(),i=p.useMemo(()=>A(m),[m]);p.useEffect(()=>(n==="Daily"&&u(i),()=>{}),[i,u,n]);const c=p.useMemo(()=>{if(n!=="Daily")return{};const o=a[i];if(!Array.isArray(o)||o.length===0)return{};const h={};for(let r=0;r<o.length;r++){const _=o[r];_.machine_id&&_.unavailable_hours&&(h[_.machine_id]=new Set(_.unavailable_hours.map(V=>V.toString())))}return h},[a,i,n]),g=p.useMemo(()=>Array.from({length:24},(o,h)=>e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${h*4+1} / span 4`},children:h.toString().padStart(2,"0")},h)),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:n,onChange:o=>y(o.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:n==="Daily"?e.jsxs("div",{className:"calendar-grid",children:[e.jsxs("div",{className:"calendar-header-row",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"time-header",children:g})]}),e.jsx("div",{className:"calendar-body",children:t.map(o=>e.jsx(se,{machine:o,scheduledEvents:f,currentDate:m,unavailableByMachine:c,dropTargetId:l},o.id))})]}):e.jsx(ae,{machines:t,currentDate:m,scheduledTasks:f})})]})});export{ie as default};
