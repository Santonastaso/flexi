import{n as le,s as J,t as ce,R as B,r as b,c as de,h as me,f as z,i as ue,j as e,B as ne,S as he,k as ge,l as pe,m as ye,o as ie,p as E,I as fe,C as M,u as oe,q as xe,A as _e,v as re,g as ee,b as Ne,a as ve,e as je}from"./index-DQH2hy3E.js";function q(t,a,c){const[N,y]=le(c?.in,t,a);return+J(N)==+J(y)}function Se(t,a){const c=ce(t,a?.in);return c.setHours(23,59,59,999),c}const te=t=>{if(!t||!t.description||t.status!=="SCHEDULED")return null;try{const a=JSON.parse(t.description);if(a.segments&&Array.isArray(a.segments))return a}catch{}return null},be=B.memo(({machine:t,hour:a,minute:c,isUnavailable:N,hasScheduledTask:y,dropTargetId:x,slotId:v,dragPreview:h})=>{const{setNodeRef:r}=Ne({id:`slot-${t.id}-${a}-${c}`,data:{machine:t,hour:a,minute:c,type:"slot",isUnavailable:N,hasScheduledTask:y}}),u=`time-slot${N?" unavailable":""}${y?" has-scheduled-task":""}`,d=x===v,l=(a-M.WORK_START_HOUR)*M.SLOTS_PER_HOUR+Math.floor(c/M.MINUTES_PER_SLOT),m=h?.isActive&&h.machineId===t.id&&l>=h.startSlot&&l<h.startSlot+h.durationSlots;return e.jsxs("div",{ref:r,className:u,"data-hour":a,"data-minute":c,"data-machine-id":t.id,style:{position:"relative"},children:[d&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}}),m&&e.jsx("div",{className:"drag-preview-indicator",style:{position:"absolute",top:"0px",left:"0px",right:"0px",bottom:"0px",background:"rgba(59, 130, 246, 0.3)",border:"2px solid #3b82f6",pointerEvents:"none",zIndex:999,borderRadius:"2px"}})]})}),Me=B.memo(({event:t,machine:a,currentDate:c,queryClient:N,readOnly:y=!1})=>{const x=oe(),{schedulingLoading:v}=ve(),{attributes:h,listeners:r,setNodeRef:u,transform:d,isDragging:l}=je({id:`event-${t.id}`,data:{event:t,type:"event",machine:a},disabled:y}),m=b.useMemo(()=>{const i=te(t),g=J(c),s=Se(c),$=t.duration||1,L=t.progress||0,F=$*(L/100);if(!i||!i.segments){if(!t.scheduled_start_time)return null;const k=new Date(t.scheduled_start_time),T=t.time_remaining||t.duration||1,I=new Date(k.getTime()+T*60*60*1e3),f={start:k,end:I},R=q(f.start,c),O=q(f.end,c),Z=f.start<s&&f.end>g;if(!R&&!O&&!Z)return null;let D,w;if(R&&O){const p=E(f.start,"Europe/Rome"),j=E(f.end,"Europe/Rome"),C=p.getHours(),A=p.getMinutes(),S=j.getHours(),G=j.getMinutes(),Q=Math.max(6,C),X=Math.min(22,S),U=(Q-6)*4+Math.floor(A/15),Y=(X-6)*4+Math.ceil(G/15);D=U*15,w=(Y-U)*15}else if(R){const p=E(f.start,"Europe/Rome"),j=p.getHours(),C=p.getMinutes(),S=(Math.max(6,j)-6)*4+Math.floor(C/15);D=S*15,w=(64-S)*15}else if(O){const p=E(f.end,"Europe/Rome"),j=p.getHours(),C=p.getMinutes(),S=(Math.min(22,j)-6)*4+Math.ceil(C/15);D=0,w=S*15}else D=0,w=960;const V=L;return[{left:D,width:w,start:f.start,end:f.end,progress:V,duration:T}]}const P=[];let W=0;for(const k of i.segments){const T=new Date(k.start),I=new Date(k.end),f=k.duration||0,R=q(T,c),O=q(I,c),Z=T<s&&I>g;if(R||O||Z){let D,w;if(R&&O){const p=E(T,"Europe/Rome"),j=E(I,"Europe/Rome"),C=p.getHours(),A=p.getMinutes(),S=j.getHours(),G=j.getMinutes(),Q=Math.max(6,C),X=Math.min(22,S),U=(Q-6)*4+Math.floor(A/15),Y=(X-6)*4+Math.ceil(G/15);D=U*15,w=(Y-U)*15}else if(R){const p=E(T,"Europe/Rome"),j=p.getHours(),C=p.getMinutes(),S=(Math.max(6,j)-6)*4+Math.floor(C/15);D=S*15,w=(64-S)*15}else if(O){const p=E(I,"Europe/Rome"),j=p.getHours(),C=p.getMinutes(),S=(Math.min(22,j)-6)*4+Math.ceil(C/15);D=0,w=S*15}else D=0,w=960;let V=0;F>W&&(V=Math.min(f,F-W)/f*100),P.push({left:D,width:w,start:T,end:I,progress:V,duration:f}),W+=f}}return P.length>0?P:null},[t,c]),_=m?m.reduce((i,g)=>i+g.width,0):0,n=_<60,o=_<120,H=n&&_<80,se=_<40;if(!m||m.length===0)return null;const K=(i=>i>70?"#059669":i>=40&&i<=69?"#d97706":"#dc2626")(t.material_availability_global||0);return e.jsx(e.Fragment,{children:m.map((i,g)=>e.jsxs("div",{ref:g===0?u:void 0,style:{position:"absolute",left:`${i.left}px`,width:`${i.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto",background:K},className:`scheduled-event ${n?"very-small":""} ${o?"small":""} ${se?"extremely-narrow":""} ${m.length>1?"split-segment":""} ${v.taskId===t.id&&(v.isScheduling||v.isRescheduling||v.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,g===0&&(()=>{const s=te(t);return s&&s.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${s.totalSegments} segments`,children:"✂️"}):null})()]})}),i.progress&&i.progress>0&&e.jsx("div",{className:"progress-bar-overlay",style:{width:`${Math.min(i.progress,100)}%`}}),e.jsxs("div",{className:`event-controls ${H?"overlay":""}`,style:{position:"relative",zIndex:20},children:[e.jsx("button",{className:"event-btn info-btn",onClick:s=>{s.stopPropagation(),s.preventDefault()},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
Data Consegna: ${t.delivery_date?re(t.delivery_date):"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
Altezza Busta: ${t.bag_height||"Non specificata"} mm
Passo Busta: ${t.bag_step||"Non specificato"} mm
Note Libere: ${t.user_notes||"Nessuna nota"}
Note ASD: ${t.asd_notes||"Nessuna nota"}
Material Global: ${t.material_availability_global||"N/A"}%
${t.scheduled_start_time?`Inizio Programmato: ${ee(t.scheduled_start_time)}`:"Non programmato"}
${t.scheduled_end_time?`Fine Programmata: ${ee(t.scheduled_end_time)}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),g===0&&!y&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"event-btn edit-btn",onClick:s=>{s.stopPropagation(),s.preventDefault(),x(`/backlog/${t.id}/edit`)},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("div",{className:"drag-handle",...r,...h,style:{transform:l?`translate3d(${d?.x||0}px, ${d?.y||0}px, 0)`:"none",zIndex:l?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),e.jsx("button",{className:"event-btn unschedule-btn",onClick:async s=>{s.stopPropagation(),s.preventDefault();try{await useSchedulerStore.getState().unscheduleTask(t.id,N)}catch{}},onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onPointerDown:s=>{s.stopPropagation(),s.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]})]},`${t.id}-segment-${g}`))})}),De=B.memo(({machine:t,scheduledEvents:a,currentDate:c,unavailableByMachine:N,dropTargetId:y,hideMachineLabel:x=!1,queryClient:v,dragPreview:h,readOnly:r=!1})=>{const u=b.useMemo(()=>a.filter(l=>l.scheduled_machine_id===t.id),[a,t.id]),d=N[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!x&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(l,m)=>{const _=Math.floor(m/4)+6,n=m%4*15,o=d?d.has(_.toString()):!1,H=`${t.id}-${_}-${n}`;return e.jsx(be,{machine:t,hour:_,minute:n,isUnavailable:o,hasScheduledTask:!1,dropTargetId:y,slotId:H,dragPreview:h},H)}),u.length>0&&u.map(l=>e.jsx(Me,{event:l,machine:t,currentDate:c,queryClient:v,readOnly:r},`event-${l.id}`))]})]})},(t,a)=>t.machine.id===a.machine.id&&t.machine.machine_name===a.machine.machine_name&&t.machine.work_center===a.machine.work_center&&t.scheduledEvents===a.scheduledEvents&&t.currentDate.getTime()===a.currentDate.getTime()&&t.unavailableByMachine===a.unavailableByMachine&&t.hideMachineLabel===a.hideMachineLabel&&t.queryClient===a.queryClient&&t.dragPreview===a.dragPreview&&t.readOnly===a.readOnly),we=B.memo(({machines:t,currentDate:a,scheduledTasks:c})=>{const N=oe(),y=b.useMemo(()=>{const r=xe(a,{weekStartsOn:_e.APP.FIRST_DAY_OF_WEEK}),u=[];for(let d=0;d<7;d++){const l=new Date(r);l.setUTCDate(r.getUTCDate()+d),u.push(l)}return u},[a]),x=b.useCallback((r,u)=>c.filter(d=>{if(d.scheduled_machine_id!==r||!d.scheduled_start_time)return!1;const l=te(d);if(l&&l.segments&&l.segments.length>0){const m=new Date(u+"T00:00:00Z"),_=new Date(m.getTime()+1440*60*1e3);return l.segments.some(n=>{const o=new Date(n.start),H=new Date(n.end);return o<_&&H>m})}else return z(new Date(d.scheduled_start_time),"yyyy-MM-dd")===u}),[c]),v=b.useCallback(r=>{N(`/backlog/${r.id}/edit`)},[N]),h=b.useCallback((r,u)=>x(r,u).length,[x]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),y.map(r=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:z(r,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:z(r,"yyyy-MM-dd")})]},r.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(r=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:r.machine_name}),e.jsx("div",{className:"machine-city",children:r.work_center})]}),y.map(u=>{const d=z(u,"yyyy-MM-dd"),l=x(r.id,d).sort((n,o)=>new Date(n.scheduled_start_time)-new Date(o.scheduled_start_time)),m=h(r.id,d),_=u.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${_?"today":""} ${m>0?"has-tasks":""}`,children:l.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[m," task",m!==1?"s":""]}),l.slice(0,3).map(n=>e.jsxs("div",{className:"day-task-item",title:`${n.odp_number} - ${n.article_code||"Codice articolo FLEXI"} - ${n.time_remaining?Number(n.time_remaining).toFixed(1):(n.duration||1).toFixed(1)}h`,children:[e.jsxs("div",{className:"day-task-content",children:[e.jsx("span",{className:"task-odp",children:n.odp_number}),e.jsxs("span",{className:"task-duration",children:[n.time_remaining?Number(n.time_remaining).toFixed(1):(n.duration||1).toFixed(1),"h"]})]}),e.jsxs("div",{className:"day-task-controls",children:[e.jsx("button",{className:"event-btn info-btn",onClick:o=>{o.stopPropagation(),o.preventDefault()},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:`Codice Articolo: ${n.article_code||"Non specificato"}
Codice Articolo Esterno: ${n.external_article_code||"Non specificato"}
Nome Cliente: ${n.nome_cliente||"Non specificato"}
Data Consegna: ${n.delivery_date?re(n.delivery_date):"Non impostata"}
Quantità: ${n.quantity||"Non specificata"}
Altezza Busta: ${n.bag_height||"Non specificata"} mm
Passo Busta: ${n.bag_step||"Non specificato"} mm
Note Libere: ${n.user_notes||"Nessuna nota"}
Note ASD: ${n.asd_notes||"Nessuna nota"}
Material Global: ${n.material_availability_global||"N/A"}%

${n.scheduled_end_time?`Fine Programmata: ${ee(n.scheduled_end_time)}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"10px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:o=>{o.stopPropagation(),o.preventDefault(),v(n)},onMouseDown:o=>{o.stopPropagation(),o.preventDefault()},onPointerDown:o=>{o.stopPropagation(),o.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"8",height:"8",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})})]})]},n.id)),l.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",l.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${r.id}-${d}`)})]},r.id))})]})}),Ee=B.memo(({machines:t,currentDate:a,dropTargetId:c,dragPreview:N,onNavigateToNextDay:y,onNavigateToPreviousDay:x,readOnly:v=!1})=>{const[h,r]=b.useState(()=>localStorage.getItem("schedulerView")||"Daily"),[u,d]=b.useState(null),{data:l=[]}=de(),m=b.useMemo(()=>l.filter(i=>i.status==="SCHEDULED"),[l]),_=me(),n=b.useMemo(()=>z(a,"yyyy-MM-dd"),[a]),{data:o=[],isLoading:H,error:se}=ue(n),ae=b.useMemo(()=>{if(h!=="Daily")return{};if(!Array.isArray(o)||o.length===0)return{};const i={};for(let g=0;g<o.length;g++){const s=o[g];s.machine_id&&s.unavailable_hours&&(i[s.machine_id]=new Set(s.unavailable_hours.map($=>$.toString())))}return i},[o,h]),K=b.useMemo(()=>Array.from({length:16},(i,g)=>{const s=g+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${g*4+1} / span 4`},children:s.toString().padStart(2,"0")},s)}),[]);return b.useEffect(()=>{const i=()=>{const s=E(new Date,fe),$=s.getHours(),L=s.getMinutes();if($>=M.WORK_START_HOUR&&$<M.WORK_END_HOUR){const F=($-M.WORK_START_HOUR)*M.SLOTS_PER_HOUR+Math.floor(L/M.MINUTES_PER_SLOT),P=L%M.MINUTES_PER_SLOT/M.MINUTES_PER_SLOT,W=F*M.SLOT_WIDTH_PX+P*M.SLOT_WIDTH_PX;d(W)}else d(null)};i();const g=setInterval(i,6e4);return()=>clearInterval(g)},[]),!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsx("div",{className:"calendar-section",children:e.jsxs("div",{className:"gantt-chart-wrapper",children:[e.jsxs("div",{className:"gantt-controls-bar",children:[e.jsxs("div",{className:"gantt-date-navigation",children:[e.jsx(ne,{variant:"secondary",size:"sm",onClick:()=>x&&x(h),children:"<"}),e.jsx("span",{className:"current-date",children:z(a,"dd/MM/yyyy")}),e.jsx(ne,{variant:"secondary",size:"sm",onClick:()=>y&&y(h),children:">"})]}),e.jsx("div",{className:"gantt-view-selector",children:e.jsxs(he,{value:h,onValueChange:i=>{r(i),localStorage.setItem("schedulerView",i)},children:[e.jsx(ge,{className:"view-selector",children:e.jsx(pe,{})}),e.jsxs(ye,{children:[e.jsx(ie,{value:"Daily",children:"Vista Giornaliera"}),e.jsx(ie,{value:"Weekly",children:"Vista Settimanale"})]})]})})]}),e.jsx("div",{className:"gantt-scroll-container",children:e.jsx("div",{className:"calendar-grid-container",children:h==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header sticky-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(i=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:i.machine_name}),e.jsx("div",{className:"machine-city",children:i.work_center})]},i.id))})]}),!v&&e.jsx(PreviousDayDropZone,{currentDate:a,onNavigateToPreviousDay:()=>x&&x(h),isDragOver:c==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row sticky-header",children:K}),e.jsxs("div",{className:"time-grid-body",style:{position:"relative"},children:[t.map(i=>e.jsx(De,{machine:i,scheduledEvents:m,currentDate:a,unavailableByMachine:ae,dropTargetId:c,hideMachineLabel:!0,queryClient:_,dragPreview:N,readOnly:v},i.id)),u!==null&&e.jsx("div",{style:{position:"absolute",left:`${u}px`,top:0,bottom:0,width:"2px",backgroundColor:"#ef4444",zIndex:100,pointerEvents:"none"}})]})]})]}):e.jsx(we,{machines:t,currentDate:a,scheduledTasks:m})})})]})})});export{Ee as default};
