import{n as ae,s as K,t as ne,i as te,r as h,h as $,c as Y,j as e,R,b as ie,k as oe,l as re,B as J,S as le,m as ce,o as de,p as ue,q as ee,u as se,v as X,w as me,A as he,a as ge,g as pe}from"./index-BhUHfiJB.js";function O(t,s,n){const[b,y]=ae(n?.in,t,s);return+K(b)==+K(y)}function ye(t,s){const n=ne(t,s?.in);return n.setHours(23,59,59,999),n}function fe(t,s,n){return te(t,-1,n)}const xe=({currentDate:t,onNavigateToNextDay:s,isDragOver:n})=>{const[b,y]=h.useState(!1),[i,c]=h.useState(null),f=te(t,1),M=$(f,"yyyy-MM-dd"),{setNodeRef:r}=Y({id:"next-day-drop-zone",data:{type:"next-day",targetDate:f,currentDate:t}});h.useEffect(()=>{if(n&&!i){const x=setTimeout(()=>{s(),c(null)},1600);c(x)}else!n&&i&&(clearTimeout(i),c(null));return()=>{i&&clearTimeout(i)}},[n,s,i]);const u=h.useCallback(()=>{y(!0)},[]),d=h.useCallback(()=>{y(!1)},[]),m=h.useCallback(()=>{i&&(clearTimeout(i),c(null)),s()},[s,i]),g=n||b||i;return e.jsxs("div",{ref:r,className:`next-day-drop-zone ${g?"active":""}`,onMouseEnter:u,onMouseLeave:d,onClick:m,title:`Trascina qui per andare al giorno successivo (${M})`,children:[e.jsx("div",{className:"next-day-content",children:e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})})}),e.jsx("div",{className:"next-day-bg-effect"}),g&&e.jsx("div",{className:"next-day-pulse"})]})},ve=({currentDate:t,onNavigateToPreviousDay:s,isDragOver:n})=>{const[b,y]=h.useState(!1),[i,c]=h.useState(null),f=fe(t),M=$(f,"yyyy-MM-dd"),{setNodeRef:r}=Y({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:f,currentDate:t}});h.useEffect(()=>{if(n&&!i){const x=setTimeout(()=>{s(),c(null)},1600);c(x)}else!n&&i&&(clearTimeout(i),c(null));return()=>{i&&clearTimeout(i)}},[n,s,i]);const u=h.useCallback(()=>{y(!0)},[]),d=h.useCallback(()=>{y(!1)},[]),m=h.useCallback(()=>{i&&(clearTimeout(i),c(null)),s()},[s,i]),g=n||b||i;return e.jsxs("div",{ref:r,className:`previous-day-drop-zone ${g?"active":""}`,onMouseEnter:u,onMouseLeave:d,onClick:m,title:`Trascina qui per andare al giorno precedente (${M})`,children:[e.jsx("div",{className:"previous-day-content",children:e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})})}),e.jsx("div",{className:"previous-day-bg-effect"}),g&&e.jsx("div",{className:"previous-day-pulse"})]})},je=R.memo(({machine:t,hour:s,minute:n,isUnavailable:b,hasScheduledTask:y,dropTargetId:i,slotId:c,dragPreview:f})=>{const{setNodeRef:M}=Y({id:`slot-${t.id}-${s}-${n}`,data:{machine:t,hour:s,minute:n,type:"slot",isUnavailable:b,hasScheduledTask:y}}),r=`time-slot${b?" unavailable":""}${y?" has-scheduled-task":""}`,u=i===c,d=(s-6)*4+Math.floor(n/15),m=f?.isActive&&f.machineId===t.id&&d>=f.startSlot&&d<f.startSlot+f.durationSlots;return e.jsxs("div",{ref:M,className:r,"data-hour":s,"data-minute":n,"data-machine-id":t.id,style:{position:"relative"},children:[u&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}}),m&&e.jsx("div",{className:"drag-preview-indicator",style:{position:"absolute",top:"0px",left:"0px",right:"0px",bottom:"0px",background:"rgba(59, 130, 246, 0.3)",border:"2px solid #3b82f6",pointerEvents:"none",zIndex:999,borderRadius:"2px"}})]})}),be=R.memo(({event:t,machine:s,currentDate:n,queryClient:b})=>{const y=se(),{getSplitTaskInfo:i,splitTasksInfo:c}=X(),{schedulingLoading:f}=ge(),{attributes:M,listeners:r,setNodeRef:u,transform:d,isDragging:m}=pe({id:`event-${t.id}`,data:{event:t,type:"event",machine:s},disabled:!1}),g=h.useMemo(()=>{const l=i(t.id),j=K(n),a=ye(n),T=t.duration||1,I=t.progress||0,V=T*(I/100);if(!l||!l.segments){if(console.warn(`⚠️ No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const A=new Date(t.scheduled_start_time),D=t.time_remaining||t.duration||1,k=new Date(A.getTime()+D*60*60*1e3),v={start:A,end:k},H=O(v.start,n),E=O(v.end,n),q=v.start<a&&v.end>j;if(!H&&!E&&!q)return null;let S,w;if(H&&E){const _=v.start.getUTCHours(),C=v.start.getUTCMinutes(),z=v.end.getUTCHours(),N=v.end.getUTCMinutes(),G=Math.max(6,_),Q=Math.min(22,z),F=(G-6)*4+Math.floor(C/15),Z=(Q-6)*4+Math.ceil(N/15);S=F*15,w=(Z-F)*15}else if(H){const _=v.start.getUTCHours(),C=v.start.getUTCMinutes(),N=(Math.max(6,_)-6)*4+Math.floor(C/15);S=N*15,w=(64-N)*15}else if(E){const _=v.end.getUTCHours(),C=v.end.getUTCMinutes(),N=(Math.min(22,_)-6)*4+Math.ceil(C/15);S=0,w=N*15}else S=0,w=960;const P=I;return[{left:S,width:w,start:v.start,end:v.end,progress:P,duration:D}]}const U=[];let B=0;for(const A of l.segments){const D=new Date(A.start),k=new Date(A.end),v=A.duration||0,H=O(D,n),E=O(k,n),q=D<a&&k>j;if(H||E||q){let S,w;if(H&&E){const _=D.getUTCHours(),C=D.getUTCMinutes(),z=k.getUTCHours(),N=k.getUTCMinutes(),G=Math.max(6,_),Q=Math.min(22,z),F=(G-6)*4+Math.floor(C/15),Z=(Q-6)*4+Math.ceil(N/15);S=F*15,w=(Z-F)*15}else if(H){const _=D.getUTCHours(),C=D.getUTCMinutes(),N=(Math.max(6,_)-6)*4+Math.floor(C/15);S=N*15,w=(64-N)*15}else if(E){const _=k.getUTCHours(),C=k.getUTCMinutes(),N=(Math.min(22,_)-6)*4+Math.ceil(C/15);S=0,w=N*15}else S=0,w=960;let P=0;V>B&&(P=Math.min(v,V-B)/v*100),U.push({left:S,width:w,start:D,end:k,progress:P,duration:v}),B+=v}}return U.length>0?U:null},[t.id,n,i,c]),x=g?g.reduce((l,j)=>l+j.width,0):0,o=x<60,p=x<120,L=o&&x<80,W=x<40;return!g||g.length===0?null:e.jsx(e.Fragment,{children:g.map((l,j)=>e.jsxs("div",{ref:j===0?u:void 0,style:{position:"absolute",left:`${l.left}px`,width:`${l.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${o?"very-small":""} ${p?"small":""} ${W?"extremely-narrow":""} ${g.length>1?"split-segment":""} ${f.taskId===t.id&&(f.isScheduling||f.isRescheduling||f.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,j===0&&(()=>{const a=i(t.id);return a&&a.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${a.totalSegments} segments`,children:"✂️"}):null})()]})}),l.progress&&l.progress>0&&e.jsx("div",{className:"progress-bar-overlay",style:{width:`${Math.min(l.progress,100)}%`}}),j===0&&e.jsxs("div",{className:`event-controls ${L?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:a=>{a.stopPropagation(),a.preventDefault()},onMouseDown:a=>{a.stopPropagation(),a.preventDefault()},onPointerDown:a=>{a.stopPropagation(),a.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?$(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
Altezza Busta: ${t.bag_height||"Non specificata"} mm
Passo Busta: ${t.bag_step||"Non specificato"} mm
Note Libere: ${t.user_notes||"Nessuna nota"}
Note ASD: ${t.asd_notes||"Nessuna nota"}
Material Global: ${t.material_availability_global||"N/A"}%
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:a=>{a.stopPropagation(),a.preventDefault(),y(`/backlog/${t.id}/edit`)},onMouseDown:a=>{a.stopPropagation(),a.preventDefault()},onPointerDown:a=>{a.stopPropagation(),a.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("div",{className:"drag-handle",...r,...M,style:{transform:m?`translate3d(${d?.x||0}px, ${d?.y||0}px, 0)`:"none",zIndex:m?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),e.jsx("button",{className:"event-btn unschedule-btn",onClick:async a=>{a.stopPropagation(),a.preventDefault();try{await X.getState().unscheduleTask(t.id,b)}catch(T){console.error("Error unscheduling task:",T)}},onMouseDown:a=>{a.stopPropagation(),a.preventDefault()},onPointerDown:a=>{a.stopPropagation(),a.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${j}`))})}),Me=R.memo(({machine:t,scheduledEvents:s,currentDate:n,unavailableByMachine:b,dropTargetId:y,hideMachineLabel:i=!1,queryClient:c,dragPreview:f})=>{const M=h.useMemo(()=>s.filter(u=>u.scheduled_machine_id===t.id),[s,t.id]),r=b[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!i&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(u,d)=>{const m=Math.floor(d/4)+6,g=d%4*15,x=r?r.has(m.toString()):!1,o=`${t.id}-${m}-${g}`;return e.jsx(je,{machine:t,hour:m,minute:g,isUnavailable:x,hasScheduledTask:!1,dropTargetId:y,slotId:o,dragPreview:f},o)}),M.length>0&&M.map(u=>e.jsx(be,{event:u,machine:t,currentDate:n,queryClient:c},`event-${u.id}`))]})]})},(t,s)=>t.machine.id===s.machine.id&&t.machine.machine_name===s.machine.machine_name&&t.machine.work_center===s.machine.work_center&&t.scheduledEvents===s.scheduledEvents&&t.currentDate.getTime()===s.currentDate.getTime()&&t.unavailableByMachine===s.unavailableByMachine&&t.hideMachineLabel===s.hideMachineLabel&&t.queryClient===s.queryClient&&t.dragPreview===s.dragPreview),Ne=R.memo(({machines:t,currentDate:s,scheduledTasks:n})=>{const b=se(),{getSplitTaskInfo:y}=X(),i=h.useMemo(()=>{const r=me(s,{weekStartsOn:he.APP.FIRST_DAY_OF_WEEK}),u=[];for(let d=0;d<7;d++){const m=new Date(r);m.setUTCDate(r.getUTCDate()+d),u.push(m)}return u},[s]),c=h.useCallback((r,u)=>n.filter(d=>{if(d.scheduled_machine_id!==r||!d.scheduled_start_time)return!1;const m=y(d.id);if(m&&m.segments&&m.segments.length>0){const g=new Date(u+"T00:00:00Z"),x=new Date(g.getTime()+1440*60*1e3);return m.segments.some(o=>{const p=new Date(o.start),L=new Date(o.end);return p<x&&L>g})}else return $(new Date(d.scheduled_start_time),"yyyy-MM-dd")===u}),[n,y]),f=h.useCallback(r=>{b(`/backlog/${r.id}/edit`)},[b]),M=h.useCallback((r,u)=>c(r,u).length,[c]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),i.map(r=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:$(r,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:$(r,"yyyy-MM-dd")})]},r.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(r=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:r.machine_name}),e.jsx("div",{className:"machine-city",children:r.work_center})]}),i.map(u=>{const d=$(u,"yyyy-MM-dd"),m=c(r.id,d).sort((o,p)=>new Date(o.scheduled_start_time)-new Date(p.scheduled_start_time)),g=M(r.id,d),x=u.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${x?"today":""} ${g>0?"has-tasks":""}`,children:m.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[g," task",g!==1?"s":""]}),m.slice(0,3).map(o=>e.jsxs("div",{className:"day-task-item",title:`${o.odp_number} - ${o.article_code||"Codice articolo FLEXI"} - ${o.time_remaining?Number(o.time_remaining).toFixed(1):(o.duration||1).toFixed(1)}h`,children:[e.jsxs("div",{className:"day-task-content",children:[e.jsx("span",{className:"task-odp",children:o.odp_number}),e.jsxs("span",{className:"task-duration",children:[o.time_remaining?Number(o.time_remaining).toFixed(1):(o.duration||1).toFixed(1),"h"]})]}),e.jsxs("div",{className:"day-task-controls",children:[e.jsx("button",{className:"event-btn info-btn",onClick:p=>{p.stopPropagation(),p.preventDefault()},onMouseDown:p=>{p.stopPropagation(),p.preventDefault()},onPointerDown:p=>{p.stopPropagation(),p.preventDefault()},title:`Codice Articolo: ${o.article_code||"Non specificato"}
Codice Articolo Esterno: ${o.external_article_code||"Non specificato"}
Nome Cliente: ${o.nome_cliente||"Non specificato"}
Data Consegna: ${o.delivery_date?$(new Date(o.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${o.quantity||"Non specificata"}
Altezza Busta: ${o.bag_height||"Non specificata"} mm
Passo Busta: ${o.bag_step||"Non specificato"} mm
Note Libere: ${o.user_notes||"Nessuna nota"}
Note ASD: ${o.asd_notes||"Nessuna nota"}
Material Global: ${o.material_availability_global||"N/A"}%

${o.scheduled_end_time?`Fine Programmata: ${o.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"10px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:p=>{p.stopPropagation(),p.preventDefault(),f(o)},onMouseDown:p=>{p.stopPropagation(),p.preventDefault()},onPointerDown:p=>{p.stopPropagation(),p.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"8",height:"8",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})})]})]},o.id)),m.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",m.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${r.id}-${d}`)})]},r.id))})]})}),Se=R.memo(({machines:t,currentDate:s,dropTargetId:n,dragPreview:b,onNavigateToNextDay:y,onNavigateToPreviousDay:i})=>{const[c,f]=h.useState(()=>localStorage.getItem("schedulerView")||"Daily"),[M,r]=h.useState(null),{odpOrders:u}=ie(),d=h.useMemo(()=>u.filter(l=>l.status==="SCHEDULED"),[u]),m=oe(),g=h.useMemo(()=>$(s,"yyyy-MM-dd"),[s]),{data:x=[],isLoading:o,error:p}=re(g),L=h.useMemo(()=>{if(c!=="Daily")return{};if(!Array.isArray(x)||x.length===0)return{};const l={};for(let j=0;j<x.length;j++){const a=x[j];a.machine_id&&a.unavailable_hours&&(l[a.machine_id]=new Set(a.unavailable_hours.map(T=>T.toString())))}return l},[x,c]),W=h.useMemo(()=>Array.from({length:16},(l,j)=>{const a=j+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${j*4+1} / span 4`},children:a.toString().padStart(2,"0")},a)}),[]);return h.useEffect(()=>{const l=()=>{const a=new Date,T=a.getHours(),I=a.getMinutes();if(T>=6&&T<22){const V=(T-6)*4+Math.floor(I/15),U=I%15/15,B=V*15+U*15;r(B)}else r(null)};l();const j=setInterval(l,6e4);return()=>clearInterval(j)},[]),!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsx("div",{className:"calendar-section",children:e.jsxs("div",{className:"gantt-chart-wrapper",children:[e.jsxs("div",{className:"gantt-controls-bar",children:[e.jsxs("div",{className:"gantt-date-navigation",children:[e.jsx(J,{variant:"secondary",size:"sm",onClick:()=>i&&i(c),children:"<"}),e.jsx("span",{className:"current-date",children:$(s,"dd/MM/yyyy")}),e.jsx(J,{variant:"secondary",size:"sm",onClick:()=>y&&y(c),children:">"})]}),e.jsx("div",{className:"gantt-view-selector",children:e.jsxs(le,{value:c,onValueChange:l=>{f(l),localStorage.setItem("schedulerView",l)},children:[e.jsx(ce,{className:"view-selector",children:e.jsx(de,{})}),e.jsxs(ue,{children:[e.jsx(ee,{value:"Daily",children:"Vista Giornaliera"}),e.jsx(ee,{value:"Weekly",children:"Vista Settimanale"})]})]})})]}),e.jsx("div",{className:"gantt-scroll-container",children:e.jsx("div",{className:"calendar-grid-container",children:c==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header sticky-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(l=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:l.machine_name}),e.jsx("div",{className:"machine-city",children:l.work_center})]},l.id))})]}),e.jsx(ve,{currentDate:s,onNavigateToPreviousDay:()=>i&&i(c),isDragOver:n==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row sticky-header",children:W}),e.jsxs("div",{className:"time-grid-body",style:{position:"relative"},children:[t.map(l=>e.jsx(Me,{machine:l,scheduledEvents:d,currentDate:s,unavailableByMachine:L,dropTargetId:n,hideMachineLabel:!0,queryClient:m,dragPreview:b},l.id)),M!==null&&e.jsx("div",{style:{position:"absolute",left:`${M}px`,top:0,bottom:0,width:"2px",backgroundColor:"#ef4444",zIndex:100,pointerEvents:"none"}})]})]}),e.jsx(xe,{currentDate:s,onNavigateToNextDay:()=>y&&y(c),isDragOver:n==="next-day-drop-zone"})]}):e.jsx(Ne,{machines:t,currentDate:s,scheduledTasks:d})})})]})})});export{Se as default};
