import{n as Y,s as O,t as J,g as G,r as d,f as T,b as q,j as e,R as P,a as ee,h as W,d as Z,i as te,A as se,u as ae,e as ne}from"./index-CeaSikjg.js";function R(t,o,i){const[c,p]=Y(i?.in,t,o);return+O(c)==+O(p)}function ie(t,o){const i=J(t,o?.in);return i.setHours(23,59,59,999),i}function oe(t,o,i){return G(t,-1,i)}const re=({currentDate:t,onNavigateToNextDay:o,isDragOver:i})=>{const[c,p]=d.useState(!1),[a,m]=d.useState(null),x=G(t,1),s=T(x,"yyyy-MM-dd"),{setNodeRef:u}=q({id:"next-day-drop-zone",data:{type:"next-day",targetDate:x,currentDate:t}});d.useEffect(()=>{if(i&&!a){const n=setTimeout(()=>{o(),m(null)},1600);m(n)}else!i&&a&&(clearTimeout(a),m(null));return()=>{a&&clearTimeout(a)}},[i,o,a]);const l=d.useCallback(()=>{p(!0)},[]),h=d.useCallback(()=>{p(!1)},[]),y=d.useCallback(()=>{a&&(clearTimeout(a),m(null)),o()},[o,a]),v=i||c||a;return e.jsxs("div",{ref:u,className:`next-day-drop-zone ${v?"active":""}`,onMouseEnter:l,onMouseLeave:h,onClick:y,title:`Trascina qui per andare al giorno successivo (${s})`,children:[e.jsxs("div",{className:"next-day-content",children:[e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})}),e.jsxs("div",{className:"next-day-text",children:[e.jsx("div",{className:"next-day-label",children:"Giorno Successivo"}),e.jsx("div",{className:"next-day-date",children:s})]}),e.jsx("div",{className:"next-day-hint",children:a?"Navigazione in corso...":"Trascina qui per andare al giorno successivo"})]}),e.jsx("div",{className:"next-day-bg-effect"}),v&&e.jsx("div",{className:"next-day-pulse"})]})},le=({currentDate:t,onNavigateToPreviousDay:o,isDragOver:i})=>{const[c,p]=d.useState(!1),[a,m]=d.useState(null),x=oe(t),s=T(x,"yyyy-MM-dd"),{setNodeRef:u}=q({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:x,currentDate:t}});d.useEffect(()=>{if(i&&!a){const n=setTimeout(()=>{o(),m(null)},1600);m(n)}else!i&&a&&(clearTimeout(a),m(null));return()=>{a&&clearTimeout(a)}},[i,o,a]);const l=d.useCallback(()=>{p(!0)},[]),h=d.useCallback(()=>{p(!1)},[]),y=d.useCallback(()=>{a&&(clearTimeout(a),m(null)),o()},[o,a]),v=i||c||a;return e.jsxs("div",{ref:u,className:`previous-day-drop-zone ${v?"active":""}`,onMouseEnter:l,onMouseLeave:h,onClick:y,title:`Trascina qui per andare al giorno precedente (${s})`,children:[e.jsxs("div",{className:"previous-day-content",children:[e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})}),e.jsxs("div",{className:"previous-day-text",children:[e.jsx("div",{className:"previous-day-label",children:"Giorno Precedente"}),e.jsx("div",{className:"previous-day-date",children:s})]}),e.jsx("div",{className:"previous-day-hint",children:a?"Navigazione in corso...":"Trascina qui per andare al giorno precedente"})]}),e.jsx("div",{className:"previous-day-bg-effect"}),v&&e.jsx("div",{className:"previous-day-pulse"})]})},de=P.memo(({machine:t,hour:o,minute:i,isUnavailable:c,hasScheduledTask:p,dropTargetId:a,slotId:m})=>{const{setNodeRef:x}=q({id:`slot-${t.id}-${o}-${i}`,data:{machine:t,hour:o,minute:i,type:"slot",isUnavailable:c,hasScheduledTask:p}}),s=`time-slot${c?" unavailable":""}${p?" has-scheduled-task":""}`,u=a===m;return e.jsx("div",{ref:x,className:s,"data-hour":o,"data-minute":i,"data-machine-id":t.id,style:{position:"relative"},children:u&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}})})}),ce=P.memo(({event:t,machine:o,currentDate:i})=>{const[c,p]=d.useState(!0),a=Z(),{getSplitTaskInfo:m,splitTasksInfo:x}=W(),{schedulingLoading:s}=ae(),{attributes:u,listeners:l,setNodeRef:h,transform:y,isDragging:v}=ne({id:`event-${t.id}`,data:{event:t,type:"event",machine:o},disabled:c}),n=d.useMemo(()=>{const b=m(t.id),w=O(i),r=ie(i);if(!b||!b.segments){if(console.warn(`⚠️ No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const U=new Date(t.scheduled_start_time),_=t.time_remaining||t.duration||1,k=new Date(U.getTime()+_*60*60*1e3),g={start:U,end:k},H=R(g.start,i),A=R(g.end,i),E=g.start<r&&g.end>w;if(!H&&!A&&!E)return null;let f,j;if(H&&A){const N=g.start.getUTCHours(),$=g.start.getUTCMinutes(),S=g.end.getUTCHours(),D=g.end.getUTCMinutes(),B=Math.max(6,N),I=Math.min(22,S),F=(B-6)*4+Math.floor($/15),X=(I-6)*4+Math.ceil(D/15);f=F*15,j=(X-F)*15}else if(H){const N=g.start.getUTCHours(),$=g.start.getUTCMinutes(),D=(Math.max(6,N)-6)*4+Math.floor($/15);f=D*15,j=(64-D)*15}else if(A){const N=g.end.getUTCHours(),$=g.end.getUTCMinutes(),D=(Math.min(22,N)-6)*4+Math.ceil($/15);f=0,j=D*15}else f=0,j=960;return[{left:f,width:j,start:g.start,end:g.end}]}const L=[];for(const U of b.segments){const _=new Date(U.start),k=new Date(U.end),g=R(_,i),H=R(k,i),A=_<r&&k>w;if(g||H||A){let E,f;if(g&&H){const j=_.getUTCHours(),N=_.getUTCMinutes(),$=k.getUTCHours(),S=k.getUTCMinutes(),D=Math.max(6,j),B=Math.min(22,$),I=(D-6)*4+Math.floor(N/15),F=(B-6)*4+Math.ceil(S/15);E=I*15,f=(F-I)*15}else if(g){const j=_.getUTCHours(),N=_.getUTCMinutes(),S=(Math.max(6,j)-6)*4+Math.floor(N/15);E=S*15,f=(64-S)*15}else if(H){const j=k.getUTCHours(),N=k.getUTCMinutes(),S=(Math.min(22,j)-6)*4+Math.ceil(N/15);E=0,f=S*15}else E=0,f=960;L.push({left:E,width:f,start:_,end:k})}}return L.length>0?L:null},[t.id,i,m,x]),M=n?n.reduce((b,w)=>b+w.width,0):0,C=M<60,z=M<120,V=C&&M<80,K=M<40,Q=d.useCallback(b=>{b.stopPropagation(),p(!c)},[c]);return!n||n.length===0?null:e.jsx(e.Fragment,{children:n.map((b,w)=>e.jsxs("div",{ref:w===0?h:void 0,style:{position:"absolute",left:`${b.left}px`,width:`${b.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${C?"very-small":""} ${z?"small":""} ${K?"extremely-narrow":""} ${n.length>1?"split-segment":""} ${s.taskId===t.id&&(s.isScheduling||s.isRescheduling||s.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,w===0&&(()=>{const r=m(t.id);return r&&r.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${r.totalSegments} segments`,children:"✂️"}):null})()]})}),w===0&&e.jsxs("div",{className:`event-controls ${V?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:r=>{r.stopPropagation(),r.preventDefault()},onMouseDown:r=>{r.stopPropagation(),r.preventDefault()},onPointerDown:r=>{r.stopPropagation(),r.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?T(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
Note Libere: ${t.user_notes||"Nessuna nota"}
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:r=>{r.stopPropagation(),r.preventDefault(),a(`/backlog/${t.id}/edit`)},onMouseDown:r=>{r.stopPropagation(),r.preventDefault()},onPointerDown:r=>{r.stopPropagation(),r.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${c?"locked":"unlocked"}`,onClick:Q,title:c?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:c?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!c&&e.jsx("div",{className:"drag-handle",...l,...u,style:{transform:v?`translate3d(${y?.x||0}px, ${y?.y||0}px, 0)`:"none",zIndex:v?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!c&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async r=>{r.stopPropagation(),r.preventDefault();try{await W.getState().unscheduleTask(t.id)}catch(L){console.error("Error unscheduling task:",L)}},onMouseDown:r=>{r.stopPropagation(),r.preventDefault()},onPointerDown:r=>{r.stopPropagation(),r.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${w}`))})}),ue=P.memo(({machine:t,scheduledEvents:o,currentDate:i,unavailableByMachine:c,dropTargetId:p,hideMachineLabel:a=!1})=>{const m=d.useMemo(()=>o.filter(s=>s.scheduled_machine_id===t.id),[o,t.id]),x=c[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!a&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(s,u)=>{const l=Math.floor(u/4)+6,h=u%4*15,y=x?x.has(l.toString()):!1,v=`${t.id}-${l}-${h}`;return e.jsx(de,{machine:t,hour:l,minute:h,isUnavailable:y,hasScheduledTask:!1,dropTargetId:p,slotId:v},v)}),m.length>0&&m.map(s=>e.jsx(ce,{event:s,machine:t,currentDate:i},`event-${s.id}`))]})]})}),me=P.memo(({machines:t,currentDate:o,scheduledTasks:i})=>{const c=Z(),p=d.useMemo(()=>{const s=te(o,{weekStartsOn:se.APP.FIRST_DAY_OF_WEEK}),u=[];for(let l=0;l<7;l++){const h=new Date(s);h.setUTCDate(s.getUTCDate()+l),u.push(h)}return u},[o]),a=d.useCallback((s,u)=>i.filter(l=>l.scheduled_machine_id===s&&l.scheduled_start_time&&T(new Date(l.scheduled_start_time),"yyyy-MM-dd")===u),[i]),m=d.useCallback(s=>{c(`/backlog/${s.id}/edit`)},[c]),x=d.useCallback((s,u)=>a(s,u).length,[a]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),p.map(s=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:T(s,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:T(s,"yyyy-MM-dd")})]},s.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(s=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:s.machine_name}),e.jsx("div",{className:"machine-city",children:s.work_center})]}),p.map(u=>{const l=T(u,"yyyy-MM-dd"),h=a(s.id,l),y=x(s.id,l),v=u.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${v?"today":""} ${y>0?"has-tasks":""}`,children:h.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[y," task",y!==1?"s":""]}),h.slice(0,3).map(n=>e.jsxs("div",{className:"day-task-item",onClick:()=>m(n),title:`${n.odp_number} - ${n.article_code||"Codice articolo FLEXI"} - ${n.time_remaining?Number(n.time_remaining).toFixed(1):(n.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:n.odp_number}),e.jsxs("span",{className:"task-duration",children:[n.time_remaining?Number(n.time_remaining).toFixed(1):(n.duration||1).toFixed(1),"h"]})]},n.id)),h.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",h.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${s.id}-${l}`)})]},s.id))})]})}),pe=P.memo(({machines:t,currentDate:o,dropTargetId:i,onNavigateToNextDay:c,onNavigateToPreviousDay:p})=>{const[a,m]=d.useState("Daily"),{odpOrders:x}=ee(),s=d.useMemo(()=>x.filter(n=>n.status==="SCHEDULED"),[x]),{loadMachineAvailabilityForDate:u,machineAvailability:l}=W(),h=d.useMemo(()=>T(o,"yyyy-MM-dd"),[o]);d.useEffect(()=>(a==="Daily"&&!l[h]?._loading&&u(h),()=>{}),[h,u,a,l]);const y=d.useMemo(()=>{if(a!=="Daily")return{};const n=l[h];if(!Array.isArray(n)||n.length===0)return{};const M={};for(let C=0;C<n.length;C++){const z=n[C];z.machine_id&&z.unavailable_hours&&(M[z.machine_id]=new Set(z.unavailable_hours.map(V=>V.toString())))}return M},[l,h,a]),v=d.useMemo(()=>Array.from({length:16},(n,M)=>{const C=M+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${M*4+1} / span 4`},children:C.toString().padStart(2,"0")},C)}),[]);return!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsxs("div",{className:"calendar-section",children:[e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:a,onChange:n=>m(n.target.value),className:"view-selector",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})}),e.jsx("div",{className:"calendar-grid-container",children:a==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(n=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:n.machine_name}),e.jsx("div",{className:"machine-city",children:n.work_center})]},n.id))})]}),e.jsx(le,{currentDate:o,onNavigateToPreviousDay:p,isDragOver:i==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row",children:v}),e.jsx("div",{className:"time-grid-body",children:t.map(n=>e.jsx(ue,{machine:n,scheduledEvents:s,currentDate:o,unavailableByMachine:y,dropTargetId:i,hideMachineLabel:!0},n.id))})]}),e.jsx(re,{currentDate:o,onNavigateToNextDay:c,isDragOver:i==="next-day-drop-zone"})]}):e.jsx(me,{machines:t,currentDate:o,scheduledTasks:s})})]})});export{pe as default};
