<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Migration - Flexi Production Suite</title>
    <link rel="stylesheet" href="../styles/consolidated.css">
    <style>
        .migration-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .migration-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .migration-status {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
        }
        
        .status-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .migration-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }
        
        .migration-log {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        
        .log-entry {
            padding: 0.25rem 0;
        }
        
        .log-info {
            color: #0c5460;
        }
        
        .log-success {
            color: #155724;
        }
        
        .log-warning {
            color: #856404;
        }
        
        .log-error {
            color: #721c24;
        }
        
        .data-preview {
            margin-top: 2rem;
        }
        
        .preview-section {
            margin-bottom: 2rem;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .preview-table th,
        .preview-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .preview-table tr:last-child td {
            border-bottom: none;
        }
        
        .config-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .config-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .config-item label {
            cursor: pointer;
            user-select: none;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: start;
            gap: 1rem;
        }
        
        .warning-icon {
            font-size: 1.5rem;
            color: #f39c12;
        }
        
        .warning-content h3 {
            margin: 0 0 0.5rem 0;
            color: #856404;
        }
        
        .warning-content p {
            margin: 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>Flexi Production Suite</h1>
        </div>
        <ul class="nav-menu" id="navMenu">
            <li class="nav-item"><a href="index.html" class="nav-link">Dashboard</a></li>
            <li class="nav-item"><a href="scheduler-page.html" class="nav-link">Scheduler</a></li>
            <li class="nav-item"><a href="machinery-page.html" class="nav-link">Machinery</a></li>
            <li class="nav-item"><a href="phases-page.html" class="nav-link">Phases</a></li>
            <li class="nav-item"><a href="backlog-page.html" class="nav-link">Backlog</a></li>
            <li class="nav-item"><a href="migration.html" class="nav-link active">Migration</a></li>
        </ul>
    </nav>

    <div class="migration-container">
        <div class="migration-header">
            <h1>Database Migration</h1>
            <p>Migrate your data from localStorage to Supabase backend</p>
        </div>

        <div class="warning-box">
            <div class="warning-icon">⚠️</div>
            <div class="warning-content">
                <h3>Important Notice</h3>
                <p>This migration will transfer all your local data to the Supabase cloud database. 
                   Please ensure you have a stable internet connection and have backed up your data before proceeding.</p>
            </div>
        </div>

        <div class="config-section">
            <h2>Migration Configuration</h2>
            <div class="config-grid">
                <div class="config-item">
                    <input type="checkbox" id="config_dual_write">
                    <label for="config_dual_write">Enable Dual Write (write to both localStorage and Supabase)</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="config_realtime">
                    <label for="config_realtime">Enable Realtime Subscriptions</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="config_log_calls">
                    <label for="config_log_calls">Log Service Calls (for debugging)</label>
                </div>
            </div>
            
            <h3 style="margin-top: 1.5rem;">Feature-by-Feature Migration</h3>
            <div class="config-grid">
                <div class="config-item">
                    <input type="checkbox" id="feature_machines">
                    <label for="feature_machines">Use Supabase for Machines</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="feature_phases">
                    <label for="feature_phases">Use Supabase for Phases</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="feature_odp_orders">
                    <label for="feature_odp_orders">Use Supabase for ODP Orders</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="feature_scheduled_events">
                    <label for="feature_scheduled_events">Use Supabase for Scheduled Events</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="feature_machine_availability">
                    <label for="feature_machine_availability">Use Supabase for Machine Availability</label>
                </div>
            </div>
        </div>

        <div class="migration-status">
            <h2>Connection Status</h2>
            <div class="status-item">
                <span class="status-label">Supabase Connection:</span>
                <span class="status-value">
                    <span id="supabase_status" class="status-badge badge-info">Not Checked</span>
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">LocalStorage Available:</span>
                <span class="status-value">
                    <span id="localstorage_status" class="status-badge badge-info">Not Checked</span>
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">Current Storage Mode:</span>
                <span class="status-value">
                    <span id="storage_mode" class="status-badge badge-info">localStorage</span>
                </span>
            </div>
        </div>

        <div class="migration-status">
            <h2>Data Summary</h2>
            <div class="status-item">
                <span class="status-label">Machines:</span>
                <span class="status-value">
                    <span id="count_machines">0</span> records
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">Phases:</span>
                <span class="status-value">
                    <span id="count_phases">0</span> records
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">ODP Orders:</span>
                <span class="status-value">
                    <span id="count_odp_orders">0</span> records
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">Scheduled Events:</span>
                <span class="status-value">
                    <span id="count_scheduled_events">0</span> records
                </span>
            </div>
        </div>

        <div class="migration-actions">
            <button id="check_connection_btn" class="btn btn-secondary">Check Connections</button>
            <button id="preview_data_btn" class="btn btn-secondary">Preview Data</button>
            <button id="backup_data_btn" class="btn btn-secondary">Backup Data</button>
            <button id="migrate_btn" class="btn btn-primary" disabled>Migrate to Supabase</button>
            <button id="verify_btn" class="btn btn-secondary" disabled>Verify Migration</button>
            <button id="switch_to_supabase_btn" class="btn btn-success" disabled>Switch to Supabase</button>
            <button id="revert_btn" class="btn btn-outline-danger">Revert to localStorage</button>
        </div>

        <div class="data-preview" id="data_preview" style="display: none;">
            <h2>Data Preview</h2>
            <div id="preview_content"></div>
        </div>

        <div class="migration-log">
            <h3>Migration Log</h3>
            <div id="log_container"></div>
        </div>
    </div>

    <!-- Message container for notifications -->
    <div class="message-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../scripts/utils.js"></script>
    <script src="../scripts/storageService.js"></script>
    <script src="../scripts/supabaseClient.js"></script>
    <script src="../scripts/supabaseService.js"></script>
    <script src="../scripts/serviceConfig.js"></script>
    <script src="../scripts/unifiedStorageService.js"></script>
    <script src="../scripts/migrationUtility.js"></script>
    <script>
        // Migration page controller
        class MigrationController {
            constructor() {
                this.migrationUtility = new MigrationUtility();
                this.elements = {};
                this.init();
            }

            init() {
                this.bind_elements();
                this.attach_event_listeners();
                this.load_config();
                this.update_status();
            }

            bind_elements() {
                // Status elements
                this.elements.supabaseStatus = document.getElementById('supabase_status');
                this.elements.localStorageStatus = document.getElementById('localstorage_status');
                this.elements.storageMode = document.getElementById('storage_mode');
                
                // Count elements
                this.elements.countMachines = document.getElementById('count_machines');
                this.elements.countPhases = document.getElementById('count_phases');
                this.elements.countOdpOrders = document.getElementById('count_odp_orders');
                this.elements.countScheduledEvents = document.getElementById('count_scheduled_events');
                
                // Buttons
                this.elements.checkConnectionBtn = document.getElementById('check_connection_btn');
                this.elements.previewDataBtn = document.getElementById('preview_data_btn');
                this.elements.backupDataBtn = document.getElementById('backup_data_btn');
                this.elements.migrateBtn = document.getElementById('migrate_btn');
                this.elements.verifyBtn = document.getElementById('verify_btn');
                this.elements.switchToSupabaseBtn = document.getElementById('switch_to_supabase_btn');
                this.elements.revertBtn = document.getElementById('revert_btn');
                
                // Config checkboxes
                this.elements.configDualWrite = document.getElementById('config_dual_write');
                this.elements.configRealtime = document.getElementById('config_realtime');
                this.elements.configLogCalls = document.getElementById('config_log_calls');
                
                // Feature checkboxes
                this.elements.featureMachines = document.getElementById('feature_machines');
                this.elements.featurePhases = document.getElementById('feature_phases');
                this.elements.featureOdpOrders = document.getElementById('feature_odp_orders');
                this.elements.featureScheduledEvents = document.getElementById('feature_scheduled_events');
                this.elements.featureMachineAvailability = document.getElementById('feature_machine_availability');
                
                // Other elements
                this.elements.dataPreview = document.getElementById('data_preview');
                this.elements.previewContent = document.getElementById('preview_content');
                this.elements.logContainer = document.getElementById('log_container');
            }

            attach_event_listeners() {
                this.elements.checkConnectionBtn.addEventListener('click', () => this.check_connections());
                this.elements.previewDataBtn.addEventListener('click', () => this.preview_data());
                this.elements.backupDataBtn.addEventListener('click', () => this.backup_data());
                this.elements.migrateBtn.addEventListener('click', () => this.migrate());
                this.elements.verifyBtn.addEventListener('click', () => this.verify_migration());
                this.elements.switchToSupabaseBtn.addEventListener('click', () => this.switch_to_supabase());
                this.elements.revertBtn.addEventListener('click', () => this.revert_to_localstorage());
                
                // Config change listeners
                this.elements.configDualWrite.addEventListener('change', () => this.update_config());
                this.elements.configRealtime.addEventListener('change', () => this.update_config());
                this.elements.configLogCalls.addEventListener('change', () => this.update_config());
                
                // Feature change listeners
                this.elements.featureMachines.addEventListener('change', () => this.update_config());
                this.elements.featurePhases.addEventListener('change', () => this.update_config());
                this.elements.featureOdpOrders.addEventListener('change', () => this.update_config());
                this.elements.featureScheduledEvents.addEventListener('change', () => this.update_config());
                this.elements.featureMachineAvailability.addEventListener('change', () => this.update_config());
            }

            load_config() {
                // Load current configuration
                this.elements.configDualWrite.checked = ServiceConfig.ENABLE_DUAL_WRITE;
                this.elements.configRealtime.checked = ServiceConfig.ENABLE_REALTIME;
                this.elements.configLogCalls.checked = ServiceConfig.LOG_SERVICE_CALLS;
                
                this.elements.featureMachines.checked = ServiceConfig.USE_SUPABASE.machines;
                this.elements.featurePhases.checked = ServiceConfig.USE_SUPABASE.phases;
                this.elements.featureOdpOrders.checked = ServiceConfig.USE_SUPABASE.odp_orders;
                this.elements.featureScheduledEvents.checked = ServiceConfig.USE_SUPABASE.scheduled_events;
                this.elements.featureMachineAvailability.checked = ServiceConfig.USE_SUPABASE.machine_availability;
            }

            update_config() {
                // Update configuration based on checkboxes
                ServiceConfig.ENABLE_DUAL_WRITE = this.elements.configDualWrite.checked;
                ServiceConfig.ENABLE_REALTIME = this.elements.configRealtime.checked;
                ServiceConfig.LOG_SERVICE_CALLS = this.elements.configLogCalls.checked;
                
                ServiceConfig.USE_SUPABASE.machines = this.elements.featureMachines.checked;
                ServiceConfig.USE_SUPABASE.phases = this.elements.featurePhases.checked;
                ServiceConfig.USE_SUPABASE.odp_orders = this.elements.featureOdpOrders.checked;
                ServiceConfig.USE_SUPABASE.scheduled_events = this.elements.featureScheduledEvents.checked;
                ServiceConfig.USE_SUPABASE.machine_availability = this.elements.featureMachineAvailability.checked;
                
                this.log('Configuration updated', 'info');
            }

            async check_connections() {
                this.log('Checking connections...', 'info');
                
                // Check localStorage
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    this.elements.localStorageStatus.textContent = 'Connected';
                    this.elements.localStorageStatus.className = 'status-badge badge-success';
                } catch (error) {
                    this.elements.localStorageStatus.textContent = 'Error';
                    this.elements.localStorageStatus.className = 'status-badge badge-danger';
                    this.log('localStorage error: ' + error.message, 'error');
                }
                
                // Check Supabase
                const connected = await window.check_supabase_connection();
                if (connected) {
                    this.elements.supabaseStatus.textContent = 'Connected';
                    this.elements.supabaseStatus.className = 'status-badge badge-success';
                    this.elements.migrateBtn.disabled = false;
                    this.log('Supabase connection successful', 'success');
                } else {
                    this.elements.supabaseStatus.textContent = 'Failed';
                    this.elements.supabaseStatus.className = 'status-badge badge-danger';
                    this.log('Supabase connection failed', 'error');
                }
                
                await this.update_counts();
            }

            async update_counts() {
                try {
                    // Get counts from localStorage
                    const machines = window.storageService.get_machines();
                    const phases = window.storageService.get_phases();
                    const odpOrders = window.storageService.get_odp_orders();
                    const scheduledEvents = window.storageService.get_scheduled_events();
                    
                    this.elements.countMachines.textContent = machines.length;
                    this.elements.countPhases.textContent = phases.length;
                    this.elements.countOdpOrders.textContent = odpOrders.length;
                    this.elements.countScheduledEvents.textContent = scheduledEvents.length;
                } catch (error) {
                    this.log('Error getting counts: ' + error.message, 'error');
                }
            }

            async preview_data() {
                this.log('Loading data preview...', 'info');
                
                try {
                    const machines = window.storageService.get_machines();
                    const phases = window.storageService.get_phases();
                    const odpOrders = window.storageService.get_odp_orders();
                    
                    let html = '';
                    
                    // Machines preview
                    if (machines.length > 0) {
                        html += '<div class="preview-section">';
                        html += '<h3>Machines (first 5)</h3>';
                        html += '<table class="preview-table">';
                        html += '<tr><th>Name</th><th>Type</th><th>Department</th><th>Status</th></tr>';
                        machines.slice(0, 5).forEach(machine => {
                            html += `<tr>
                                <td>${machine.machine_name || '-'}</td>
                                <td>${machine.machine_type || '-'}</td>
                                <td>${machine.department || '-'}</td>
                                <td>${machine.status || '-'}</td>
                            </tr>`;
                        });
                        html += '</table>';
                        html += '</div>';
                    }
                    
                    // Phases preview
                    if (phases.length > 0) {
                        html += '<div class="preview-section">';
                        html += '<h3>Phases (first 5)</h3>';
                        html += '<table class="preview-table">';
                        html += '<tr><th>Name</th><th>Department</th><th>People Required</th></tr>';
                        phases.slice(0, 5).forEach(phase => {
                            html += `<tr>
                                <td>${phase.name || '-'}</td>
                                <td>${phase.department || '-'}</td>
                                <td>${phase.numero_persone || '-'}</td>
                            </tr>`;
                        });
                        html += '</table>';
                        html += '</div>';
                    }
                    
                    // ODP Orders preview
                    if (odpOrders.length > 0) {
                        html += '<div class="preview-section">';
                        html += '<h3>ODP Orders (first 5)</h3>';
                        html += '<table class="preview-table">';
                        html += '<tr><th>ODP Number</th><th>Article Code</th><th>Status</th><th>Department</th></tr>';
                        odpOrders.slice(0, 5).forEach(order => {
                            html += `<tr>
                                <td>${order.odp_number || '-'}</td>
                                <td>${order.article_code || '-'}</td>
                                <td>${order.status || '-'}</td>
                                <td>${order.department || '-'}</td>
                            </tr>`;
                        });
                        html += '</table>';
                        html += '</div>';
                    }
                    
                    this.elements.previewContent.innerHTML = html;
                    this.elements.dataPreview.style.display = 'block';
                    
                    this.log('Data preview loaded', 'success');
                } catch (error) {
                    this.log('Error loading preview: ' + error.message, 'error');
                }
            }

            backup_data() {
                this.log('Creating backup...', 'info');
                
                try {
                    const backup = {
                        timestamp: new Date().toISOString(),
                        machines: window.storageService.get_machines(),
                        phases: window.storageService.get_phases(),
                        odp_orders: window.storageService.get_odp_orders(),
                        scheduled_events: window.storageService.get_scheduled_events(),
                        machine_availability: window.storageService.get_machine_availability()
                    };
                    
                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `flexi-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    this.log('Backup created and downloaded', 'success');
                } catch (error) {
                    this.log('Backup failed: ' + error.message, 'error');
                }
            }

            async migrate() {
                if (!confirm('Are you sure you want to migrate all data to Supabase? This process cannot be undone.')) {
                    return;
                }
                
                this.elements.migrateBtn.disabled = true;
                this.elements.migrateBtn.textContent = 'Migrating...';
                
                const result = await this.migrationUtility.migrate();
                
                if (result.success) {
                    this.log('Migration completed successfully!', 'success');
                    this.elements.verifyBtn.disabled = false;
                    this.elements.switchToSupabaseBtn.disabled = false;
                    
                    // Show migration report
                    const report = this.migrationUtility.generate_report();
                    console.log('Migration Report:', report);
                } else {
                    this.log('Migration failed: ' + result.error, 'error');
                }
                
                this.elements.migrateBtn.disabled = false;
                this.elements.migrateBtn.textContent = 'Migrate to Supabase';
            }

            async verify_migration() {
                this.log('Verifying migration...', 'info');
                
                const verified = await this.migrationUtility.verify_migration();
                
                if (verified) {
                    this.log('Migration verification passed!', 'success');
                } else {
                    this.log('Migration verification failed - check counts', 'warning');
                }
            }

            switch_to_supabase() {
                if (!confirm('Switch to Supabase backend? You can revert back to localStorage at any time.')) {
                    return;
                }
                
                ServiceConfig.enable_supabase_all();
                this.update_status();
                this.log('Switched to Supabase backend', 'success');
                
                // Reload all checkboxes
                this.load_config();
            }

            revert_to_localstorage() {
                ServiceConfig.disable_supabase();
                this.update_status();
                this.log('Reverted to localStorage', 'info');
                
                // Reload all checkboxes
                this.load_config();
            }

            update_status() {
                this.elements.storageMode.textContent = ServiceConfig.STORAGE_MODE === 'supabase' ? 'Supabase' : 'localStorage';
                this.elements.storageMode.className = ServiceConfig.STORAGE_MODE === 'supabase' ? 
                    'status-badge badge-success' : 'status-badge badge-info';
            }

            log(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                const timestamp = new Date().toLocaleTimeString();
                entry.textContent = `[${timestamp}] ${message}`;
                this.elements.logContainer.appendChild(entry);
                this.elements.logContainer.scrollTop = this.elements.logContainer.scrollHeight;
                
                // Also log to migration utility
                if (this.migrationUtility) {
                    this.migrationUtility.log(message, type);
                }
            }
        }

        // Initialize controller when DOM is ready
        window.addEventListener('DOMContentLoaded', () => {
            window.migrationController = new MigrationController();
        });
    </script>
</body>
</html>
