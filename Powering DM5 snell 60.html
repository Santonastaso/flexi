<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema di Analisi Economica di Produzione BOBST</title>
    <!-- Chart.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Google Sans', 'Segoe UI', Arial, sans-serif;
            background-color: #ffffff;
            color: #202124;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            border: 1px solid #dadce0;
            overflow: hidden;
        }
        
        .header {
            background: #202124;
            padding: 32px 24px;
        }
        
        .header h1 {
            color: #ffffff;
            font-size: 32px;
            font-weight: 400;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #9aa0a6;
            margin-top: 0;
            font-size: 16px;
        }
        
        .content {
            padding: 32px 24px;
        }
        
        .card {
            background-color: #ffffff;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 16px;
        }
        
        .grid {
            display: grid;
            gap: 1.5rem;
        }
        
        .grid-cols-1 {
            grid-template-columns: 1fr;
        }
        
        @media (min-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .grid-cols-3 {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        
        .flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .items-center {
            align-items: center;
        }
        
        .items-start {
            align-items: flex-start;
        }
        
        .space-y-3 > * + * {
            margin-top: 0.75rem;
        }
        
        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }
        
        .space-x-2 > * + * {
            margin-left: 0.5rem;
        }
        
        .space-x-4 > * + * {
            margin-left: 1rem;
        }
        
        .mb-1 {
            margin-bottom: 0.25rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .mt-1 {
            margin-top: 0.25rem;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mr-4 {
            margin-right: 1rem;
        }
        
        .p-2 {
            padding: 0.5rem;
        }
        
        .p-3 {
            padding: 0.75rem;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        .p-5 {
            padding: 1.25rem;
        }
        
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        
        .px-5 {
            padding-left: 1.25rem;
            padding-right: 1.25rem;
        }
        
        .pt-2 {
            padding-top: 0.5rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        .text-lg {
            font-size: 1.125rem;
        }
        
        .text-xl {
            font-size: 1.25rem;
        }
        
        .text-2xl {
            font-size: 1.5rem;
        }
        
        .text-4xl {
            font-size: 2.25rem;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .text-left {
            text-align: left;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-blue-50 {
            color: #eff6ff;
        }
        
        .text-blue-100 {
            color: #dbeafe;
        }
        
        .text-blue-500 {
            color: #3b82f6;
        }
        
        .text-blue-600 {
            color: #2563eb;
        }
        
        .text-blue-700 {
            color: #1d4ed8;
        }
        
        .text-blue-800 {
            color: #1e40af;
        }
        
        .text-green-700 {
            color: #047857;
        }
        
        .text-gray-500 {
            color: #6b7280;
        }
        
        .text-gray-600 {
            color: #4b5563;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .text-gray-800 {
            color: #1f2937;
        }
        
        .text-white {
            color: white;
        }
        
        .bg-white {
            background-color: white;
        }
        
        .bg-blue-50 {
            background-color: #eff6ff;
        }
        
        .bg-blue-100 {
            background-color: #dbeafe;
        }
        
        .bg-blue-600 {
            background-color: #2563eb;
        }
        
        .bg-blue-700 {
            background-color: #1d4ed8;
        }
        
        .bg-gray-50 {
            background-color: #f9fafb;
        }
        
        .bg-orange-500 {
            background-color: #f97316;
        }
        
        .bg-green-50 {
            background-color: #f0fdf4;
        }
        
        .border {
            border-width: 1px;
            border-style: solid;
        }
        
        .border-t {
            border-top-width: 1px;
            border-top-style: solid;
        }
        
        .border-b {
            border-bottom-width: 1px;
            border-bottom-style: solid;
        }
        
        .border-b-2 {
            border-bottom-width: 2px;
            border-bottom-style: solid;
        }
        
        .border-gray-200 {
            border-color: #e5e7eb;
        }
        
        .border-gray-300 {
            border-color: #d1d5db;
        }
        
        .border-blue-500 {
            border-color: #3b82f6;
        }
        
        .border-blue-600 {
            border-color: #2563eb;
        }
        
        .border-orange-500 {
            border-color: #f97316;
        }
        
        .border-transparent {
            border-color: transparent;
        }
        
        .rounded {
            border-radius: 0.25rem;
        }
        
        .rounded-md {
            border-radius: 0.375rem;
        }
        
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .rounded-full {
            border-radius: 9999px;
        }
        
        .w-full {
            width: 100%;
        }
        
        .w-16 {
            width: 4rem;
        }
        
        .h-16 {
            height: 4rem;
        }
        
        .h-64 {
            height: 16rem;
        }
        
        .h-72 {
            height: 18rem;
        }
        
        .flex-1 {
            flex: 1 1 0%;
        }
        
        .block {
            display: block;
        }
        
        .hidden {
            display: none;
        }
        
        .overflow-hidden {
            overflow: hidden;
        }
        
        .overflow-x-auto {
            overflow-x: auto;
        }
        
        .shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .focus\:ring-blue-500:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            outline: none;
        }
        
        .focus\:border-blue-500:focus {
            border-color: #3b82f6;
        }
        
        .hover\:bg-gray-50:hover {
            background-color: #f9fafb;
        }
        
        .hover\:text-gray-700:hover {
            color: #374151;
        }
        
        .hover\:border-gray-300:hover {
            border-color: #d1d5db;
        }
        
        .hover\:text-blue-800:hover {
            color: #1e40af;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        
        button {
            cursor: pointer;
            background-color: transparent;
            border: none;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .tab {
            padding: 0.75rem 1.25rem;
            text-align: center;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #2563eb;
        }
        
        .tab:not(.active) {
            color: #6b7280;
        }
        
        .tab:not(.active):hover {
            color: #374151;
            border-bottom-color: #d1d5db;
        }
        
        .tab-content {
            padding: 1.25rem;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .home-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .home-button:hover {
            background: #1557b0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .home-button {
                top: 10px;
                right: 10px;
                padding: 10px 16px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="home-button">🏠 Home</a>
    
    <div class="container">
        <div class="header">
            <h1>Sistema di Analisi Economica di Produzione BOBST</h1>
            <p>Ottimizzazione dei costi operativi tra tecnologia digitale (DM5) e flessografica (M5)</p>
        </div>
        
        <div class="content">
            <!-- Parametri di Configurazione -->
            <div class="card mb-6">
                <h3 class="card-title">Configurazione di Analisi</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Volume di Produzione (PZ)
                        </label>
                        <input 
                            type="number" 
                            id="pieces" 
                            min="1"
                            value="10000" 
                            class="w-full p-2 border border-gray-300 rounded-md"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Formato Unitario (mm)
                        </label>
                        <input 
                            type="number" 
                            id="bagStep" 
                            min="1"
                            value="304.8" 
                            class="w-full p-2 border border-gray-300 rounded-md"
                        >
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Specifica Colori
                        </label>
                        <div class="flex space-x-2" id="colorsButtons">
                            <button class="flex-1 py-2 border rounded-md bg-blue-700 text-white border-blue-700" data-value="1">1</button>
                            <button class="flex-1 py-2 border rounded-md bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-value="2">2</button>
                            <button class="flex-1 py-2 border rounded-md bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-value="3">3</button>
                            <button class="flex-1 py-2 border rounded-md bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-value="4">4</button>
                            <button class="flex-1 py-2 border rounded-md bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-value="5">5</button>
                            <button class="flex-1 py-2 border rounded-md bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-value="6">6</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Tipologia Colore
                        </label>
                        <div class="flex space-x-4" id="colorTypeButtons">
                            <button class="flex-1 py-2 border rounded-md bg-blue-700 text-white border-blue-700" data-value="cmyk">CMYK Standard</button>
                            <button class="flex-1 py-2 border rounded-md bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-value="pantone">Pantone</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-md">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                                <span id="lengthValue" class="text-xl font-bold text-blue-800">3.048</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-blue-800">Metratura Totale</h3>
                                <p class="text-sm text-blue-700">metri lineari di produzione</p>
                            </div>
                        </div>
                        <button id="toggleAdvanced" class="text-blue-600 hover:text-blue-800 text-sm">
                            Visualizza parametri operativi
                        </button>
                    </div>
                </div>
                
                <div id="advancedParams" class="mt-4 p-3 border border-gray-200 rounded-md bg-gray-50 hidden">
                    <h4 class="font-medium text-sm text-gray-700 mb-2">Parametri Tecnico-Economici</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><span class="font-medium">Costo Operativo DM5:</span> €102.06/h</p>
                            <p><span class="font-medium">Produttività DM5:</span> 3600 m/h</p>
                            <p><span class="font-medium">Avviamento CMYK DM5:</span> 0.0833h (€8.50)</p>
                            <p><span class="font-medium">Avviamento Pantone DM5:</span> 0.5h (€51.03)</p>
                        </div>
                        <div>
                            <p><span class="font-medium">Costo Operativo M5:</span> €117.94/h</p>
                            <p><span class="font-medium">Produttività M5:</span> 4800 m/h</p>
                            <p><span class="font-medium">Avviamento per colore M5:</span> 0.5h (€58.97)</p>
                            <p id="totalFlexoSetup"><span class="font-medium">Avviamento totale M5:</span> 0.5h (€58.97)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="card p-0 mb-6">
                <div class="tabs">
                    <button class="tab active" data-tab="summary">Analisi di Efficienza</button>
                    <button class="tab" data-tab="costAnalysis">Analisi Economica</button>
                    <button class="tab" data-tab="breakEven">Ottimizzazione per Volume</button>
                </div>
                
                <div class="tab-content">
                    <!-- Tab Analisi di Efficienza -->
                    <div id="summary" class="tab-pane space-y-6 active">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white p-5 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4 text-blue-700">Tecnologia Digitale (DM5)</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Costo di avviamento:</span>
                                        <span id="digitalSetupCost" class="font-medium">€8.50</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Costo di lavorazione:</span>
                                        <span id="digitalProductionCost" class="font-medium">€74.06</span>
                                    </div>
                                    <div class="flex justify-between pt-2 border-t border-gray-200">
                                        <span class="font-medium text-gray-700">Costo operativo totale:</span>
                                        <span id="digitalTotalCost" class="font-bold text-blue-700">€82.56</span>
                                    </div>
                                    <div class="flex justify-between pt-2 border-t border-gray-200">
                                        <span class="font-medium text-gray-700">Tempo ciclo totale:</span>
                                        <span id="digitalTotalTime" class="font-bold text-blue-700">0h 49m</span>
                                    </div>
                                    <div class="flex justify-between pt-2 border-t border-gray-200">
                                        <span class="font-medium text-gray-700">Costo unitario:</span>
                                        <span id="digitalCostPerMeter" class="font-bold text-blue-700">€0.0271/m</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-5 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4 text-green-700">Tecnologia Flessografica (M5)</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Costo di avviamento:</span>
                                        <span id="flexoSetupCost" class="font-medium">€58.97</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Costo di lavorazione:</span>
                                        <span id="flexoProductionCost" class="font-medium">€75.07</span>
                                    </div>
                                    <div class="flex justify-between pt-2 border-t border-gray-200">
                                        <span class="font-medium text-gray-700">Costo operativo totale:</span>
                                        <span id="flexoTotalCost" class="font-bold text-green-700">€134.04</span>
                                    </div>
                                    <div class="flex justify-between pt-2 border-t border-gray-200">
                                        <span class="font-medium text-gray-700">Tempo ciclo totale:</span>
                                        <span id="flexoTotalTime" class="font-bold text-green-700">1h 08m</span>
                                    </div>
                                    <div class="flex justify-between pt-2 border-t border-gray-200">
                                        <span class="font-medium text-gray-700">Costo unitario:</span>
                                        <span id="flexoCostPerMeter" class="font-bold text-green-700">€0.0440/m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Analisi Comparativa dei Costi Operativi</h3>
                            <div class="h-64">
                                <canvas id="costComparisonChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">
                                Il grafico illustra la comparazione tra i costi di avviamento e lavorazione per entrambe le tecnologie, 
                                evidenziando la struttura economica differente delle due soluzioni produttive.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Tab Analisi Economica -->
                    <div id="costAnalysis" class="tab-pane space-y-6">
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Economie di Scala ed Efficienza Operativa</h3>
                            <div class="h-64">
                                <canvas id="costPerMeterChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">
                                Questo grafico mostra l'andamento del costo unitario (€/m) in funzione del volume produttivo.
                                È possibile rilevare la reattività di ciascuna tecnologia alle economie di scala.
                                La linea verticale evidenzia il punto di produzione attuale nel contesto complessivo.
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-5 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4 text-gray-700">Composizione dei Costi: Tecnologia Digitale</h3>
                                <div class="h-64">
                                    <canvas id="digitalPieChart"></canvas>
                                </div>
                                <div class="text-center mt-2">
                                    <div class="text-sm font-medium text-gray-700">Costo operativo complessivo: <span id="digitalTotalCostPie">€82.56</span></div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-5 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4 text-gray-700">Composizione dei Costi: Tecnologia Flessografica</h3>
                                <div class="h-64">
                                    <canvas id="flexoPieChart"></canvas>
                                </div>
                                <div class="text-center mt-2">
                                    <div class="text-sm font-medium text-gray-700">Costo operativo complessivo: <span id="flexoTotalCostPie">€134.04</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Ottimizzazione per Volume -->
                    <div id="breakEven" class="tab-pane space-y-6">
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Analisi dei Punti di Equilibrio per Complessità Cromatica</h3>
                            <div class="h-72">
                                <canvas id="breakEvenChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">
                                Questo grafico mostra i volumi di produzione critici ai quali le due tecnologie raggiungono un punto di equivalenza economica.
                                Per volumi inferiori al punto di equilibrio, la tecnologia digitale (DM5) risulta economicamente vantaggiosa,
                                mentre per volumi superiori la tecnologia flessografica (M5) offre costi unitari più competitivi.
                            </p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Ripartizione dei Costi per <span id="lengthAnalysis">3.048</span> metri</h3>
                            <div class="h-64">
                                <canvas id="costAnalysisChart"></canvas>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-center">
                                <div id="breakEvenBox" class="p-3 rounded-lg bg-blue-50">
                                    <div class="text-sm font-medium text-gray-700">Punto di Equilibrio con <span id="colorCount">1</span> colori (CMYK)</div>
                                    <div id="breakEvenPoint" class="text-xl font-bold mt-1" style="color: #3B82F6">
                                        31.132 metri
                                    </div>
                                </div>
                                <div id="recommendationBox" class="p-3 rounded-lg bg-blue-50">
                                    <div class="text-sm font-medium text-gray-700">Tecnologia ottimale per il volume</div>
                                    <div id="recommendationTech" class="text-xl font-bold mt-1" style="color: #3B82F6">
                                        Digitale (DM5)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analisi Conclusiva e Raccomandazione -->
            <div class="bg-white p-5 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Analisi Conclusiva e Ottimizzazione Operativa</h3>
                
                <div id="recommendationCard" class="p-4 rounded-lg flex items-start" style="background-color: #EBF5FF; border-left: 4px solid #3B82F6">
                    <div class="text-4xl mr-4">
                        📊
                    </div>
                    <div class="flex-1">
                        <h4 id="recommendationTitle" class="text-xl font-bold mb-2" style="color: #3B82F6">
                            Soluzione Raccomandata: Tecnologia Digitale (DM5)
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="bg-white p-3 rounded border border-gray-200">
                                <h5 class="text-sm font-medium text-gray-600 mb-1">Ottimizzazione Economica</h5>
                                <div id="costSaving" class="text-xl font-bold" style="color: #3B82F6">
                                    €51.48
                                </div>
                                <div id="costSavingPercentage" class="text-sm text-gray-500">
                                    38.4% di riduzione costi
                                </div>
                            </div>
                            
                            <div class="bg-white p-3 rounded border border-gray-200">
                                <h5 class="text-sm font-medium text-gray-600 mb-1">Efficienza Temporale</h5>
                                <div id="timeSaving" class="text-xl font-bold" style="color: #3B82F6">
                                    0h 19m
                                </div>
                                <div id="timeSavingPercentage" class="text-sm text-gray-500">
                                    27.9% di riduzione lead time
                                </div>
                            </div>
                            
                            <div class="bg-white p-3 rounded border border-gray-200">
                                <h5 class="text-sm font-medium text-gray-600 mb-1">Indice ROI</h5>
                                <div id="breakEvenText" class="text-lg font-medium text-gray-800">
                                    31.132 metri
                                </div>
                                <div id="colorSpecText" class="text-sm text-gray-500">
                                    Volume di equilibrio economico
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-gray-600 text-sm bg-gray-50 p-3 rounded">
                            <p>
                                <strong>Considerazioni strategiche:</strong> La scelta della tecnologia ottimale deve considerare anche fattori 
                                complementari quali requisiti di qualità, flessibilità produttiva, tempistiche di consegna e disponibilità degli 
                                impianti nel contesto della pianificazione complessiva.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const DIGITAL_HOURLY_COST = 102.06; // €/h
        const FLEXO_HOURLY_COST = 117.94; // €/h
        const DIGITAL_SPEED = 3600; // m/h
        const FLEXO_SPEED = 4800; // m/h
        const DIGITAL_CMYK_SETUP = 0.0833; // h
        const DIGITAL_PANTONE_SETUP = 0.5; // h
        const FLEXO_SETUP_PER_COLOR = 0.5; // h per color

        // Colors for charts
        const COLORS = {
            digital: '#3B82F6', // blue
            flexo: '#10B981',   // green
            digitalLight: '#93C5FD',
            flexoLight: '#6EE7B7',
            setup: '#EF4444',   // red
            production: '#F59E0B' // amber
        };

        // State variables
        let pieces = 10000;
        let bagStep = 304.8;
        let colors = 1;
        let usePantone = false;
        let showAdvanced = false;
        let length = 3048;
        let digitalCost = { setup: 0, production: 0, total: 0, time: 0 };
        let flexoCost = { setup: 0, production: 0, total: 0, time: 0 };
        let recommendation = { technology: '', savingsCost: 0, savingsTime: 0, savingsPercentage: 0 };
        let breakEvenPoints = [];
        let costComparisonData = [];
        let pieData = { digital: [], flexo: [] };

        // Chart objects
        let costComparisonChart = null;
        let costPerMeterChart = null;
        let digitalPieChart = null;
        let flexoPieChart = null;
        let breakEvenChart = null;
        let costAnalysisChart = null;

        // DOM Elements
        const piecesInput = document.getElementById('pieces');
        const bagStepInput = document.getElementById('bagStep');
        const colorsButtons = document.querySelectorAll('#colorsButtons button');
        const colorTypeButtons = document.querySelectorAll('#colorTypeButtons button');
        const lengthValue = document.getElementById('lengthValue');
        const lengthAnalysis = document.getElementById('lengthAnalysis');
        const toggleAdvancedButton = document.getElementById('toggleAdvanced');
        const advancedParamsDiv = document.getElementById('advancedParams');
        const totalFlexoSetup = document.getElementById('totalFlexoSetup');
        const tabs = document.querySelectorAll('.tab');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        // Break-even reference data (from DM5 calculator)
        const breakEvenReferenceData = [
            { colors: 1, breakEven: 371, digitalBelow: "< 371m", flexoAbove: "> 371m" },
            { colors: 2, breakEven: 10625, digitalBelow: "< 10.625m", flexoAbove: "> 10.625m" },
            { colors: 3, breakEven: 20878, digitalBelow: "< 20.878m", flexoAbove: "> 20.878m" },
            { colors: 4, breakEven: 31132, digitalBelow: "< 31.132m", flexoAbove: "> 31.132m" },
            { colors: 5, breakEven: 41386, digitalBelow: "< 41.386m", flexoAbove: "> 41.386m" },
            { colors: 6, breakEven: 51640, digitalBelow: "< 51.640m", flexoAbove: "> 51.640m" }
        ];
        
        // Break-even Pantone reference data (from DM5 calculator)
        const breakEvenPantoneReferenceData = [
            { colors: 1, breakEven: 0, digitalBelow: "N/A", flexoAbove: "Sempre" },
            { colors: 2, breakEven: 5074, digitalBelow: "< 5.074m", flexoAbove: "> 5.074m" },
            { colors: 3, breakEven: 11454, digitalBelow: "< 11.454m", flexoAbove: "> 11.454m" },
            { colors: 4, breakEven: 17834, digitalBelow: "< 17.834m", flexoAbove: "> 17.834m" },
            { colors: 5, breakEven: 24214, digitalBelow: "< 24.214m", flexoAbove: "> 24.214m" },
            { colors: 6, breakEven: 30595, digitalBelow: "< 30.595m", flexoAbove: "> 30.595m" }
        ];
        
        // Calculate break-even point
        function calculateBreakEven(colorCount, isPantone) {
            const digitalSetupTime = isPantone ? DIGITAL_PANTONE_SETUP : DIGITAL_CMYK_SETUP;
            const digitalSetupCost = digitalSetupTime * DIGITAL_HOURLY_COST;
            const flexoSetupCost = colorCount * FLEXO_SETUP_PER_COLOR * FLEXO_HOURLY_COST;
            
            const digitalProductionCostPerMeter = DIGITAL_HOURLY_COST / DIGITAL_SPEED;
            const flexoProductionCostPerMeter = FLEXO_HOURLY_COST / FLEXO_SPEED;
            
            // If flexo setup is cheaper than digital setup (can happen with Pantone), then flexo is always cheaper
            if (flexoSetupCost <= digitalSetupCost && flexoProductionCostPerMeter < digitalProductionCostPerMeter) {
                return 0; // Means flexo is always more economical
            }
            
            // Break-even formula: the length at which total costs are equal
            // Digital setup + Digital production/m * Length = Flexo setup + Flexo production/m * Length
            // Rearranging: Length = (Flexo setup - Digital setup) / (Digital production/m - Flexo production/m)
            const breakEvenLength = Math.round(
                (flexoSetupCost - digitalSetupCost) / 
                (digitalProductionCostPerMeter - flexoProductionCostPerMeter)
            );
            
            return breakEvenLength > 0 ? breakEvenLength : 0;
        }

        // Initialize break-even points
        function initializeBreakEvenPoints() {
            const points = [];
            for (let colorCount = 1; colorCount <= 6; colorCount++) {
                const cmykBreakEven = calculateBreakEven(colorCount, false);
                const pantoneBreakEven = calculateBreakEven(colorCount, true);
                
                points.push({
                    colors: colorCount,
                    cmyk: cmykBreakEven,
                    pantone: pantoneBreakEven,
                    label: `${colorCount} ${colorCount === 1 ? 'colore' : 'colori'}`
                });
            }
            breakEvenPoints = points;
        }

        // Generate cost comparison data for chart
        function generateCostComparisonData(currentLength) {
            const data = [];
            
            // Generate data points for different lengths around the current length
            const lengths = [
                Math.max(100, Math.round(currentLength * 0.1)),
                Math.max(1000, Math.round(currentLength * 0.25)),
                Math.max(2000, Math.round(currentLength * 0.5)),
                Math.round(currentLength * 0.75),
                Math.round(currentLength),
                Math.round(currentLength * 1.25),
                Math.round(currentLength * 1.5),
                Math.round(currentLength * 2)
            ];
            
            // Clean up duplicates
            const uniqueLengths = [...new Set(lengths)].sort((a, b) => a - b);
            
            uniqueLengths.forEach(len => {
                // Calculate digital costs
                const digitalSetupTime = usePantone ? DIGITAL_PANTONE_SETUP : DIGITAL_CMYK_SETUP;
                const digitalSetupCost = digitalSetupTime * DIGITAL_HOURLY_COST;
                const digitalProductionCost = (len / DIGITAL_SPEED) * DIGITAL_HOURLY_COST;
                const digitalTotal = digitalSetupCost + digitalProductionCost;
                const digitalCostPerMeter = digitalTotal / len;
                
                // Calculate flexo costs
                const flexoSetupCost = colors * FLEXO_SETUP_PER_COLOR * FLEXO_HOURLY_COST;
                const flexoProductionCost = (len / FLEXO_SPEED) * FLEXO_HOURLY_COST;
                const flexoTotal = flexoSetupCost + flexoProductionCost;
                const flexoCostPerMeter = flexoTotal / len;
                
                data.push({
                    length: len,
                    digitalCostTotal: digitalTotal,
                    flexoCostTotal: flexoTotal,
                    digitalCostPerMeter: digitalCostPerMeter,
                    flexoCostPerMeter: flexoCostPerMeter,
                    cheapest: digitalTotal <= flexoTotal ? 'Digital' : 'Flexo'
                });
            });
            
            return data;
        }

        // Format time in hours and minutes
        function formatTime(timeInHours) {
            const hours = Math.floor(timeInHours);
            const minutes = Math.round((timeInHours - hours) * 60);
            return `${hours}h ${minutes}m`;
        }

        // Format number with thousands separator
        function formatNumber(number) {
            return number.toLocaleString();
        }

        // Get break-even point text
        function getBreakEvenText() {
            // Find from reference data based on colors and Pantone usage
            const refData = usePantone ? breakEvenPantoneReferenceData : breakEvenReferenceData;
            const point = refData.find(p => p.colors === colors);
            
            if (!point) return '';
            
            if (point.breakEven === 0) {
                return 'Sempre Flessografica';
            }
            
            return `${formatNumber(point.breakEven)} metri`;
        }

        // Calculate everything
        function calculateAll() {
            // Calculate length in meters
            length = (pieces * bagStep) / 1000;
            
            // Update length display
            lengthValue.textContent = formatNumber(length);
            if (lengthAnalysis) {
                lengthAnalysis.textContent = formatNumber(length);
            }
            
            // Calculate digital costs and time
            const digitalSetupTime = usePantone ? DIGITAL_PANTONE_SETUP : DIGITAL_CMYK_SETUP;
            const digitalSetupCost = digitalSetupTime * DIGITAL_HOURLY_COST;
            const digitalProductionTime = length / DIGITAL_SPEED;
            const digitalProductionCost = digitalProductionTime * DIGITAL_HOURLY_COST;
            const digitalTotalCost = digitalSetupCost + digitalProductionCost;
            const digitalTotalTime = digitalSetupTime + digitalProductionTime;
            
            digitalCost = {
                setup: digitalSetupCost,
                production: digitalProductionCost,
                total: digitalTotalCost,
                time: digitalTotalTime
            };
            
            // Calculate flexo costs and time
            const flexoSetupTime = colors * FLEXO_SETUP_PER_COLOR;
            const flexoSetupCost = flexoSetupTime * FLEXO_HOURLY_COST;
            const flexoProductionTime = length / FLEXO_SPEED;
            const flexoProductionCost = flexoProductionTime * FLEXO_HOURLY_COST;
            const flexoTotalCost = flexoSetupCost + flexoProductionCost;
            const flexoTotalTime = flexoSetupTime + flexoProductionTime;
            
            flexoCost = {
                setup: flexoSetupCost,
                production: flexoProductionCost,
                total: flexoTotalCost,
                time: flexoTotalTime
            };
            
            // Determine recommendation and savings
            const isCheaperDigital = digitalTotalCost <= flexoTotalCost;
            const savingsCost = Math.abs(digitalTotalCost - flexoTotalCost);
            const savingsTime = Math.abs(digitalTotalTime - flexoTotalTime);
            const savingsPercentage = isCheaperDigital
                ? ((flexoTotalCost / digitalTotalCost) - 1) * 100
                : ((digitalTotalCost / flexoTotalCost) - 1) * 100;
            
            recommendation = {
                technology: isCheaperDigital ? 'Digitale (DM5)' : 'Flessografica (M5)',
                savingsCost,
                savingsTime,
                savingsPercentage
            };
            
            // Generate cost comparison data
            costComparisonData = generateCostComparisonData(length);
            
            // Generate pie chart data
            pieData = {
                digital: [
                    { name: "Setup", value: digitalSetupCost },
                    { name: "Produzione", value: digitalProductionCost }
                ],
                flexo: [
                    { name: "Setup", value: flexoSetupCost },
                    { name: "Produzione", value: flexoProductionCost }
                ]
            };
            
            // Update UI
            updateUI();
            
            // Update Charts
            if (costComparisonChart) updateCharts();
        }

        // Update UI elements
        function updateUI() {
            try {
                // Update digital cost elements
                document.getElementById('digitalSetupCost').textContent = `€${digitalCost.setup.toFixed(2)}`;
                document.getElementById('digitalProductionCost').textContent = `€${digitalCost.production.toFixed(2)}`;
                document.getElementById('digitalTotalCost').textContent = `€${digitalCost.total.toFixed(2)}`;
                document.getElementById('digitalTotalTime').textContent = formatTime(digitalCost.time);
                document.getElementById('digitalCostPerMeter').textContent = `€${(digitalCost.total / length).toFixed(4)}/m`;
                
                if (document.getElementById('digitalTotalCostPie')) {
                    document.getElementById('digitalTotalCostPie').textContent = `€${digitalCost.total.toFixed(2)}`;
                }
                
                // Update flexo cost elements
                document.getElementById('flexoSetupCost').textContent = `€${flexoCost.setup.toFixed(2)}`;
                document.getElementById('flexoProductionCost').textContent = `€${flexoCost.production.toFixed(2)}`;
                document.getElementById('flexoTotalCost').textContent = `€${flexoCost.total.toFixed(2)}`;
                document.getElementById('flexoTotalTime').textContent = formatTime(flexoCost.time);
                document.getElementById('flexoCostPerMeter').textContent = `€${(flexoCost.total / length).toFixed(4)}/m`;
                
                if (document.getElementById('flexoTotalCostPie')) {
                    document.getElementById('flexoTotalCostPie').textContent = `€${flexoCost.total.toFixed(2)}`;
                }
                
                // Update color specification elements
                if (document.getElementById('colorCount')) {
                    document.getElementById('colorCount').textContent = colors;
                }
                
                if (document.getElementById('breakEvenPoint')) {
                    document.getElementById('breakEvenPoint').textContent = getBreakEvenText();
                }
                
                if (document.getElementById('breakEvenText')) {
                    document.getElementById('breakEvenText').textContent = getBreakEvenText();
                }
                
                if (document.getElementById('colorSpecText')) {
                    document.getElementById('colorSpecText').textContent = usePantone ? 'Con Pantone' : 'Con CMYK standard';
                }
                
                if (document.getElementById('totalFlexoSetup')) {
                    document.getElementById('totalFlexoSetup').innerHTML = `<span class="font-medium">Setup totale M5:</span> ${colors * FLEXO_SETUP_PER_COLOR}h (€${(colors * FLEXO_SETUP_PER_COLOR * FLEXO_HOURLY_COST).toFixed(2)})`;
                }
                
                // Update recommendation elements
                const recommendationCard = document.getElementById('recommendationCard');
                const recommendationTitle = document.getElementById('recommendationTitle');
                const recommendationTech = document.getElementById('recommendationTech');
                const costSaving = document.getElementById('costSaving');
                const costSavingPercentage = document.getElementById('costSavingPercentage');
                const timeSaving = document.getElementById('timeSaving');
                const timeSavingPercentage = document.getElementById('timeSavingPercentage');
                const breakEvenBox = document.getElementById('breakEvenBox');
                
                if (recommendationCard && recommendationTitle) {
                    if (recommendation.technology === 'Digitale (DM5)') {
                        recommendationCard.style.backgroundColor = '#EBF5FF';
                        recommendationCard.style.borderLeftColor = '#3B82F6';
                        recommendationTitle.style.color = '#3B82F6';
                        
                        if (recommendationTech) recommendationTech.style.color = '#3B82F6';
                        if (costSaving) costSaving.style.color = '#3B82F6';
                        if (timeSaving) timeSaving.style.color = '#3B82F6';
                        
                        if (breakEvenBox) {
                            breakEvenBox.classList.add('bg-blue-50');
                            breakEvenBox.classList.remove('bg-green-50');
                        }
                    } else {
                        recommendationCard.style.backgroundColor = '#F0FDF4';
                        recommendationCard.style.borderLeftColor = '#10B981';
                        recommendationTitle.style.color = '#10B981';
                        
                        if (recommendationTech) recommendationTech.style.color = '#10B981';
                        if (costSaving) costSaving.style.color = '#10B981';
                        if (timeSaving) timeSaving.style.color = '#10B981';
                        
                        if (breakEvenBox) {
                            breakEvenBox.classList.add('bg-green-50');
                            breakEvenBox.classList.remove('bg-blue-50');
                        }
                    }
                    
                    recommendationTitle.textContent = `Tecnologia Consigliata: ${recommendation.technology}`;
                    
                    if (recommendationTech) {
                        recommendationTech.textContent = recommendation.technology;
                    }
                    
                    if (costSaving && costSavingPercentage) {
                        costSaving.textContent = `€${recommendation.savingsCost.toFixed(2)}`;
                        costSavingPercentage.textContent = `${recommendation.savingsPercentage.toFixed(1)}% più economico`;
                    }
                    
                    if (timeSaving && timeSavingPercentage) {
                        timeSaving.textContent = formatTime(recommendation.savingsTime);
                        
                        const timeSavingPercent = recommendation.technology === 'Digitale (DM5)' 
                            ? (recommendation.savingsTime / flexoCost.time) * 100
                            : (recommendation.savingsTime / digitalCost.time) * 100;
                        
                        timeSavingPercentage.textContent = `${timeSavingPercent.toFixed(1)}% più veloce`;
                    }
                }
            } catch (error) {
                console.error('Error updating UI:', error);
            }
        }

        // Initialize charts
        function initializeCharts() {
            try {
                // Cost Comparison Chart
                const costComparisonCtx = document.getElementById('costComparisonChart');
                if (costComparisonCtx) {
                    costComparisonChart = new Chart(costComparisonCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Digitale', 'Flessografica'],
                            datasets: [
                                {
                                    label: 'Costo Setup',
                                    data: [digitalCost.setup, flexoCost.setup],
                                    backgroundColor: COLORS.setup,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Costo Produzione',
                                    data: [digitalCost.production, flexoCost.production],
                                    backgroundColor: COLORS.production,
                                    stack: 'Stack 0'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '€'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: €${context.raw.toFixed(2)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Cost Per Meter Chart
                const costPerMeterCtx = document.getElementById('costPerMeterChart');
                if (costPerMeterCtx) {
                    costPerMeterChart = new Chart(costPerMeterCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            datasets: [
                                {
                                    label: 'Digitale',
                                    data: costComparisonData.map(d => ({ x: d.length, y: d.digitalCostPerMeter })),
                                    borderColor: COLORS.digital,
                                    backgroundColor: COLORS.digital,
                                    tension: 0.1
                                },
                                {
                                    label: 'Flessografica',
                                    data: costComparisonData.map(d => ({ x: d.length, y: d.flexoCostPerMeter })),
                                    borderColor: COLORS.flexo,
                                    backgroundColor: COLORS.flexo,
                                    tension: 0.1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'logarithmic',
                                    title: {
                                        display: true,
                                        text: 'Lunghezza (m) - scala logaritmica'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return formatNumber(value);
                                        }
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Costo unitario (€/m)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(3);
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: €${context.raw.y.toFixed(4)}/m`;
                                        },
                                        title: function(context) {
                                            return `${formatNumber(context[0].raw.x)} metri`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Digital Pie Chart
                const digitalPieCtx = document.getElementById('digitalPieChart');
                if (digitalPieCtx) {
                    digitalPieChart = new Chart(digitalPieCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: ['Setup', 'Produzione'],
                            datasets: [{
                                data: pieData.digital.map(d => d.value),
                                backgroundColor: [COLORS.setup, COLORS.production]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(0);
                                            return `${context.label}: €${value.toFixed(2)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Flexo Pie Chart
                const flexoPieCtx = document.getElementById('flexoPieChart');
                if (flexoPieCtx) {
                    flexoPieChart = new Chart(flexoPieCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: ['Setup', 'Produzione'],
                            datasets: [{
                                data: pieData.flexo.map(d => d.value),
                                backgroundColor: [COLORS.setup, COLORS.production]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(0);
                                            return `${context.label}: €${value.toFixed(2)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Break-Even Chart
                const breakEvenCtx = document.getElementById('breakEvenChart');
                if (breakEvenCtx) {
                    breakEvenChart = new Chart(breakEvenCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: breakEvenPoints.map(p => p.label),
                            datasets: [
                                {
                                    label: 'Break-Even CMYK',
                                    data: breakEvenReferenceData.map(p => p.breakEven),
                                    backgroundColor: COLORS.digital
                                },
                                {
                                    label: 'Break-Even Pantone',
                                    data: breakEvenPantoneReferenceData.map(p => p.breakEven),
                                    backgroundColor: COLORS.digitalLight
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Metri'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return formatNumber(value);
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw;
                                            return value > 0 
                                                ? `${context.dataset.label}: ${formatNumber(value)} metri`
                                                : `${context.dataset.label}: Sempre Flessografica`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Cost Analysis Chart
                const costAnalysisCtx = document.getElementById('costAnalysisChart');
                if (costAnalysisCtx) {
                    costAnalysisChart = new Chart(costAnalysisCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Setup', 'Produzione', 'Totale'],
                            datasets: [
                                {
                                    label: 'Digitale',
                                    data: [digitalCost.setup, digitalCost.production, digitalCost.total],
                                    backgroundColor: COLORS.digital
                                },
                                {
                                    label: 'Flessografica',
                                    data: [flexoCost.setup, flexoCost.production, flexoCost.total],
                                    backgroundColor: COLORS.flexo
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '€'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: €${context.raw.toFixed(2)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }

        // Update charts with new data
        function updateCharts() {
            try {
                // Update Cost Comparison Chart
                if (costComparisonChart) {
                    costComparisonChart.data.datasets[0].data = [digitalCost.setup, flexoCost.setup];
                    costComparisonChart.data.datasets[1].data = [digitalCost.production, flexoCost.production];
                    costComparisonChart.update();
                }
                
                // Update Cost Per Meter Chart
                if (costPerMeterChart) {
                    costPerMeterChart.data.datasets[0].data = costComparisonData.map(d => ({ x: d.length, y: d.digitalCostPerMeter }));
                    costPerMeterChart.data.datasets[1].data = costComparisonData.map(d => ({ x: d.length, y: d.flexoCostPerMeter }));
                    costPerMeterChart.update();
                }
                
                // Update Digital Pie Chart
                if (digitalPieChart) {
                    digitalPieChart.data.datasets[0].data = pieData.digital.map(d => d.value);
                    digitalPieChart.update();
                }
                
                // Update Flexo Pie Chart
                if (flexoPieChart) {
                    flexoPieChart.data.datasets[0].data = pieData.flexo.map(d => d.value);
                    flexoPieChart.update();
                }
                
                // Update Break-Even Chart
                if (breakEvenChart) {
                    breakEvenChart.update();
                }
                
                // Update Cost Analysis Chart
                if (costAnalysisChart) {
                    costAnalysisChart.data.datasets[0].data = [digitalCost.setup, digitalCost.production, digitalCost.total];
                    costAnalysisChart.data.datasets[1].data = [flexoCost.setup, flexoCost.production, flexoCost.total];
                    costAnalysisChart.update();
                }
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

                    // Event listeners
        function setupEventListeners() {
            try {
                // Number inputs
                piecesInput.addEventListener('input', function() {
                    pieces = parseInt(this.value) || 0;
                    calculateAll();
                });
                
                bagStepInput.addEventListener('input', function() {
                    bagStep = parseInt(this.value) || 0;
                    calculateAll();
                });
                
                // Colors buttons
                colorsButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        colorsButtons.forEach(btn => {
                            btn.classList.remove('bg-blue-700', 'text-white', 'border-blue-700');
                            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300', 'hover:bg-gray-50');
                        });
                        
                        this.classList.remove('bg-white', 'text-gray-700', 'border-gray-300', 'hover:bg-gray-50');
                        this.classList.add('bg-blue-700', 'text-white', 'border-blue-700');
                        
                        colors = parseInt(this.dataset.value);
                        calculateAll();
                    });
                });
                
                // Color type buttons
                colorTypeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        colorTypeButtons.forEach(btn => {
                            btn.classList.remove('bg-blue-700', 'bg-orange-500', 'text-white', 'border-blue-700', 'border-orange-500');
                            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300', 'hover:bg-gray-50');
                        });
                        
                        this.classList.remove('bg-white', 'text-gray-700', 'border-gray-300', 'hover:bg-gray-50');
                        
                        if (this.dataset.value === 'cmyk') {
                            this.classList.add('bg-blue-700', 'text-white', 'border-blue-700');
                            usePantone = false;
                        } else {
                            this.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                            usePantone = true;
                        }
                        
                        calculateAll();
                    });
                });
                
                // Toggle advanced params
                toggleAdvancedButton.addEventListener('click', function() {
                    showAdvanced = !showAdvanced;
                    advancedParamsDiv.classList.toggle('hidden', !showAdvanced);
                    this.textContent = showAdvanced ? 'Nascondi parametri operativi' : 'Visualizza parametri operativi';
                });
                
                // Tabs
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        tabs.forEach(t => {
                            t.classList.remove('active');
                        });
                        tabPanes.forEach(p => p.classList.remove('active'));
                        
                        this.classList.add('active');
                        
                        const tabId = this.dataset.tab;
                        document.getElementById(tabId).classList.add('active');
                    });
                });
            } catch (error) {
                console.error('Error setting up event listeners:', error);
            }
        }

        // Initialize the app
        function init() {
            try {
                // Set initial values
                initializeBreakEvenPoints();
                calculateAll();
                
                // Add a small delay before initializing charts to ensure DOM is ready
                setTimeout(() => {
                    initializeCharts();
                    setupEventListeners();
                }, 100);
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Start the app when the page is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
